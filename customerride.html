<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZamTaxi | Book a Ride</title>
  <meta property="og:image" content="https://zamlisting.com/taxi.webp" />
  <meta property="og:image:secure_url" content="https://zamlisting.com/taxi.webp" />
  <meta property="og:image:width" content="220" />
  <meta property="og:image:height" content="120" />
  <meta property="og:url" content="https://zamlisting.com/taxi" />
  <meta property="og:title" content="ZamTaxi | Book a Ride" />
  <meta property="og:description" content="Book your taxi ride in Lusaka! Choose vehicle or motorbike, enter trip details, and submit via SMS or WhatsApp." />
  <meta property="og:type" content="website" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary-color: #2563eb;
      --secondary-color: #ff9900;
      --success-color: #1aaf5d;
      --whatsapp-color: #25d366;
      --fail-color: #dc2626;
      --bg-color-body: #f5f5f5;
      --bg-color-card: #ffffff;
      --bg-color-input: #f5f7fa;
      --border-color-light: #ccc;
      --border-color-blue: #2563eb;
      --box-shadow-light: 0 2px 5px rgba(0,0,0,0.1);
      --box-shadow-strong: 0 4px 8px rgba(0, 0, 0, 0.2);
      --font-color-dark: #333;
      --font-color-medium: #2d3a4a;
    }
    body { font-family: 'Roboto', Arial, sans-serif; background-color: var(--bg-color-body); color: var(--font-color-dark); }
    header {
      background: var(--font-color-dark); color: white; padding: 20px; text-align: left;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header-content {
      max-width: 1200px; margin: auto; display: flex; flex-wrap: wrap;
      justify-content: space-between; align-items: center; gap: 15px;
    }
    .company-info { flex: 1 1 60%; }
    .company-info h2 { font-size: 1.4rem; color: var(--secondary-color); }
    .company-info ul { list-style: none; margin-top: 8px; }
    .company-info li { margin-bottom: 5px; font-size: 0.95rem; }
    .price-tag {
      font-size: 1.3rem; font-weight: bold; background: #e67e22;
      padding: 8px 15px; border-radius: 5px; color: white;
    }
    .product-container {
      max-width: 1200px; margin: 30px auto; padding: 0 20px;
      display: flex; flex-wrap: wrap; gap: 30px;
    }
    .map-section { 
      flex: 1 1 100%; 
      min-width: 300px; 
    }
    .booking-section { 
      flex: 1 1 100%; 
      min-width: 300px; 
    }
    .map-container {
      background: white; border-radius: 8px;
      box-shadow: var(--box-shadow-light); overflow: hidden;
      height: 400px; 
      padding: 20px;
      display: none;
    }
    #google-map-frame {
      width: 100%; height: 100%; border: none; border-radius: 8px;
    }
    .map-disclaimer {
      text-align: center;
      font-size: 0.8rem;
      color: #777;
      margin-bottom: 10px;
      font-style: italic;
      display: none;
    }
    .booking-container {
      background: var(--bg-color-card); border-radius: 8px;
      box-shadow: var(--box-shadow-strong);
      padding: 20px;
    }
    .inputs-wrapper { display: flex; flex-direction: column; gap: 15px; margin: 15px 0; }
    .input-group {
      position: relative; background: var(--bg-color-input); border-radius: 5-px;
      padding: 10px 10px 10px 40px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .input-group label {
      font-weight: bold; color: var(--primary-color); font-size: 0.9rem;
      margin-bottom: 5px; display: block;
    }
    .input-group .material-icons.input-icon {
      position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
      color: var(--primary-color); font-size: 20px; opacity: 0.85;
    }
    .input-group .material-icons.validation-tick {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--success-color);
        font-size: 24px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .input-group.valid .validation-tick {
      opacity: 1;
    }
    input, select {
      width: 100%; padding: 10px; font-size: 1rem; border-radius: 5px;
      border: 1px solid var(--border-color-light); transition: border 0.2s, box-shadow 0.2s;
      background-color: transparent;
      box-sizing: border-box; /* Ensures consistent sizing */
    }
    input:focus, select:focus {
      border: 1px solid var(--border-color-blue); box-shadow: 0 0 0 2px rgba(37,99,235,0.2);
    }
    .mode-group {
      display: flex; gap: 10px; flex-wrap: wrap;
    }
    .mode-radio {
      display: flex; align-items: center; gap: 5px; font-size: 0.95rem;
      cursor: pointer;
    }
    .mode-radio input { width: auto; margin-right: 5px; }

    /* New CSS for hidden inputs and masked values */
    .input-group.valid input,
    .input-group.valid select {
      display: none;
    }
    .masked-value {
      display: none;
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid var(--border-color-light);
      background-color: var(--bg-color-card);
      color: var(--font-color-dark);
      cursor: pointer;
      min-height: 40px;
    }
    .input-group.valid .masked-value {
      display: block;
    }

    .summary-table-section {
      margin-top: 20px; padding: 15px; background: var(--bg-color-card);
      border-radius: 8px; box-shadow: var(--box-shadow-light);
    }
    .section-title {
      font-weight: bold; color: var(--primary-color); font-size: 1.1rem;
      margin-bottom: 10px; display: flex; align-items: center; gap: 5px;
    }
    #summary-table-container {
      width: 100%;
    }
    
    /* ADDED CSS FOR SCROLLING */
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table.summary-table {
      width: 100%; 
      border-collapse: collapse; 
      font-size: 0.9rem; 
      background: #f9fbfd; 
      border-radius: 6px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      white-space: nowrap; /* Prevents text from wrapping */
    }
    table.summary-table th, table.summary-table td {
      border: 1px solid #dbeafe; 
      padding: 8px; 
      text-align: left;
    }
    table.summary-table th {
      background-color: #e7f0fe; color: #222; font-weight: bold;
    }
    table.summary-table td { color: var(--font-color-medium); font-weight: 500; }
    .summary-actions-row {
      display: flex; gap: 15px; justify-content: center; margin: 10px 0; align-items: center;
      flex-wrap: wrap;
    }
    .button-wrapper {
      display: flex; align-items: center; gap: 5px;
    }
    .button-label {
      font-size: 0.95rem; color: var(--font-color-dark); font-weight: 500;
    }
    .fa {
      padding: 10px;
      font-size: 24px;
      width: 44px;
      height: 44px;
      line-height: 24px;
      text-align: center;
      text-decoration: none;
      margin: 5px;
      border-radius: 50%;
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .fa-map { background: var(--primary-color); }
    .fa-send-o { background: var(--primary-color); }
    .map-btn:hover { background: #174ea6; }
    .submit-btn:hover { background: #138244; }
    .map-btn[disabled], .submit-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .loader {
      display: none; width: 20px; height: 20px; border: 3px solid var(--primary-color);
      border-radius: 50%; border-top: 3px solid #e5e7eb;
      animation: spin 1s linear infinite; margin: 10px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .submit-status {
      display: flex; align-items: center; gap: 5px; margin-top: 10px;
      justify-content: center; font-weight: 500;
    }
    .submit-status.success { color: var(--success-color); }
    .submit-status.failed { color: var(--fail-color); }
    .material-icons { font-size: 20px; vertical-align: middle; }
    .share-options {
      display: none;
      justify-content: center;
      gap: 15px;
      margin-top: 10px;
    }

    /* New CSS for hiding/revealing values */
    .hidden-value {
      display: none;
      color: green;
      font-weight: bold;
    }
    .eye-btn {
      cursor: pointer;
      font-size: 18px;
    }

    @media (min-width: 768px) {
      .map-section {
        flex: 1 1 60%; 
      }
      .booking-section {
        flex: 1 1 35%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="company-info">
        <h2>ZamListing Booking</h2>
        <ul>
          <li><strong>Location:</strong> Luangwa, Zambia</li>
        </ul>
      </div>
      <div>
        <div class="price-tag">Book Your Ride Now!</div>
      </div>
    </div>
  </header>

  <main class="product-container">
    <section class="map-section">
      <div class="map-container" id="mapContainer">
        <div class="map-disclaimer" id="map-disclaimer">
          **This is a demo. The route may vary and is subject to revision by the taxi operator.**
        </div>
        <iframe id="google-map-frame" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>

    <section class="booking-section">
      <div class="booking-container">
        <div class="inputs-wrapper">
          <div class="input-group" id="mode-group-wrapper">
            <span class="material-icons input-icon">commute</span>
            <label for="mode-of-transport">Preferred Mode</label>
            <div class="mode-group" id="mode-group">
              <label class="mode-radio">
                <input type="radio" name="mode" value="vehicle" id="mode-vehicle">
                <span class="material-icons">directions_car</span>Vehicle
              </label>
              <label class="mode-radio">
                <input type="radio" name="mode" value="motorbike" id="mode-motorbike">
                <span class="material-icons">two_wheeler</span>Motorbike
              </label>
            </div>
          </div>
          <div class="input-group" id="extra-luggage-wrapper">
            <span class="material-icons input-icon">shopping_bag</span>
            <label for="extra-luggage-yes">Extra Person/Luggage?</label>
            <div class="mode-group" id="extra-luggage-group">
              <label class="mode-radio">
                <input type="radio" name="extraLuggage" value="yes" id="extra-luggage-yes"> Yes
              </label>
              <label class="mode-radio">
                <input type="radio" name="extraLuggage" value="no" id="extra-luggage-no" checked> No
              </label>
            </div>
          </div>
          <div class="input-group" id="customer-phone-wrapper">
            <span class="material-icons input-icon">phone</span>
            <label for="customer-phone">Phone Number</label>
            <input
              type="tel"
              id="customer-phone"
              maxlength="10"
              placeholder="0XXXXXXXXX"
              autocomplete="off"
              inputmode="numeric"
            >
            <span class="masked-value" id="masked-phone"></span>
          </div>
          <div class="input-group">
            <span class="material-icons input-icon">place</span>
            <label for="gm-origin">From</label>
            <select id="gm-origin"></select>
            <span class="masked-value" id="masked-origin"></span>
          </div>
          <div class="input-group">
            <span class="material-icons input-icon">flag</span>
            <label for="gm-destination">To</label>
            <select id="gm-destination"></select>
            <span class="masked-value" id="masked-destination"></span>
          </div>
        </div>
        <div class="summary-table-section">
          <div class="section-title">
            <span class="material-icons">table_chart</span>
            Trip Summary
          </div>
          <div id="summary-table-container"></div>
          <p style="text-align: center; font-style: italic; font-size: 0.85rem; color: #666; margin-top: 10px;">
            Review and verify all trip information.
          </p>
          <div class="summary-actions-row">
            <div class="button-wrapper">
              <a href="#" class="fa fa-send-o" id="submit-btn" title="Submit Trip Details"></a>
              <span class="button-label">Submit Trip</span>
            </div>
            <div class="button-wrapper">
              <a href="#" class="map-btn fa fa-map" id="map-btn" title="Show Map"></a>
              <span class="button-label" id="map-btn-label">Show Map (optional)</span>
            </div>
          </div>
          <div id="submit-status" class="submit-status"></div>
          <div id="loader" class="loader"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Data and Configuration
    const config = {
      // Pricing Logic
      vehiclePricePerKm: 6.0,   // Price per kilometer for a vehicle
      motorbikePricePerKm: 3.0, // Price per kilometer for a motorbike
      vehicleMinPrice: 20,    // Minimum price for a vehicle ride
      motorbikeMinPrice: 10,   // Minimum price for a motorbike ride
      avgSpeed: 60,
      googleMapsBaseUrl: 'https://www.google.com/maps/embed/v1/directions'
    };

    // CHANGE TO YOUR ACTUAL GOOGLE SCRIPT URL
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyXsFAuKlId6lbjSWzfrVoV-o8vgYxFiMiivw9v_WUv9r2ejay5prrDaSuFNSYYYEbj/exec";
    
    // START OF NEW DATA STRUCTURE FOR PLUS CODES
    // NOTE: You MUST replace the placeholder Plus Codes with the correct ones for each location.
    const placesWithPlusCodes = [
        { name: "Anglican Church", plusCode: "99HR+W3H" },
        { name: "Big 2 Zambezi Water Front Resort & Safari", plusCode: "994J+F8X, Luangwa" },
        { name: "BM residence", plusCode: "" },
        { name: "Boma Clinic", plusCode: "" },
        { name: "Chitope", plusCode: "" },
        { name: "Chilombwe Community School", plusCode: "" },
        { name: "Chiriwe Primary School", plusCode: "" },
        { name: "Dzalo Skills Training Centre kambolozo", plusCode: "" },
        { name: "Feira Kindom Hall", plusCode: "" },
        { name: "Feira Day Secondary School", plusCode: "" },
        { name: "Gerasmos Safari Lodge", plusCode: "" },
        { name: "JB THREE BOARDERS MALL", plusCode: "" },
        { name: "Justifeli Lodge", plusCode: "" },
        { name: "Kakaro Primary School", plusCode: "" },
        { name: "Kantuleni executive Lodge", plusCode: "" },
        { name: "Kapoche", plusCode: "" },
        { name: "Kasinsa", plusCode: "" },
        { name: "Katondwe Mission Hospital", plusCode: "" },
        { name: "Kavalamanja", plusCode: "" },
        { name: "Luangwa (Feira)", plusCode: "99HR+W3H" },
        { name: "Luangwa Basic School", plusCode: "" },
        { name: "Luangwa Bridge", plusCode: "" },
        { name: "Luangwa Bridge Market", plusCode: "" },
        { name: "Luangwa Council lodge", plusCode: "" },
        { name: "Luangwa District Comission office", plusCode: "" },
        { name: "Luangwa District Education Board Offices", plusCode: "" },
        { name: "Luangwa District Hospital", plusCode: "" },
        { name: "Luangwa Filling Station", plusCode: "" },
        { name: "Luangwa Habour", plusCode: "" },
        { name: "Luangwa Indeco", plusCode: "" },
        { name: "Luangwa Market", plusCode: "" },
        { name: "Luangwa main sda churh", plusCode: "" },
        { name: "Luangwa Police Station", plusCode: "" },
        { name: "Luangwa Post Office", plusCode: "" },
        { name: "Luangwa Secondary School", plusCode: "" },
        { name: "Makichilo Lodge", plusCode: "" },
        { name: "Mwavi Secondary School", plusCode: "" },
        { name: "Mwalila Primary School", plusCode: "" },
        { name: "Pentocostal Assembly of God Joshua Assembly", plusCode: "" },
        { name: "UCZ", plusCode: "" },
        { name: "Yangoma Hotel", plusCode: "" },
        { name: "yellow shop", plusCode: "" },
        { name: "Zambia Electricity Supply Corporation", plusCode: "" }
    ];
    // END OF NEW DATA STRUCTURE

    const segments = [
      { from: "Anglican Church", to: "Feira Kindom Hall", distance: 0.1 },
      { from: "Anglican Church", to: "Feira Day Secondary School", distance: 3.5 },
      { from: "Anglican Church", to: "Katondwe Mission Hospital", distance: 51 },
      { from: "Anglican Church", to: "Luangwa (Feira)", distance: 0.75 },
      { from: "Big 2 Zambezi Water Front Resort & Safari", to: "Feira Day Secondary School", distance: 4.0 },
      { from: "BM residence", to: "Boma Clinic", distance: 0.6 },
      { from: "BM residence", to: "Feira Day Secondary School", distance: 1.1 },
      { from: "Boma Clinic", to: "Dzalo Skills Training Centre kambolozo", distance: 0.2 },
      { from: "Chilombwe Community School", to: "Feira Day Secondary School", distance: 14 },
      { from: "Chiriwe Primary School", to: "JB THREE BOARDERS MALL", distance: 46.8 },
      { from: "Chitope", to: "Kasinsa", distance: 10 },
      { from: "Chitope", to: "Luangwa Bridge", distance: 32 },
      { from: "Chitope", to: "Luangwa Bridge Market", distance: 29 },
      { from: "Chitope", to: "Luangwa Secondary School", distance: 14 },
      { from: "Dzalo Skills Training Centre kambolozo", to: "Luangwa Filling Station", distance: 0.3 },
      { from: "Feira Kindom Hall", to: "Luangwa (Feira)", distance: 0.7 },
      { from: "Feira Day Secondary School", to: "Gerasmos Safari Lodge", distance: 3.1 },
      { from: "Feira Day Secondary School", to: "Justifeli Lodge", distance: 2.2 },
      { from: "Feira Day Secondary School", to: "Katondwe Mission Hospital", distance: 48 },
      { from: "Feira Day Secondary School", to: "Luangwa Secondary School", distance: 4.5 },
      { from: "Feira Day Secondary School", to: "Mwalila Primary School", distance: 68 },
      { from: "Feira Day Secondary School", to: "yellow shop", distance: 3.3 },
      { from: "Feira Day Secondary School", to: "Zambia Electricity Supply Corporation", distance: 2.0 },
      { from: "Gerasmos Safari Lodge", to: "Justifeli Lodge", distance: 2.0 },
      { from: "Gerasmos Safari Lodge", to: "Luangwa Secondary School", distance: 1.0 },
      { from: "JB THREE BOARDERS MALL", to: "yellow shop", distance: 0.45 },
      { from: "Justifeli Lodge", to: "Luangwa main sda churh", distance: 0.9 },
      { from: "Justifeli Lodge", to: "Luangwa District Education Board Offices", distance: 2.0 },
      { from: "Kakaro Primary School", to: "Luangwa (Feira)", distance: 12 },
      { from: "Kantuleni executive Lodge", to: "Luangwa Filling Station", distance: 0.190 },
      { from: "Kapoche", to: "Luangwa (Feira)", distance: 28 },
      { from: "Kasinsa", to: "Katondwe Mission Hospital", distance: 16 },
      { from: "Katondwe Mission Hospital", to: "Luangwa (Feira)", distance: 52 },
      { from: "Katondwe Mission Hospital", to: "Mwavi Secondary School", distance: 7.2 },
      { from: "Kavalamanja", to: "Luangwa District Hospital", distance: 23 },
      { from: "Luangwa (Feira)", to: "Luangwa Basic School", distance: 0.7 },
      { from: "Luangwa (Feira)", to: "Luangwa Council lodge", distance: 1.15 },
      { from: "Luangwa (Feira)", to: "Luangwa District Hospital", distance: 4.6 },
      { from: "Luangwa (Feira)", to: "Luangwa Filling Station", distance: 1.8 },
      { from: "Luangwa (Feira)", to: "Luangwa Habour", distance: 0.9 },
      { from: "Luangwa (Feira)", to: "Luangwa Indeco", distance: 0.9 },
      { from: "Luangwa (Feira)", to: "Luangwa Market", distance: 0.1 },
      { from: "Luangwa (Feira)", to: "Luangwa Police Station", distance: 0.55 },
      { from: "Luangwa (Feira)", to: "Luangwa Post Office", distance: 1.65 },
      { from: "Luangwa (Feira)", to: "Makichilo Lodge", distance: 0.40 },
      { from: "Luangwa (Feira)", to: "Pentocostal Assembly of God Joshua Assembly", distance: 0.6 },
      { from: "Luangwa (Feira)", to: "UCZ", distance: 0.5 },
      { from: "Luangwa Basic School", to: "Luangwa Market", distance: 0.45 },
      { from: "Luangwa Bridge", to: "Luangwa Bridge Market", distance: 12.7 },
      { from: "Luangwa Council lodge", to: "Yangoma Hotel", distance: 0.15 },
      { from: "Luangwa Council lodge", to: "Zambia Electricity Supply Corporation", distance: 2.4 },
      { from: "Luangwa District Hospital", to: "Zambia Electricity Supply Corporation", distance: 2.8 },
      { from: "Luangwa Filling Station", to: "Yangoma Hotel", distance: 0.7 },
      { from: "Luangwa Habour", to: "Luangwa Market", distance: 0.5 },
      { from: "Luangwa Indeco", to: "Luangwa Council lodge", distance: 0.25 },
      { from: "Luangwa Indeco", to: "yellow shop", distance: 0.45 },
      { from: "Luangwa main sda churh", to: "Justifeli Lodge", distance: 0.9 },
      { from: "Luangwa main sda churh", to: "Zambia Electricity Supply Corporation", distance: 0.65 },
      { from: "Luangwa Police Station", to: "Luangwa Post Office", distance: 1.1 },
      { from: "Luangwa Post Office", to: "Luangwa District Comission office", distance: 0 },
      { from: "Mwavi Secondary School", to: "Chitope", distance: 1.1 }
    ];

    // DOM Elements
    const originSelect = document.getElementById('gm-origin');
    const destinationSelect = document.getElementById('gm-destination');
    const customerPhoneInput = document.getElementById('customer-phone');
    const modeGroup = document.getElementById('mode-group');
    const mapBtn = document.getElementById('map-btn');
    const mapBtnLabel = document.getElementById('map-btn-label');
    const mapContainer = document.getElementById('mapContainer');
    const mapDisclaimer = document.getElementById('map-disclaimer');
    const summaryTableContainer = document.getElementById('summary-table-container');
    const submitBtn = document.getElementById('submit-btn');
    const submitStatusDiv = document.getElementById('submit-status');
    const loader = document.getElementById('loader');
    
    // New masked value elements
    const maskedPhone = document.getElementById('masked-phone');
    const maskedOrigin = document.getElementById('masked-origin');
    const maskedDestination = document.getElementById('masked-destination');
    
    let summaryData = null;

    // Populate dropdowns on page load
    function populateDropdowns() {
      const defaultOptionOrigin = document.createElement('option');
      defaultOptionOrigin.value = "";
      defaultOptionOrigin.textContent = "Select...";
      defaultOptionOrigin.disabled = true;
      defaultOptionOrigin.selected = true;
      originSelect.appendChild(defaultOptionOrigin);

      const defaultOptionDestination = document.createElement('option');
      defaultOptionDestination.value = "";
      defaultOptionDestination.textContent = "Select...";
      defaultOptionDestination.disabled = true;
      defaultOptionDestination.selected = true;
      destinationSelect.appendChild(defaultOptionDestination);

      const sortedPlaces = placesWithPlusCodes.slice().sort((a, b) => a.name.localeCompare(b.name));
      sortedPlaces.forEach(place => {
        const option1 = document.createElement('option');
        option1.value = place.name;
        option1.textContent = place.name;
        option1.dataset.plusCode = place.plusCode; // Add plus code as a data attribute
        originSelect.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = place.name;
        option2.textContent = place.name;
        option2.dataset.plusCode = place.plusCode;
        destinationSelect.appendChild(option2);
      });
    }

    // Graph Functions (Dijkstra-like algorithm)
    function buildGraph(segments) {
      const graph = {};
      segments.forEach(seg => {
        if (!graph[seg.from]) graph[seg.from] = [];
        if (!graph[seg.to]) graph[seg.to] = [];
        graph[seg.from].push({ place: seg.to, distance: seg.distance });
        graph[seg.to].push({ place: seg.from, distance: seg.distance });
      });
      return graph;
    }

    function findShortestDistance(from, to, segments) {
      const graph = buildGraph(segments);
      if (!graph[from] || !graph[to]) return null;
      const distances = {};
      const visited = new Set();
      placesWithPlusCodes.forEach(place => distances[place.name] = Infinity);
      distances[from] = 0;
      let queue = [{ place: from, dist: 0 }];
      while (queue.length > 0) {
        queue.sort((a, b) => a.dist - b.dist);
        const { place, dist } = queue.shift();
        if (place === to) return dist;
        if (visited.has(place)) continue;
        visited.add(place);
        for (let neighbor of (graph[place] || [])) {
          if (dist + neighbor.distance < distances[neighbor.place]) {
            distances[neighbor.place] = dist + neighbor.distance;
            queue.push({ place: neighbor.place, dist: distances[neighbor.place] });
          }
        }
      }
      return null;
    }

    // Function to update validation tick status
    function updateValidationStatus(element, isValid) {
        const parentGroup = element.closest('.input-group');
        if (isValid) {
            parentGroup.classList.add('valid');
        } else {
            parentGroup.classList.remove('valid');
        }
    }

    // New function to hide input values and display masked ones
    function maskInputValues(origin, destination, phone) {
      // Mask phone number
      const isPhoneValid = phone.match(/^0[0-9]{9}$/);
      if (isPhoneValid) {
        maskedPhone.textContent = '**********';
        updateValidationStatus(customerPhoneInput, true);
      } else {
        maskedPhone.textContent = '';
        updateValidationStatus(customerPhoneInput, false);
      }

      // Mask origin
      const isOriginValid = origin && origin !== '';
      if (isOriginValid) {
        maskedOrigin.textContent = '**********';
        updateValidationStatus(originSelect, true);
      } else {
        maskedOrigin.textContent = '';
        updateValidationStatus(originSelect, false);
      }

      // Mask destination
      const isDestinationValid = destination && destination !== '';
      if (isDestinationValid) {
        maskedDestination.textContent = '**********';
        updateValidationStatus(destinationSelect, true);
      } else {
        maskedDestination.textContent = '';
        updateValidationStatus(destinationSelect, false);
      }
    }

    // Function to reset the form and allow editing
    function resetValidation(event) {
      const parentGroup = event.target.closest('.input-group');
      parentGroup.classList.remove('valid');
      summaryTableContainer.innerHTML = '';
      submitBtn.classList.add('disabled');
      submitBtn.setAttribute('disabled', 'true');
      summaryData = null;
      displayStatus('Edit your details and click enter to re-calculate.', 'failed');
    }
    
    // Function to reveal the hidden values
    function reveal(eye) {
      // Hide all values and show all eyes again
      document.querySelectorAll(".hidden-value").forEach(v => v.style.display = "none");
      document.querySelectorAll(".eye-btn").forEach(e => e.style.display = "inline");

      // Show only the clicked one
      let value = eye.previousElementSibling;
      value.style.display = "inline";
      eye.style.display = "none";
    }

    // Event Handlers
    function updateSummaryTable() {
      // Capture the current values before any hiding happens
      const origin = originSelect.value;
      const destination = destinationSelect.value;
      const customerPhone = customerPhoneInput.value.trim();
      const vehicleRadio = document.getElementById('mode-vehicle');
      const motorbikeRadio = document.getElementById('mode-motorbike');
      const extraLuggageRadio = document.querySelector('input[name="extraLuggage"]:checked');
      const hasExtraLuggage = extraLuggageRadio.value === 'yes';
      
      summaryTableContainer.innerHTML = '';
      submitBtn.classList.add('disabled');
      submitBtn.setAttribute('disabled', 'true');
      summaryData = null;
      
      // Check for valid inputs
      const isOriginValid = origin && origin !== '';
      const isDestinationValid = destination && destination !== '';
      const isPhoneValid = customerPhone.match(/^0[0-9]{9}$/);
      const isModeSelected = vehicleRadio.checked || motorbikeRadio.checked;

      // Update validation ticks and masked values
      maskInputValues(origin, destination, customerPhone);

      if (!isOriginValid || !isDestinationValid || !isPhoneValid || !isModeSelected) {
          displayStatus('Please fill in all details correctly.', 'failed');
          return;
      }

      // If all inputs are valid, proceed with calculation
      const mode = vehicleRadio.checked ? 'Vehicle' : 'Motorbike';
      
      const distance = findShortestDistance(origin, destination, segments);
      if (distance === null || isNaN(distance)) {
        displayStatus('A route could not be found between the selected places.', 'failed');
        return;
      }

      const timeHours = distance / config.avgSpeed;
      const wholeHours = Math.floor(timeHours);
      const minutes = Math.round((timeHours - wholeHours) * 60);

      // --- START OF PRICING LOGIC ---
      let price = 0;
      if (mode === 'Vehicle') {
        // Calculate price based on distance
        price = distance * config.vehiclePricePerKm;
        // Ensure price is at least the minimum
        price = Math.max(price, config.vehicleMinPrice);
      } else { // Motorbike
        // Calculate price based on distance
        price = distance * config.motorbikePricePerKm;
        // Ensure price is at least the minimum
        price = Math.max(price, config.motorbikeMinPrice);
      }

      // Add 25% to the price if extra luggage is selected
      if (hasExtraLuggage) {
        price = price * 1.25;
      }
      
      // Round the final price to the nearest whole number
      price = Math.round(price);
      // --- END OF PRICING LOGIC ---
      
      let timeText = '';
      if (wholeHours > 0) {
        timeText += `${wholeHours} hr`;
        if (minutes > 0) timeText += ` ${minutes} min`;
      } else {
        timeText += `${minutes} min`;
      }
      
      // Update UI with summary data
      const tableHTML = `
        <div class="table-responsive">
          <table class="summary-table">
            <thead>
              <tr>
                <th>Mode</th>
                <th>Extra Luggage</th>
                <th>Phone</th>
                <th>From</th>
                <th>To</th>
                <th>Distance (km)</th>
                <th>Time</th>
                <th>Price (K)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <span class="hidden-value">${mode}</span>
                  <span class="eye-btn" onclick="reveal(this)">üëÅÔ∏è</span>
                </td>
                <td>
                  <span class="hidden-value">${hasExtraLuggage ? 'Yes' : 'No'}</span>
                  <span class="eye-btn" onclick="reveal(this)">üëÅÔ∏è</span>
                </td>
                <td>
                  <span class="hidden-value">${customerPhone}</span>
                  <span class="eye-btn" onclick="reveal(this)">üëÅÔ∏è</span>
                </td>
                <td>
                  <span class="hidden-value">${origin}</span>
                  <span class="eye-btn" onclick="reveal(this)">üëÅÔ∏è</span>
                </td>
                <td>
                  <span class="hidden-value">${destination}</span>
                  <span class="eye-btn" onclick="reveal(this)">üëÅÔ∏è</span>
                </td>
                <td>
                  <span class="hidden-value">${distance.toFixed(2)}</span>
                  <span class="eye-btn" onclick="reveal(this)">üëÅÔ∏è</span>
                </td>
                <td>
                  <span class="hidden-value">${timeText}</span>
                  <span class="eye-btn" onclick="reveal(this)">üëÅÔ∏è</span>
                </td>
                <td>
                  <span class="hidden-value"><b>K${price}</b></span>
                  <span class="eye-btn" onclick="reveal(this)">üëÅÔ∏è</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
      summaryTableContainer.innerHTML = tableHTML;
      
      // Store summary data
      summaryData = {
        preferredMode: mode,
        extraLuggage: hasExtraLuggage ? 'Yes' : 'No',
        phone: customerPhone,
        from: origin,
        to: destination,
        distance: distance.toFixed(2),
        estimatedTime: timeText,
        price: price
      };
      
      displayStatus('Trip details calculated. Click submit to send your request.', 'success');
      submitBtn.classList.remove('disabled');
      submitBtn.removeAttribute('disabled');
    }

    function toggleMap() {
      const frame = document.getElementById('google-map-frame');

      // Get the selected options
      const originOption = originSelect.options[originSelect.selectedIndex];
      const destinationOption = destinationSelect.options[destinationSelect.selectedIndex];
      
      // Get the plus codes from the data attributes
      const originPlusCode = originOption.dataset.plusCode;
      const destinationPlusCode = destinationOption.dataset.plusCode;

      if (!originPlusCode || !destinationPlusCode) {
          alert('Plus Codes for one or both locations are missing. Please update your data list.');
          return;
      }
      
      // Construct the Google Maps URL without an API key
      const mapUrl = `https://www.google.com/maps/embed/v1/directions?key=YOUR_API_KEY&origin=$8? q=${encodeURIComponent(originPlusCode)} to ${encodeURIComponent(destinationPlusCode)}`;

      if (mapContainer.style.display === 'none') {
        frame.src = mapUrl;
        mapContainer.style.display = 'block';
        mapDisclaimer.style.display = 'block';
        mapBtnLabel.textContent = 'Hide Map (optional)';
        mapBtn.title = 'Hide Map';
        mapContainer.scrollIntoView({ behavior: 'smooth' });
      } else {
        mapContainer.style.display = 'none';
        mapDisclaimer.style.display = 'none';
        mapBtnLabel.textContent = 'Show Map (optional)';
        mapBtn.title = 'Show Map';
      }
    }

    function submitToGoogleSheet() {
      if (!summaryData) {
        displayStatus('No data to submit.', 'failed');
        return;
      }
      
      const timestamp = new Date().toLocaleString("en-US", { timeZone: "Africa/Lusaka" });

      const payload = {
          "preferredMode": summaryData.preferredMode,
          "extraLuggage": summaryData.extraLuggage,
          "phone": summaryData.phone,
          "from": summaryData.from,
          "to": summaryData.to,
          "distance": summaryData.distance,
          "estimatedTime": summaryData.estimatedTime,
          "price": summaryData.price,
          "timestamp": timestamp
      };
      
      displayStatus('Submitting...', 'info');
      loader.style.display = 'block';
      submitBtn.setAttribute('disabled', 'true');
      
      fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: {
          'Content-Type': 'text/plain;charset=utf-8',
        },
      })
      .then(response => response.json())
      .then(data => {
        loader.style.display = 'none';
        if (data.result === 'success') {
          displayStatus('Booking request sent successfully! You will be contacted shortly.', 'success');
        } else {
          displayStatus(`Failed to submit: ${data.error || 'Unknown error.'}`, 'failed');
          submitBtn.removeAttribute('disabled');
        }
      })
      .catch(error => {
        loader.style.display = 'none';
        displayStatus(`Network error: ${error}`, 'failed');
        submitBtn.removeAttribute('disabled');
      });
    }

    function displayStatus(message, type) {
      submitStatusDiv.innerHTML = `<span class="material-icons">${type === 'success' ? 'check_circle' : type === 'failed' ? 'error' : 'info'}</span> ${message}`;
      submitStatusDiv.className = `submit-status ${type}`;
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      populateDropdowns();
    });

    originSelect.addEventListener('change', updateSummaryTable);
    destinationSelect.addEventListener('change', updateSummaryTable);
    customerPhoneInput.addEventListener('input', updateSummaryTable);
    modeGroup.addEventListener('change', updateSummaryTable);
    document.getElementById('extra-luggage-group').addEventListener('change', updateSummaryTable);

    maskedPhone.addEventListener('click', resetValidation);
    maskedOrigin.addEventListener('click', resetValidation);
    maskedDestination.addEventListener('click', resetValidation);

    submitBtn.addEventListener('click', (e) => {
      e.preventDefault();
      submitToGoogleSheet();
    });

    mapBtn.addEventListener('click', (e) => {
      e.preventDefault();
      toggleMap();
    });
  </script>
</body>
</html>
