<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luangwa Delivery Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2e7d32;
      --primary-dark: #1b5e20;
      --primary-light: #81c784;
      --accent: #ff9800;
      --text: #333;
      --text-light: #666;
      --background: #f5f5f5;
      --card-bg: white;
      --border: #e0e0e0;
      --shadow: 0 0 8px rgba(0,0,0,0.5);
      --success: #e8f5e9;
      --error: #ffebee;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; color: var(--text); background-color: var(--background); line-height: 1.5; }
    header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 1.5rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    header h1 { font-weight: normal; font-size: 1.8rem; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; display: flex; flex-wrap: wrap; gap: 2rem; }
    .slider-wrapper { position: relative; flex: 2; min-width: 300px; background: var(--card-bg); border-radius: 10px; padding: 1.5rem; box-shadow: var(--shadow); }
    .section-title { font-size: 1.3rem; margin-bottom: 1rem; color: var(--primary-dark); display: flex; align-items: center; gap: 0.5rem; }
    .section-title i { color: var(--primary); }
    .thumbnail-slider { display: flex; overflow-x: auto; scroll-behavior: smooth; gap: 1.5rem; padding: 1rem 0; margin: 0 -0.5rem; }
    .thumbnail-slider::-webkit-scrollbar { height: 6px; }
    .thumbnail-slider::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .thumbnail-slider::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 10px; }
    .product { flex: 0 0 160px; border: 1px solid var(--border); border-radius: 10px; padding: 1rem; text-align: center; background: var(--card-bg); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
    .product:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .product img { width: 100px; height: 100px; object-fit: cover; margin-bottom: 0.8rem; border-radius: 4px; }
    .product h4 { font-size: 1rem; margin-bottom: 0.5rem; color: var(--text); }
    .product p { color: var(--primary-dark); font-weight: 600; margin-bottom: 0.8rem; }
    .product button { border: none; background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-family: inherit; font-weight: 500; transition: background 0.2s; }
    .product button:hover { background: var(--primary-dark); }
    .slider-button { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: background-color 0.2s; }
    .slider-button:hover { background: rgba(0,0,0,0.8); }
    .slider-button.prev { left: 0; }
    .slider-button.next { right: 0; }
    .cart { border: 1px solid var(--border); padding: 1.5rem; border-radius: 10px; flex: 1; min-width: 300px; background: var(--card-bg); position: sticky; top: 1rem; box-shadow: var(--shadow); }
    .cart-items { list-style: none; padding: 0; margin: 0 0 1.5rem; max-height: 300px; overflow-y: auto; }
    .cart-items li { padding: 0.8rem 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .cart-items li:last-child { border-bottom: none; }
    .cart-total { margin: 1rem 0; padding-top: 1rem; border-top: 1px solid var(--border); color: var(--text-dark); }
    .cart-total p { margin: 0.5rem 0; }
    .address-input, .phone-input { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 5px; font-family: inherit; font-size: 0.9rem; transition: border-color 0.2s; }
    .address-input:focus, .phone-input:focus { outline: none; border-color: var(--primary); }
    .btn { border: none; background: var(--primary); color: white; padding: 0.8rem 1.2rem; border-radius: 4px; cursor: pointer; font-family: inherit; font-weight: 500; width: 100%; transition: background 0.2s, opacity 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .btn:hover { background: var(--primary-dark); }
    .btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.6; }
    .btn-accent { background: var(--accent); }
    .btn-accent:hover { background: #e68a00; }
    .btn-secondary { background: var(--primary-light); margin-top: 0.5rem; }
    .btn-secondary:hover { background: var(--primary); }
    .btn-success { background: var(--primary-dark); }
    .map-toggle-btn { background: var(--primary-light); margin: 1rem auto; display: block; }
    .map-toggle-btn:hover { background: var(--primary); }
    #eta { margin-top: 1rem; padding: 0.75rem; background: var(--success); border-radius: 4px; color: var(--primary-dark); font-weight: 500; }
    #map { width: 100%; height: 400px; margin: 2rem 0; border-radius: 10px; box-shadow: var(--shadow); display: none; }
    .empty-cart { text-align: center; color: var(--text-muted); padding: 2rem 0; }
    .empty-cart i { font-size: 2rem; margin-bottom: 1rem; color: var(--primary-light); }
    .remove-btn { background-color: transparent; border: none; color: #ff5252; cursor: pointer; padding: 0.25rem; transition: color 0.2s; }
    .quantity-controls { display: flex; align-items: center; gap: 0.5rem; }
    .quantity-btn { background: var(--primary-light); border: none; color: white; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
    .quantity-btn:hover { background: var(--primary); }
    #checkout-status { margin-top: 1rem; padding: 0.75rem; border-radius: 4px; font-weight: 500; text-align: center; display: none; }
    #checkout-status.success { background: var(--success); color: var(--primary-dark); }
    #checkout-status.error { background: var(--error); color: #c62828; }
    #loader {
      display: none;
      margin: 1rem auto;
      text-align: center;
    }
    .status-message {
      display: none;
      margin: 1rem 0;
      padding: 0.75rem;
      border-radius: 4px;
      text-align: center;
      font-weight: 500;
    }
    .status-message.success { background: var(--success); color: var(--primary-dark); }
    .status-message.error { background: var(--error); color: #c62828; }
    #searchBox {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1rem;
      box-sizing: border-box;
    }
    /* Instructions toggle and box styles */
    .instructions-toggle-btn {
      background: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 600;
      border: 1px solid var(--primary);
      border-radius: 6px;
      padding: 0.6rem 1.2rem;
      margin: 1.2rem auto 0.5rem auto;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 7px;
      transition: background 0.15s;
      font-size: 1.01em;
      box-shadow: 0 2px 8px rgba(44,125,50,0.03);
    }
    .instructions-toggle-btn:hover {
      background: var(--primary);
      color: white;
    }
    .instructions-box {
      background: #f9fff7;
      border: 1px solid var(--primary-light);
      border-radius: 8px;
      padding: 1.2em 1.4em 1.2em 2.2em;
      max-width: 700px;
      margin: 0 auto 1.5em auto;
      font-size: 1em;
      box-shadow: 0 1px 6px rgba(44,125,50,0.07);
      color: var(--primary-dark);
      display: none;
      line-height: 1.66em;
    }
    .instructions-box ul { margin-left: 1.1em; }
    .instructions-box li { margin-bottom: 0.6em; }
    @media (max-width: 767px) {
      .container { flex-direction: column; }
      .slider-wrapper, .cart { width: 100%; }
      .slider-button { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-truck"></i> Luangwa Delivery Platform</h1>
  </header>

  <!-- Instructions toggle button and box -->
  <button id="instructions-toggle-btn" class="instructions-toggle-btn">
    <span id="instructions-toggle-icon">‚ûï</span> Instructions & Tips
  </button>
  <div id="instructions-box" class="instructions-box">
    <ul>
      <li>üîç <b>You can search for products</b> using the search box above the products list.</li>
      <li>üõí <b>Add products</b> to your order using the <b>Add</b> buttons.</li>
      <li>üì¶ <b>Set your delivery destination</b> by searching, or <b>double-clicking</b> (desktop) or <b>tapping once</b> (mobile) on the toggled map.</li>
      <li>üó∫ <b>Use the "Toggle Map" button</b> to show/hide the delivery map interface.</li>
      <li>üìç <b>Pickup location</b> is set as the default Luangwa pickup point.</li>
      <li>üì± <b>Enter your phone number</b> before checking out.</li>
      <li>üöö <b>Estimate delivery</b> to get ETA and cost before proceeding to checkout.</li>
      <li>üí≥ <b>Proceed to checkout</b> to confirm your order and submit details.</li>
    </ul>
  </div>

  <div class="container">
    <div class="slider-wrapper">
      <h2 class="section-title"><i class="fas fa-store"></i> Available Products</h2>
      <input type="text" id="searchBox" placeholder="Search products...">
      <button class="slider-button prev" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
      <div id="product-list" class="thumbnail-slider"></div>
      <button class="slider-button next" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
    </div>
    <div class="cart">
      <h2 class="section-title"><i class="fas fa-shopping-cart"></i> Your Order</h2>
      <ul id="cart-items" class="cart-items"></ul>
      <div id="empty-cart" class="empty-cart">
        <i class="fas fa-cart-arrow-down"></i>
        <p>Your cart is empty.</p>
        <p>Add items to get started.</p>
      </div>
      <div id="cart-total" class="cart-total" style="display:none;">
        <p>Products Total: ZK <span id="products-total">0.00</span></p>
        <p id="transportation-line" style="display:none;">Transportation: ZK <span id="transportation-cost">0.00</span></p>
        <p><strong>Total: ZK <span id="grand-total">0.00</span></strong></p>
      </div>
      <label for="end">Search for your Destination below or let the current fetched location</label>
      <input id="end" class="address-input" type="text" placeholder="Enter delivery address" />
      <div id="location-message" style="color: red; margin-top: 0.5rem;"></div>
      <label for="phone">Enter phone number:</label>
      <input id="phone" type="tel" class="phone-input" placeholder="0978167546" pattern="0[0-9]{9}" maxlength="10" />
      <button id="calc-time" class="btn btn-primary" disabled>
        <i class="fas fa-clock"></i> Estimate Delivery
      </button>
      <div id="eta"></div>
      <button id="checkout-btn" class="btn btn-accent" style="margin-top: 1rem; display:none;">
        <i class="fas fa-credit-card"></i> Proceed to Checkout
      </button>
      <div id="checkout-status" class="status-message"></div>
      <div id="loader"><i class="fas fa-spinner fa-spin"></i> Processing...</div>
      <div id="statusMessage" class="status-message"></div>
    </div>
  </div>
  <button id="toggle-map-btn" class="btn map-toggle-btn">Toggle Map</button>
  <div id="map"></div>
  <script>
    // --- INSTRUCTIONS TOGGLE LOGIC ---
    const instructionsBtn = document.getElementById("instructions-toggle-btn");
    const instructionsBox = document.getElementById("instructions-box");
    const instructionsIcon = document.getElementById("instructions-toggle-icon");
    instructionsBtn.addEventListener("click", function () {
      if (instructionsBox.style.display === "block") {
        instructionsBox.style.display = "none";
        instructionsIcon.textContent = "‚ûï";
      } else {
        instructionsBox.style.display = "block";
        instructionsIcon.textContent = "‚ûñ";
      }
    });

    // --- PRODUCTS: 100 commodities, rest of logic untouched ---
    const PRODUCTS = [
      { id: 1, name: "Mosi Beer", price: 25, image: "M.jpeg", category: "beverages" },
      { id: 2, name: "Castle Lager", price: 24, image: "CC.jpeg", category: "beverages" },
      { id: 3, name: "Castle Light Dumpy", price: 25, image: "CLD.jpeg", category: "beverages" },
      { id: 4, name: "Black Label", price: 28, image: "BL.webp", category: "beverages" },
      { id: 5, name: "Coca-Cola bottled", price: 12, image: "MC.jpg", category: "beverages" },
      { id: 6, name: "Fanta", price: 12, image: "F.jpeg", category: "beverages" },
      { id: 7, name: "Disposable Fanta", price: 15, image: "DD.jpg", category: "beverages" },
      { id: 8, name: "Disposable Coke", price: 15, image: "DD.jpg", category: "beverages" },
      { id: 9, name: "Disposable Sprite", price: 15, image: "DD.jpg", category: "beverages" },
      { id: 10, name: "Sugar 1kg", price: 32, image: "sugar.jpg", category: "staples" },
      { id: 11, name: "Salt 500g", price: 6, image: "salt.jpg", category: "staples" },
      { id: 12, name: "Cooking Oil 2L", price: 64, image: "oil.jpg", category: "staples" },
      { id: 13, name: "Maize Meal 10kg", price: 110, image: "maize.jpg", category: "staples" },
      { id: 14, name: "Bread", price: 22, image: "bread.jpg", category: "staples" },
      { id: 15, name: "Milk 500ml", price: 14, image: "milk.jpg", category: "dairy" },
      { id: 16, name: "Eggs (tray)", price: 60, image: "eggs.jpg", category: "dairy" },
      { id: 17, name: "Butter 250g", price: 30, image: "butter.jpg", category: "dairy" },
      { id: 18, name: "Toothpaste", price: 18, image: "toothpaste.jpg", category: "personal care" },
      { id: 19, name: "Bath Soap", price: 12, image: "soap.jpg", category: "personal care" },
      { id: 20, name: "Washing Powder 500g", price: 26, image: "washing_powder.jpg", category: "household" },
      { id: 21, name: "Tissues (4 Pack)", price: 24, image: "tissue.jpg", category: "household" },
      { id: 22, name: "Sunlight Dish Soap", price: 16, image: "dish_soap.jpg", category: "household" },
      { id: 23, name: "Rice 2kg", price: 48, image: "rice.jpg", category: "staples" },
      { id: 24, name: "Beans 1kg", price: 34, image: "beans.jpg", category: "staples" },
      { id: 25, name: "Chicken 1kg", price: 70, image: "chicken.jpg", category: "meat" },
      { id: 26, name: "Beef 1kg", price: 85, image: "beef.jpg", category: "meat" },
      { id: 27, name: "Fish 1kg", price: 75, image: "fish.jpg", category: "meat" },
      { id: 28, name: "Onions 1kg", price: 20, image: "onions.jpg", category: "vegetables" },
      { id: 29, name: "Tomatoes 1kg", price: 18, image: "tomatoes.jpg", category: "vegetables" },
      { id: 30, name: "Potatoes 2kg", price: 26, image: "potatoes.jpg", category: "vegetables" },
      { id: 31, name: "Cabbage", price: 16, image: "cabbage.jpg", category: "vegetables" },
      { id: 32, name: "Carrots 1kg", price: 19, image: "carrots.jpg", category: "vegetables" },
      { id: 33, name: "Apples (6 pack)", price: 32, image: "apples.jpg", category: "fruits" },
      { id: 34, name: "Bananas 1kg", price: 20, image: "bananas.jpg", category: "fruits" },
      { id: 35, name: "Oranges 1kg", price: 28, image: "oranges.jpg", category: "fruits" },
      { id: 36, name: "Mangoes 1kg", price: 15, image: "mangoes.jpg", category: "fruits" },
      { id: 37, name: "Peanut Butter 375g", price: 25, image: "peanut_butter.jpg", category: "staples" },
      { id: 38, name: "Jam 350g", price: 18, image: "jam.jpg", category: "staples" },
      { id: 39, name: "Honest Tea 500ml", price: 10, image: "tea.jpg", category: "beverages" },
      { id: 40, name: "Coffee 250g", price: 35, image: "coffee.jpg", category: "beverages" },
      { id: 41, name: "Biscuits 200g", price: 14, image: "biscuits.jpg", category: "snacks" },
      { id: 42, name: "Cornflakes 500g", price: 34, image: "cornflakes.jpg", category: "cereal" },
      { id: 43, name: "Weetbix 450g", price: 28, image: "weetbix.jpg", category: "cereal" },
      { id: 44, name: "Yoghurt 175g", price: 9, image: "yoghurt.jpg", category: "dairy" },
      { id: 45, name: "Margarine 500g", price: 30, image: "margarine.jpg", category: "dairy" },
      { id: 46, name: "Mayonnaise 400g", price: 28, image: "mayonnaise.jpg", category: "condiments" },
      { id: 47, name: "Ketchup 400g", price: 15, image: "ketchup.jpg", category: "condiments" },
      { id: 48, name: "Bath Towel", price: 45, image: "towel.jpg", category: "household" },
      { id: 49, name: "Laundry Bar", price: 8, image: "laundry_bar.jpg", category: "household" },
      { id: 50, name: "Candles (6 pack)", price: 16, image: "candles.jpg", category: "household" },
      // Fill up to 100 with generic placeholder commodities:
      ...Array.from({length: 50}, (_, i) => ({
        id: 51 + i,
        name: `Commodity ${51 + i}`,
        price: 10 + ((51 + i) % 30) * 2,
        image: "https://via.placeholder.com/100?text=Item",
        category: ["beverages","staples","dairy","personal care","household","meat","cereal","condiments","fruits","vegetables","snacks"][i % 11]
      }))
    ];

    // --- REST OF YOUR SCRIPT UNCHANGED ---
    const productListEl = document.getElementById('product-list');
    const cartItemsEl = document.getElementById('cart-items');
    const emptyCartEl = document.getElementById('empty-cart');
    const cartTotalEl = document.getElementById('cart-total');
    const productsTotalEl = document.getElementById('products-total');
    const transportationCostEl = document.getElementById('transportation-cost');
    const grandTotalEl = document.getElementById('grand-total');
    const transportationLineEl = document.getElementById('transportation-line');
    const endEl = document.getElementById('end');
    const phoneEl = document.getElementById('phone');
    const btnCalc = document.getElementById('calc-time');
    const checkoutBtn = document.getElementById('checkout-btn');
    const checkoutStatusEl = document.getElementById('checkout-status');
    const etaEl = document.getElementById('eta');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const toggleMapBtn = document.getElementById('toggle-map-btn');
    const mapEl = document.getElementById('map');
    const locationMessageEl = document.getElementById('location-message');
    const searchBox = document.getElementById('searchBox');
    let map, geocoder, distanceService, directionsService, directionsRenderer;
    let cart = [];
    let transportationCost = 0;
    let startLatLng = null, endLatLng = null;
    let markers = [];
    let isMapVisible = false;
    const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwUvA_InN9GzHNjuDTkV7A8VGSbLYEtkEkr-FwygSg0c6ZxxFnyIugasy8S_IM87Q/exec';
    const DEFAULT_PICKUP = '9CH5+J8J, Luangwa';

    // For filtering
    let filteredProducts = PRODUCTS.slice();

    searchBox.addEventListener('input', function() {
      const query = this.value.trim().toLowerCase();
      filteredProducts = PRODUCTS.filter(p => 
        p.name.toLowerCase().includes(query) ||
        (p.category && p.category.toLowerCase().includes(query))
      );
      renderProducts();
    });

    document.addEventListener('DOMContentLoaded', () => {
      try { renderProducts(); updateCart(); loadGoogleMaps(); }
      catch (error) { console.error('Initialization error:', error); showMessage('Failed to initialize the platform. Please try again.', "error"); }
    });

    function showMessage(message, type = "error") {
      const s = document.getElementById("statusMessage");
      s.textContent = message;
      s.className   = `status-message ${type}`;
      s.style.display = "block";
      setTimeout(() => s.style.display = "none", 5000);
    }

    function renderProducts() {
      try {
        productListEl.innerHTML = '';
        filteredProducts.forEach(p => {
          const div = document.createElement('div');
          div.className = 'product';
          div.innerHTML = `
            <img src="${p.image}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/100?text=Error';">
            <h4>${p.name}</h4>
            <p>ZK ${p.price.toFixed(2)}</p>
            <button data-id="${p.id}">
              <i class="fas fa-plus"></i> Add
            </button>
          `;
          productListEl.appendChild(div);
        });
      } catch (error) { console.error('Render products error:', error); showMessage('Error loading products.'); }
    }
    prevBtn.onclick = () => productListEl.scrollBy({ left: -200, behavior: 'smooth' });
    nextBtn.onclick = () => productListEl.scrollBy({ left: 200, behavior: 'smooth' });
    productListEl.addEventListener('click', e => {
      try {
        const button = e.target.closest('button');
        if (button && button.dataset.id) {
          const id = parseInt(button.dataset.id, 10);
          addToCart(id);
        }
      } catch (error) { console.error('Add to cart click error:', error); showMessage('Error adding to cart.'); }
    });
    function addToCart(id) {
      try {
        const product = PRODUCTS.find(x => x.id === id);
        if (product) {
          const cartItem = cart.find(item => item.product.id === id);
          if (cartItem) { cartItem.quantity += 1; }
          else { cart.push({ product, quantity: 1 }); }
          updateCart();
          const btn = document.querySelector(`button[data-id="${id}"]`);
          if (btn) {
            btn.innerHTML = '<i class="fas fa-check"></i> Added';
            btn.style.backgroundColor = 'var(--primary-dark)';
            setTimeout(() => {
              btn.innerHTML = '<i class="fas fa-plus"></i> Add';
              btn.style.backgroundColor = '';
            }, 1000);
          }
        } else { showMessage('Product not found.'); }
      } catch (error) { console.error('Add to cart error:', error); showMessage('Error adding to cart.'); }
    }
    function updateCart() {
      try {
        if (cart.length === 0) {
          cartItemsEl.innerHTML = '';
          emptyCartEl.style.display = 'block';
          cartTotalEl.style.display = 'none';
          checkoutBtn.style.display = 'none';
          checkoutStatusEl.style.display = 'none';
        } else {
          emptyCartEl.style.display = 'none';
          cartTotalEl.style.display = 'block';
          checkoutBtn.style.display = 'block';
          cartItemsEl.innerHTML = '';
          cart.forEach((item, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
              <span>${item.product.name} (x${item.quantity})</span>
              <div>
                <span>ZK ${(item.product.price * item.quantity).toFixed(2)}</span>
                <div class="quantity-controls">
                  <button class="quantity-btn decrease" data-index="${index}">-</button>
                  <button class="quantity-btn increase" data-index="${index}">+</button>
                  <button class="remove-btn" data-index="${index}">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            `;
            cartItemsEl.appendChild(li);
          });
          const productsTotal = cart.reduce((sum, item) => sum + item.product.price * item.quantity, 0);
          productsTotalEl.textContent = productsTotal.toFixed(2);
          const grandTotal = productsTotal + transportationCost;
          grandTotalEl.textContent = grandTotal.toFixed(2);
          if (transportationCost > 0) {
            transportationCostEl.textContent = transportationCost.toFixed(2);
            transportationLineEl.style.display = 'block';
          } else { transportationLineEl.style.display = 'none'; }
        }
        btnCalc.disabled = cart.length === 0 || (!endEl.value && !endLatLng) || !startLatLng;
      } catch (error) { console.error('Update cart error:', error); showMessage('Error updating cart.'); }
    }
    cartItemsEl.addEventListener('click', e => {
      try {
        const button = e.target.closest('button');
        if (!button) return;
        const index = parseInt(button.dataset.index, 10);
        if (button.classList.contains('remove-btn')) { cart.splice(index, 1); }
        else if (button.classList.contains('increase')) { cart[index].quantity += 1; }
        else if (button.classList.contains('decrease')) {
          cart[index].quantity -= 1;
          if (cart[index].quantity === 0) cart.splice(index, 1);
        }
        updateCart();
      } catch (error) { console.error('Cart interaction error:', error); showMessage('Error updating cart items.'); }
    });
    toggleMapBtn.addEventListener('click', () => {
      try {
        isMapVisible = !isMapVisible;
        mapEl.style.display = isMapVisible ? 'block' : 'none';
        toggleMapBtn.innerHTML = isMapVisible ? 
          '<i class="fas fa-map"></i> Hide Map' : 
          '<i class="fas fa-map"></i> Show Map';
        if (isMapVisible && map) {
          google.maps.event.trigger(map, 'resize');
          if (startLatLng || endLatLng) {
            map.setCenter(startLatLng || endLatLng);
          }
        }
      } catch (error) { console.error('Map toggle error:', error); showMessage('Error toggling map.'); }
    });
    // ... rest of your JS unchanged ...
    // (initMap, geocoding, order submission, etc.)

    function loadGoogleMaps() {
      try {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyDRdnvGw7epuDJjgBnpv0-FEuSQ6J-fyNY&libraries=places&callback=initMap`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      } catch (error) { showMessage('Error loading Google Maps.'); }
    }
  </script>
</body>
</html>
