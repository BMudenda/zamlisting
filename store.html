<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luangwa Delivery Platform - Transport Cart</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #2e7d32; --primary-dark: #1b5e20; --primary-light: #81c784; --accent: #ff9800;
      --text: #222; --text-light: #666; --background: #f5f5f5; --card-bg: white;
      --border: #e0e0e0; --shadow: 0 0 8px rgba(0,0,0,0.05); --success: #e8f5e9;
      --error: #ffebee; --toast-success: #43a047; --toast-error: #c62828; --danger: #c62828;
      --whatsapp: #25D366; --sms: #2196F3;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; color: var(--text); background: var(--background); line-height: 1.5; }
    header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 2.2rem 1rem 1.6rem; text-align: center; box-shadow: 0 2px 7px rgba(0,0,0,0.09); }
    header h1 { font-weight: bold; font-size: 2.1rem; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; display: flex; flex-wrap: wrap; gap: 2rem; }
    .masampo-wrapper, .bistore-wrapper { position: relative; flex: 2; min-width: 300px; background: var(--card-bg); border-radius: 10px; padding: 1.7rem 1.5rem; box-shadow: var(--shadow); }
    .section-title { font-size: 1.35rem; margin-bottom: 1.1rem; color: var(--primary-dark); display: flex; align-items: center; gap: 0.5rem; font-weight: 600; }
    .section-title i { color: var(--primary); }
    .store-slider { display: flex; overflow-x: auto; scroll-behavior: smooth; gap: 1.5rem; padding: 1rem 0; }
    .store-slider::-webkit-scrollbar { height: 6px; }
    .store-slider::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .store-slider::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 10px; }
    .product, .vehicle-item { flex: 0 0 160px; border: 1px solid var(--border); border-radius: 10px; padding: 1.1rem 0.7rem; text-align: center; background: var(--card-bg); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
    .product:hover, .vehicle-item:hover { transform: translateY(-7px) scale(1.04); box-shadow: 0 7px 22px rgba(0,0,0,0.13); }
    .product img, .vehicle-item img { width: 100px; height: 100px; object-fit: cover; margin-bottom: 0.8rem; border-radius: 4px; border: 1px solid #eee; }
    .product h4, .vehicle-item h4 { font-size: 1rem; margin-bottom: 0.53rem; color: var(--text); }
    .product p, .vehicle-item p { color: var(--primary-dark); font-weight: 600; margin-bottom: 0.8rem; }
    .vehicle-item p.location { font-size: 0.9rem; color: var(--text-light); }
    .product button { border: none; background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-family: inherit; font-weight: 500; transition: background 0.2s; }
    .product button:disabled, .product .out-stock { background: #ccc !important; cursor: not-allowed; }
    .product .out-stock { display: block; color: #b71c1c; font-size: 0.97em; font-weight: 600; margin-bottom: 0.7em; }
    .slider-button { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; }
    .slider-button:hover { background: rgba(0,0,0,0.8); }
    .slider-button.prev { left: 0; }
    .slider-button.next { right: 0; }
    .cart { border: 1px solid var(--border); padding: 1.7rem 1.3rem 2.1rem; border-radius: 10px; flex: 1; min-width: 300px; background: var(--card-bg); position: sticky; top: 1rem; box-shadow: var(--shadow); }
    .cart-items { list-style: none; padding: 0; margin: 0 0 1.5rem; max-height: 320px; overflow-y: auto; }
    .cart-items li { padding: 0.8rem 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 0.2em; animation: fadein 0.33s; min-height: 54px; }
    .cart-items li:last-child { border-bottom: none; }
    .cart-thumb { width: 36px; height: 36px; object-fit: cover; border-radius: 4px; margin-right: 8px; vertical-align: middle; border: 1.5px solid #e5e7eb; }
    .cart-item-info { display: flex; align-items: center; flex: 1; min-width: 0; }
    .cart-item-title { font-weight: 500; font-size: 1.04em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cart-item-qty { width: 44px; font-size: 1em; margin: 0 6px; padding: 2px 6px; border-radius: 4px; border: 1px solid #ddd; text-align: center; }
    .cart-price-block { display: flex; align-items: center; gap: 4px; }
    .quantity-controls { display: flex; align-items: center; gap: 2px; }
    .quantity-btn, .remove-btn { border: none; background: none; color: var(--primary-dark); font-size: 1.1em; margin: 0 2px; cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: background 0.2s; }
    .quantity-btn:active, .remove-btn:active { background: #f1f1f1; }
    .remove-btn { color: var(--danger); }
    .undo-toast { background: var(--accent); color: #222; padding: 8px 20px; border-radius: 7px; position: fixed; left: 50%; bottom: 25px; transform: translateX(-50%); z-index: 999; font-size: 1.05em; }
    .undo-btn { background: var(--primary); color: #fff; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-weight: 500; }
    .cart-total { margin: 1rem 0; padding-top: 1rem; border-top: 1px solid var(--border); }
    .cart-total p { margin: 0.5rem 0; }
    .address-input, .phone-input { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 5px; font-family: inherit; font-size: 0.93rem; transition: border 0.2s; }
    .address-input:focus, .phone-input:focus { outline: none; border-color: var(--primary); }
    .btn { border: none; background: var(--primary); color: white; padding: 0.8rem 1.2rem; border-radius: 4px; cursor: pointer; font-family: inherit; font-weight: 500; width: 100%; transition: background 0.2s; }
    .btn:hover { background: var(--primary-dark); }
    .btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.6; }
    .btn-accent { background: var(--accent); }
    .btn-accent:hover { background: #e68a00; }
    .btn-secondary { background: var(--primary-light); margin-top: 0.5rem; color: var(--primary-dark); }
    .btn-secondary:hover { background: var(--primary); color: #fff; }
    .submit-btn { width: 50px; height: 50px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.5rem; color: white; transition: transform 0.2s, background 0.2s; }
    .submit-btn:hover { transform: scale(1.1); }
    .whatsapp-btn { background: var(--whatsapp); }
    .sms-btn { background: var(--sms); }
    .status-message { display: none; margin: 1.1rem 0 1.3rem; padding: 0.75rem; border-radius: 4px; text-align: center; font-weight: 500; font-size: 1.08em; }
    .status-message.success { background: var(--success); color: var(--primary-dark); }
    .status-message.error { background: var(--error); color: var(--danger); }
    #searchBox { width: 100%; padding: 0.6rem; margin-bottom: 1.1rem; border-radius: 4px; border: 1px solid #ccc; font-size: 1.06rem; }
    .autocomplete-suggestions { border: 1px solid #ccc; background: #fff; max-height: 130px; overflow-y: auto; position: absolute; width: 100%; z-index: 999; border-radius: 0 0 7px 7px; left: 0; top: 100%; margin-top: -5px; font-size: 1em; display: none; }
    .autocomplete-suggestion { padding: 8px 14px; cursor: pointer; border-bottom: 1px solid #eee; }
    .autocomplete-suggestion:last-child { border-bottom: none; }
    .autocomplete-suggestion:hover { background: #e5efff; }
    .cart-inputs-flex { display: flex; gap: 12px; align-items: flex-end; margin-bottom: 1.2em; flex-wrap: wrap; }
    .cart-inputs-flex .input-group, .cart-inputs-flex .mode-container { min-width: 160px; flex: 1 1 160px; margin-bottom: 0 !important; }
    .cart-inputs-flex .mode-container { flex: 0 0 62px; min-width: 56px; max-width: 70px; display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-end; padding: 0; background: none; box-shadow: none; margin: 0; }
    .cart-inputs-flex .mode-container label { font-size: 13px; margin-bottom: 2px; margin-top: 5px; color: #2563eb; font-weight: 500; letter-spacing: .1em; margin-left: 3px; }
    .cart-inputs-flex .mode-group { display: flex; align-items: center; gap: 0; margin: 0; }
    .cart-inputs-flex .mode-radio { border: 1.5px solid #e5e7eb !important; background: #f8fafc !important; color: #2563eb; cursor: pointer; font-size: 16px; transition: border 0.2s; display: flex; align-items: center; gap: 2px; font-weight: 500; min-width: 0 !important; padding: 6px 8px 6px 6px !important; border-radius: 5px 0 0 5px !important; border-right: 0; box-shadow: none; margin: 0; }
    .cart-inputs-flex .mode-radio.selected { border: 2px solid #2563eb !important; background: #f0f6ff !important; z-index: 1; }
    .cart-inputs-flex .mode-radio:last-child { border-radius: 0 5px 5px 0 !important; border-right: 1.5px solid #e5e7eb !important; margin-left: -1px; }
    .cart-inputs-flex .mode-radio input[type="radio"] { accent-color: #2563eb; margin-right: 1px; margin-left: 0; width: 16px; height: 16px; }
    .cart-inputs-flex .mode-radio span.material-icons { font-size: 20px !important; margin: 0 2px 0 0; vertical-align: middle; }
    .transport-checkbox-container { display: flex; align-items: center; margin-bottom: 1rem; gap: 8px; }
    .transport-checkbox-container label { font-size: 0.95rem; color: var(--text); font-weight: 500; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: var(--card-bg); border-radius: 10px; padding: 1.5rem; max-width: 500px; width: 90%; position: relative; box-shadow: var(--shadow); }
    .modal-close { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text); }
    .modal-carousel { position: relative; margin-bottom: 1rem; }
    .modal-carousel img { width: 100%; height: 200px; object-fit: cover; border-radius: 5px; }
    .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: none; padding: 0.5rem; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
    .carousel-btn.prev { left: 10px; }
    .carousel-btn.next { right: 10px; }
    .modal-details p { margin: 0.5rem 0; }
    .modal-details p strong { color: var(--primary-dark); }
    .modal-buttons { display: flex; gap: 12px; margin-top: 1rem; }
    .bid-input { width: 100%; padding: 0.75rem; margin: 0.5rem 0; border: 1px solid var(--border); border-radius: 5px; font-family: inherit; font-size: 0.93rem; }
    .toast { position: fixed; left: 50%; top: 24px; transform: translateX(-50%); min-width: 190px; z-index: 9999; background: #333; color: #fff; padding: 13px 24px; border-radius: 7px; box-shadow: 0 2px 16px #0003; font-weight: 500; font-size: 1.07em; animation: fadein 0.2s; }
    .toast.success { background: var(--toast-success); }
    .toast.error { background: var(--toast-error); }
    @keyframes fadein { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @media (max-width: 650px) {
      .cart-inputs-flex { flex-direction: column; gap: 0.2em; align-items: stretch; }
      .cart-inputs-flex .input-group, .cart-inputs-flex .mode-container { max-width: unset; min-width: 0; flex: unset; }
      .cart { position: static; }
      .sticky-checkout { position: fixed !important; left: 0; right: 0; bottom: 0; width: 100vw; border-radius: 0; margin: 0; z-index: 999; }
      .modal-buttons { flex-direction: column; }
    }
  </style>
</head>
<body>
  <header>
    <h1 aria-label="Luangwa Delivery Platform"><i class="fas fa-truck"></i> Luangwa Delivery Platform</h1>
  </header>
  <div class="container">
    <div class="masampo-wrapper" aria-label="Masampo">
      <h2 class="section-title"><i class="fas fa-car"></i> Masampo</h2>
      <button class="slider-button prev" id="prevMasampoBtn" aria-label="Scroll left"><i class="fas fa-chevron-left"></i></button>
      <div id="masampo-list" class="store-slider"></div>
      <button class="slider-button next" id="nextMasampoBtn" aria-label="Scroll right"><i class="fas fa-chevron-right"></i></button>
      <div class="bistore-wrapper" aria-label="B-istore">
        <h2 class="section-title"><i class="fas fa-store"></i> B-istore</h2>
        <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
          <label for="categoryFilter" style="font-weight: 500;">Filter by Category:</label>
          <select id="categoryFilter" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;">
            <option value="all">All</option>
          </select>
        </div>
        <input type="text" id="searchBox" placeholder="Search products..." aria-label="Search products">
        <button class="slider-button prev" id="prevBistoreBtn" aria-label="Scroll left"><i class="fas fa-chevron-left"></i></button>
        <div id="bistore-list" class="store-slider"></div>
        <button class="slider-button next" id="nextBistoreBtn" aria-label="Scroll right"><i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
    <div class="cart" aria-label="Your Cart">
      <h2 class="section-title"><i class="fas fa-shopping-cart"></i> Your Order</h2>
      <ul id="cart-items" class="cart-items"></ul>
      <div id="empty-cart" class="empty-cart" aria-live="polite">
        <i class="fas fa-cart-arrow-down"></i>
        <p>Your cart is empty.</p>
        <p>Add items to get started.</p>
      </div>
      <div id="cart-total" class="cart-total" style="display:none;">
        <p>Products Total: ZK <span id="products-total">0.00</span></p>
        <p id="transportation-line" style="display:none;">
          Transportation: <span id="transport-icon">üöó</span>
          <span id="transportation-cost">0.00</span>
          <span id="distance-info" style="color:#2563eb;font-size:0.87em;"></span>
        </p>
        <p><strong>Total: ZK <span id="grand-total">0.00</span></strong></p>
      </div>
      <div class="transport-checkbox-container">
        <input type="checkbox" id="transport-required" checked>
        <label for="transport-required">Require Transportation</label>
      </div>
      <div id="transport-inputs" class="cart-inputs-flex">
        <div class="mode-container">
          <label for="mode-of-transport">Mode</label>
          <div class="mode-group">
            <label class="mode-radio selected" id="radio-vehicle">
              <input type="radio" name="mode" value="vehicle" id="mode-vehicle" checked>
              <span class="material-icons">directions_car</span>
            </label>
            <label class="mode-radio" id="radio-motorbike">
              <input type="radio" name="mode" value="motorbike" id="mode-motorbike">
              <span class="material-icons">two_wheeler</span>
            </label>
          </div>
        </div>
        <div class="input-group">
          <label for="gm-origin">From</label>
          <div style="position:relative;">
            <input type="text" id="gm-origin" class="address-input" autocomplete="off" placeholder="Enter starting point">
            <div id="gm-origin-list" class="autocomplete-suggestions"></div>
          </div>
        </div>
        <div class="input-group">
          <label for="gm-destination">To</label>
          <div style="position:relative;">
            <input type="text" id="gm-destination" class="address-input" autocomplete="off" placeholder="Enter destination">
            <div id="gm-destination-list" class="autocomplete-suggestions"></div>
          </div>
        </div>
        <div class="input-group" id="customer-phone-wrapper-flex">
          <label for="customer-phone">Phone</label>
          <input type="tel" id="customer-phone" maxlength="10" placeholder="e.g. 0966423229" inputmode="numeric" aria-label="Your phone number">
        </div>
      </div>
      <button id="checkout-btn" class="btn btn-accent sticky-checkout" style="margin-top: 1rem; display:none;">
        <i class="fas fa-credit-card"></i> Proceed to Checkout
      </button>
      <div id="statusMessage" class="status-message"></div>
    </div>
  </div>
  <div id="masampoModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" aria-label="Close modal">&times;</button>
      <h2 id="modalTitle"></h2>
      <div class="modal-carousel">
        <button class="carousel-btn prev" aria-label="Previous image"><i class="fas fa-chevron-left"></i></button>
        <img id="modalImage" src="" alt="Vehicle image">
        <button class="carousel-btn next" aria-label="Next image"><i class="fas fa-chevron-right"></i></button>
      </div>
      <div class="modal-details">
        <p><strong>Price:</strong> ZK <span id="modalPrice"></span></p>
        <p><strong>Location:</strong> <span id="modalLocation"></span></p>
        <p><strong>Condition:</strong> <span id="modalCondition"></span></p>
        <p><strong>Contact:</strong> <span id="modalContact"></span></p>
        <p><strong>Listed Since:</strong> <span id="modalListedSince"></span></p>
      </div>
      <input type="number" id="bidAmount" class="bid-input" placeholder="Enter your bid (ZK)" min="0" step="100">
      <div class="modal-buttons">
        <button id="modalAddToCart" class="btn btn-accent">Add to Cart</button>
        <button id="sendBidBtn" class="btn btn-secondary">Send Bid</button>
        <button id="modalWhatsappBtn" class="submit-btn whatsapp-btn" title="Send bid via WhatsApp"><i class="fab fa-whatsapp"></i></button>
        <button id="modalSmsBtn" class="submit-btn sms-btn" title="Send bid via SMS"><i class="fas fa-sms"></i></button>
      </div>
    </div>
  </div>
  <div id="toast-container"></div>
  <script>
    // --- Sample Data ---
    const MASAMPO_VEHICLES = [
      {
        id: 1001, name: "Toyota Corolla 2015", price: 120000, location: "Luangwa Market",
        image: "corolla.jpg", category: "vehicle", details: { condition: "Used, good condition", contact: "0971234567" },
        additionalImages: ["corolla_front.jpg", "corolla_side.jpg"], listedDate: "2025-08-01"
      },
      {
        id: 1002, name: "Honda CR-V 2018", price: 200000, location: "Katondwe Mission Hospital",
        image: "crv.jpg", category: "vehicle", details: { condition: "Excellent, low mileage", contact: "0966543210" },
        additionalImages: ["crv_front.jpg", "crv_rear.jpg"], listedDate: "2025-07-15"
      }
    ];
    const BISTORE_PRODUCTS = [
      { id: 1, name: "Mosi Beer", price: 25, image: "M.jpeg", category: "beverages" },
      { id: 2, name: "Coca-Cola bottled", price: 12, image: "MC.jpg", category: "beverages" },
      { id: 3, name: "Fanta", price: 12, image: "F.jpeg", category: "beverages" },
      { id: 100, name: "Calculator Casio GX-14", price: 230, image: "GX.jpg", category: "stationary" },
      { id: 101, name: "Blue Pen", price: 3, image: "pen2.png", category: "stationary" }
    ];
    const luangwaPlaces = [
      "Luangwa (Feira)", "Luangwa Market", "Katondwe Mission Hospital", "Chitope", "Kapoche"
    ];
    const segments = [
      { from: "Luangwa (Feira)", to: "Luangwa Market", distance: 0.1 },
      { from: "Luangwa (Feira)", to: "Katondwe Mission Hospital", distance: 52 },
      { from: "Luangwa (Feira)", to: "Kapoche", distance: 28 },
      { from: "Chitope", to: "Kapoche", distance: 10 }
    ];

    // --- DOM Elements ---
    const masampoListEl = document.getElementById('masampo-list');
    const bistoreListEl = document.getElementById('bistore-list');
    const cartItemsEl = document.getElementById('cart-items');
    const emptyCartEl = document.getElementById('empty-cart');
    const cartTotalEl = document.getElementById('cart-total');
    const productsTotalEl = document.getElementById('products-total');
    const transportationCostEl = document.getElementById('transportation-cost');
    const transportLineEl = document.getElementById('transportation-line');
    const transportIconEl = document.getElementById('transport-icon');
    const grandTotalEl = document.getElementById('grand-total');
    const checkoutBtn = document.getElementById('checkout-btn');
    const searchBox = document.getElementById('searchBox');
    const gmOriginEl = document.getElementById('gm-origin');
    const gmDestinationEl = document.getElementById('gm-destination');
    const modeVehicle = document.getElementById('mode-vehicle');
    const modeMotorbike = document.getElementById('mode-motorbike');
    const radioVehicle = document.getElementById('radio-vehicle');
    const radioMotorbike = document.getElementById('radio-motorbike');
    const customerPhoneInput = document.getElementById('customer-phone');
    const toastContainer = document.getElementById('toast-container');
    const categoryFilter = document.getElementById('categoryFilter');
    const distanceInfoEl = document.getElementById('distance-info');
    const transportRequired = document.getElementById('transport-required');
    const masampoModal = document.getElementById('masampoModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalImage = document.getElementById('modalImage');
    const modalPrice = document.getElementById('modalPrice');
    const modalLocation = document.getElementById('modalLocation');
    const modalCondition = document.getElementById('modalCondition');
    const modalContact = document.getElementById('modalContact');
    const modalListedSince = document.getElementById('modalListedSince');
    const modalAddToCart = document.getElementById('modalAddToCart');
    const sendBidBtn = document.getElementById('sendBidBtn');
    const modalWhatsappBtn = document.getElementById('modalWhatsappBtn');
    const modalSmsBtn = document.getElementById('modalSmsBtn');
    const bidAmountInput = document.getElementById('bidAmount');
    const modalClose = document.querySelector('.modal-close');
    const carouselPrev = document.querySelector('.carousel-btn.prev');
    const carouselNext = document.querySelector('.carousel-btn.next');

    // --- State ---
    let cart = [];
    let transportationCost = 0;
    let transportMode = 'vehicle';
    let selectedDistance = 0;
    let selectedDistanceFound = false;
    let transportNeeded = true;
    const TRANSPORT_COST_PER3KM = { vehicle: 20, motorbike: 10 };
    const TRANSPORT_ICON = { vehicle: "üöó", motorbike: "üèçÔ∏è" };
    let filteredProducts = BISTORE_PRODUCTS.slice();
    let undoTimeout = null, lastRemoved = null;
    let currentVehicle = null;
    let currentImageIndex = 0;

    // --- Calculate Listed Since ---
    function calculateListedSince(listedDate) {
      const listed = new Date(listedDate);
      const today = new Date();
      const diffTime = Math.abs(today - listed);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      if (diffDays === 0) return "Today";
      if (diffDays === 1) return "1 day ago";
      if (diffDays < 30) return `${diffDays} days ago`;
      const diffMonths = Math.floor(diffDays / 30);
      if (diffMonths === 1) return "1 month ago";
      return `${diffMonths} months ago`;
    }

    // --- Masampo (Vehicles) Rendering ---
    function renderMasampo() {
      masampoListEl.innerHTML = '';
      MASAMPO_VEHICLES.forEach(item => {
        const div = document.createElement('div');
        div.className = 'vehicle-item';
        div.tabIndex = 0;
        div.setAttribute('aria-label', `${item.name}, ZK ${item.price.toLocaleString()}`);
        div.innerHTML = `
          <img src="${item.image}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/100?text=Error';">
          <h4>${item.name}</h4>
          <p>ZK ${item.price.toLocaleString()}</p>
          <p class="location">${item.location}</p>
        `;
        div.addEventListener('click', () => showMasampoModal(item));
        masampoListEl.appendChild(div);
      });
    }

    // --- Masampo (Vehicles) Modal ---
    function showMasampoModal(item) {
      currentVehicle = item;
      currentImageIndex = 0;
      modalTitle.textContent = item.name;
      modalImage.src = item.image;
      modalPrice.textContent = item.price.toLocaleString();
      modalLocation.textContent = item.location;
      modalCondition.textContent = item.details.condition;
      modalContact.textContent = item.details.contact;
      modalListedSince.textContent = calculateListedSince(item.listedDate);
      bidAmountInput.value = '';
      masampoModal.style.display = 'flex';
      updateCarouselButtons();
    }

    function updateCarouselButtons() {
      carouselPrev.disabled = currentImageIndex === 0;
      carouselNext.disabled = currentImageIndex === currentVehicle.additionalImages.length;
    }

    carouselPrev.addEventListener('click', () => {
      if (currentImageIndex > 0) {
        currentImageIndex--;
        modalImage.src = currentVehicle.additionalImages[currentImageIndex] || currentVehicle.image;
        updateCarouselButtons();
      }
    });

    carouselNext.addEventListener('click', () => {
      if (currentImageIndex < currentVehicle.additionalImages.length) {
        currentImageIndex++;
        modalImage.src = currentImageIndex === 0 ? currentVehicle.image : currentVehicle.additionalImages[currentImageIndex - 1];
        updateCarouselButtons();
      }
    });

    modalClose.addEventListener('click', () => {
      masampoModal.style.display = 'none';
      currentVehicle = null;
      currentImageIndex = 0;
      bidAmountInput.value = '';
    });

    modalAddToCart.addEventListener('click', () => {
      if (currentVehicle) {
        addToCart(currentVehicle.id);
        masampoModal.style.display = 'none';
      }
    });

    // --- Bid Submission for Masampo (Vehicles) ---
    sendBidBtn.addEventListener('click', () => {
      const bidAmount = parseFloat(bidAmountInput.value);
      if (!currentVehicle || isNaN(bidAmount) || bidAmount <= 0) {
        showToast('Please enter a valid bid amount.', 'error');
        return;
      }
      showToast('Bid prepared! Use WhatsApp or SMS to send.', 'success');
      modalWhatsappBtn.style.display = 'inline-flex';
      modalSmsBtn.style.display = 'inline-flex';
    });

    modalWhatsappBtn.addEventListener('click', () => {
      if (!currentVehicle) return;
      const bidAmount = bidAmountInput.value;
      if (!bidAmount || isNaN(bidAmount) || bidAmount <= 0) {
        showToast('Please enter a valid bid amount.', 'error');
        return;
      }
      const message = `Bid for ${currentVehicle.name}: ZK ${bidAmount}`;
      const phone = currentVehicle.details.contact.replace(/\D/g, '');
      if (!phone || phone.length < 10) {
        showToast('Invalid contact number.', 'error');
        return;
      }
      const whatsappUrl = `https://wa.me/+260${phone.slice(1)}?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
      showToast('Bid sent via WhatsApp!', 'success');
      masampoModal.style.display = 'none';
    });

    modalSmsBtn.addEventListener('click', () => {
      if (!currentVehicle) return;
      const bidAmount = bidAmountInput.value;
      if (!bidAmount || isNaN(bidAmount) || bidAmount <= 0) {
        showToast('Please enter a valid bid amount.', 'error');
        return;
      }
      const message = `Bid for ${currentVehicle.name}: ZK ${bidAmount}`;
      const phone = currentVehicle.details.contact.replace(/\D/g, '');
      if (!phone || phone.length < 10) {
        showToast('Invalid contact number.', 'error');
        return;
      }
      const smsUrl = `sms:+260${phone.slice(1)}?body=${encodeURIComponent(message)}`;
      window.open(smsUrl, '_blank');
      showToast('Bid sent via SMS!', 'success');
      masampoModal.style.display = 'none';
    });

    // --- B-istore (Products) Rendering ---
    function renderBistore() {
      bistoreListEl.innerHTML = '';
      filteredProducts.forEach(p => {
        const div = document.createElement('div');
        div.className = 'product';
        div.tabIndex = 0;
        div.setAttribute('aria-label', `${p.name}, ZK ${p.price.toFixed(2)}`);
        let outStock = (p.price <= 0);
        div.innerHTML = `
          <img src="${p.image}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/100?text=Error';">
          <h4>${p.name}</h4>
          <p>ZK ${p.price.toFixed(2)}</p>
          ${outStock ? '<span class="out-stock">Out of Stock</span>' : ''}
          <button data-id="${p.id}" ${outStock ? 'disabled' : ''}>
            <i class="fas fa-plus"></i> Add
          </button>
        `;
        const btn = div.querySelector('button[data-id]');
        if (btn && !outStock) {
          btn.addEventListener("click", function(e) {
            e.preventDefault();
            e.stopPropagation();
            addToCart(p.id);
          });
        }
        bistoreListEl.appendChild(div);
      });
    }

    // --- Slider Buttons ---
    document.getElementById('prevMasampoBtn').onclick = () => masampoListEl.scrollBy({ left: -200, behavior: 'smooth' });
    document.getElementById('nextMasampoBtn').onclick = () => masampoListEl.scrollBy({ left: 200, behavior: 'smooth' });
    document.getElementById('prevBistoreBtn').onclick = () => bistoreListEl.scrollBy({ left: -200, behavior: 'smooth' });
    document.getElementById('nextBistoreBtn').onclick = () => bistoreListEl.scrollBy({ left: 200, behavior: 'smooth' });

    // --- Autocomplete ---
    function setupAutocomplete(inputId, suggestionsId, sourceList) {
      const input = document.getElementById(inputId);
      const suggestionsBox = document.getElementById(suggestionsId);
      input.addEventListener("input", function() {
        const query = input.value.trim().toLowerCase();
        suggestionsBox.innerHTML = "";
        if (!query) { suggestionsBox.style.display = "none"; return; }
        const matches = sourceList.filter(name => name.toLowerCase().includes(query)).slice(0, 5);
        if (matches.length === 0) { suggestionsBox.style.display = "none"; return; }
        matches.forEach(name => {
          const div = document.createElement("div");
          div.className = "autocomplete-suggestion";
          div.innerText = name;
          div.onclick = function() {
            input.value = name;
            suggestionsBox.innerHTML = "";
            suggestionsBox.style.display = "none";
            updateCart();
            autoFillDistance();
          };
          suggestionsBox.appendChild(div);
        });
        suggestionsBox.style.display = "block";
      });
      input.addEventListener("blur", function() {
        setTimeout(() => { suggestionsBox.style.display = "none"; }, 150);
      });
      input.addEventListener("focus", function() {
        if (input.value.trim()) input.dispatchEvent(new Event("input"));
      });
    }
    setupAutocomplete("gm-origin", "gm-origin-list", luangwaPlaces);
    setupAutocomplete("gm-destination", "gm-destination-list", luangwaPlaces);

    // --- Category Filter ---
    const categories = Array.from(new Set(BISTORE_PRODUCTS.map(p => p.category).filter(Boolean)));
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
      categoryFilter.appendChild(option);
    });

    categoryFilter.addEventListener('change', filterProducts);
    searchBox.addEventListener('input', filterProducts);

    function filterProducts() {
      const selectedCategory = categoryFilter.value;
      const query = searchBox.value.trim().toLowerCase();
      filteredProducts = BISTORE_PRODUCTS.filter(p => {
        const matchCategory = selectedCategory === 'all' || p.category === selectedCategory;
        const matchQuery = p.name.toLowerCase().includes(query) || (p.category && p.category.toLowerCase().includes(query));
        return matchCategory && matchQuery;
      });
      renderBistore();
    }

    // --- Cart Logic ---
    function addToCart(id) {
      const item = [...MASAMPO_VEHICLES, ...BISTORE_PRODUCTS].find(x => x.id === id);
      if (item) {
        const cartItem = cart.find(cartItem => cartItem.item.id === id);
        if (cartItem) { cartItem.quantity += 1; }
        else { cart.push({ item: item, quantity: 1 }); }
        updateCart();
        showToast(item.name + ' added to cart.', "success");
      } else { showToast('Item not found.', "error"); }
    }

    cartItemsEl.addEventListener('click', e => {
      const button = e.target.closest('button');
      if (!button) return;
      const index = parseInt(button.dataset.index, 10);
      if (button.classList.contains('remove-btn')) {
        let removed = cart.splice(index, 1)[0];
        updateCart();
        showUndoToast(removed, index);
      } else if (button.classList.contains('increase')) {
        cart[index].quantity += 1;
        updateCart();
      } else if (button.classList.contains('decrease')) {
        cart[index].quantity -= 1;
        if (cart[index].quantity === 0) {
          let removed = cart.splice(index, 1)[0];
          updateCart();
          showUndoToast(removed, index);
        } else updateCart();
      }
    });

    cartItemsEl.addEventListener('change', e => {
      const input = e.target;
      if (input.classList.contains('cart-item-qty')) {
        let idx = parseInt(input.dataset.index, 10);
        let qty = parseInt(input.value, 10);
        if (!isNaN(qty) && qty >= 1) {
          cart[idx].quantity = qty;
          updateCart();
        } else {
          input.value = cart[idx].quantity;
        }
      }
    });

    function showUndoToast(item, idx) {
      if (undoTimeout) clearTimeout(undoTimeout);
      lastRemoved = { item, idx };
      let toast = document.createElement('div');
      toast.className = "undo-toast";
      toast.innerHTML = `<span>Removed <b>${item.item.name}</b></span>
        <button class="undo-btn" id="undo-btn">Undo</button>`;
      toastContainer.appendChild(toast);
      document.getElementById('undo-btn').onclick = function() {
        cart.splice(idx, 0, item);
        updateCart();
        toast.remove();
        lastRemoved = null;
      };
      undoTimeout = setTimeout(() => { toast.remove(); lastRemoved = null; }, 4500);
    }

    // --- Transport Logic ---
    function buildGraph(segments) {
      const graph = {};
      segments.forEach(seg => {
        if (!graph[seg.from]) graph[seg.from] = [];
        if (!graph[seg.to]) graph[seg.to] = [];
        graph[seg.from].push({ place: seg.to, distance: seg.distance });
        graph[seg.to].push({ place: seg.from, distance: seg.distance });
      });
      return graph;
    }

    function findShortestDistance(from, to, segments) {
      const graph = buildGraph(segments);
      if (!graph[from] || !graph[to]) return null;
      const distances = {};
      const visited = new Set();
      luangwaPlaces.forEach(place => distances[place] = Infinity);
      distances[from] = 0;
      let queue = [{ place: from, dist: 0 }];
      while (queue.length > 0) {
        queue.sort((a, b) => a.dist - b.dist);
        const { place, dist } = queue.shift();
        if (place === to) return dist;
        if (visited.has(place)) continue;
        visited.add(place);
        for (let neighbor of (graph[place] || [])) {
          if (dist + neighbor.distance < distances[neighbor.place]) {
            distances[neighbor.place] = dist + neighbor.distance;
            queue.push({ place: neighbor.place, dist: distances[neighbor.place] });
          }
        }
      }
      return null;
    }

    function autoFillDistance() {
      const from = gmOriginEl.value.trim();
      const to = gmDestinationEl.value.trim();
      selectedDistance = 0;
      selectedDistanceFound = false;
      distanceInfoEl.textContent = "";
      if (from && to) {
        let dist = findShortestDistance(from, to, segments);
        if (dist != null && !isNaN(dist)) {
          selectedDistance = Math.round(dist * 100) / 100;
          selectedDistanceFound = true;
          distanceInfoEl.textContent = `(Distance: ${selectedDistance} km)`;
        } else {
          distanceInfoEl.textContent = `(No route found)`;
        }
        updateCart();
      }
    }

    gmOriginEl.addEventListener('input', autoFillDistance);
    gmDestinationEl.addEventListener('input', autoFillDistance);

    function calcTransportationCost() {
      if (transportNeeded && selectedDistanceFound && selectedDistance > 0) {
        const rate = TRANSPORT_COST_PER3KM[transportMode];
        return Math.ceil(selectedDistance / 3) * rate;
      }
      return 0;
    }

    function handleModeChange() {
      const v = modeVehicle.checked;
      radioVehicle.classList.toggle('selected', v);
      radioMotorbike.classList.toggle('selected', !v);
      transportMode = v ? 'vehicle' : 'motorbike';
      updateCart();
    }

    modeVehicle.addEventListener('change', handleModeChange);
    modeMotorbike.addEventListener('change', handleModeChange);

    transportRequired.addEventListener('change', () => {
      transportNeeded = transportRequired.checked;
      transportInputs.style.display = transportNeeded ? '' : 'none';
      customerPhoneInput.style.display = transportNeeded ? '' : 'none';
      updateCart();
    });

    // --- Update Cart Display ---
    function updateCart() {
      transportationCost = calcTransportationCost();
      if (cart.length === 0) {
        cartItemsEl.innerHTML = '';
        emptyCartEl.style.display = 'block';
        cartTotalEl.style.display = 'none';
        checkoutBtn.style.display = 'none';
      } else {
        emptyCartEl.style.display = 'none';
        cartTotalEl.style.display = 'block';
        checkoutBtn.style.display = 'block';
        cartItemsEl.innerHTML = '';
        cart.forEach((item, index) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="cart-item-info">
              <img src="${item.item.image}" alt="${item.item.name}" class="cart-thumb" onerror="this.src='https://via.placeholder.com/36?text=Err';">
              <span class="cart-item-title">${item.item.name}</span>
            </div>
            <div class="cart-price-block">
              <span style="min-width:60px;">ZK ${(item.item.price * item.quantity).toFixed(2)}</span>
              <div class="quantity-controls">
                <button class="quantity-btn decrease" data-index="${index}">-</button>
                <input type="number" min="1" class="cart-item-qty" data-index="${index}" value="${item.quantity}">
                <button class="quantity-btn increase" data-index="${index}">+</button>
                <button class="remove-btn" data-index="${index}"><i class="fas fa-times"></i></button>
              </div>
            </div>
          `;
          cartItemsEl.appendChild(li);
        });
        const productsTotal = cart.reduce((sum, item) => sum + item.item.price * item.quantity, 0);
        productsTotalEl.textContent = productsTotal.toFixed(2);
        transportationCostEl.textContent = transportationCost.toFixed(2);
        transportLineEl.style.display = transportationCost > 0 ? 'block' : 'none';
        transportIconEl.textContent = TRANSPORT_ICON[transportMode];
        grandTotalEl.textContent = (productsTotal + transportationCost).toFixed(2);
      }
    }

    // --- Toasts ---
    function showToast(message, type = "success") {
      const div = document.createElement('div');
      div.className = `toast ${type}`;
      div.textContent = message;
      toastContainer.appendChild(div);
      setTimeout(() => { div.style.opacity = 0; setTimeout(() => div.remove(), 300); }, 3000);
    }

    // --- Checkout Logic ---
    function validatePhone(phone) {
      return /^0[0-9]{9}$/.test(phone);
    }

    customerPhoneInput.addEventListener('input', function() {
      if (!validatePhone(this.value) && this.value.length >= 10)
        this.style.borderColor = "var(--danger)";
      else this.style.borderColor = "";
    });

    checkoutBtn.addEventListener('click', () => {
      if (cart.length === 0) {
        showToast('Your cart is empty.', "error");
        return;
      }
      if (transportNeeded) {
        const from = gmOriginEl.value.trim();
        const to = gmDestinationEl.value.trim();
        if (!from || !to) {
          showToast('Please enter both origin and destination.', "error");
          return;
        }
        if (!selectedDistanceFound) {
          showToast('No known route found.', "error");
          return;
        }
        const phone = customerPhoneInput.value.trim();
        if (!validatePhone(phone)) {
          showToast('Please enter a valid phone number (e.g., 0971234567).', "error");
          return;
        }
      }
      showToast('Order submitted successfully!', "success");
      cart = [];
      gmOriginEl.value = '';
      gmDestinationEl.value = '';
      customerPhoneInput.value = '';
      selectedDistance = 0;
      selectedDistanceFound = false;
      distanceInfoEl.textContent = '';
      updateCart();
    });

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
      modeVehicle.checked = true;
      handleModeChange();
      renderMasampo();
      renderBistore();
      updateCart();
      function updateStickyCheckout() {
        if (window.innerWidth < 650) checkoutBtn.classList.add('sticky-checkout');
        else checkoutBtn.classList.remove('sticky-checkout');
      }
      updateStickyCheckout();
      window.addEventListener('resize', updateStickyCheckout);
    });
  </script>
</body>
</html>
