<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>view data</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f2f5;
    margin: 0;
    padding: 20px;
  }

  h2 {
    text-align: center;
    color: #333;
  }

  #startBtn {
    display: block;
    margin: 0 auto 15px auto;
    padding: 10px 20px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    background-color: #28a745;
    color: #fff;
    border: none;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  th, td {
    padding: 12px 15px;
    border-bottom: 1px solid #ddd;
    text-align: left;
  }

  th {
    background-color: #343a40;
    color: #fff;
    text-transform: uppercase;
    font-size: 14px;
  }

  tr.new-row {
    background-color: #d4edda;
    font-weight: bold;
    transition: background-color 0.5s;
  }

  tr.selected {
    background-color: #ffeeba;
  }

  #actions {
    text-align: center;
  }

  .action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 5px;
    padding: 10px 16px;
    font-size: 16px;
    border-radius: 6px;
    border: none;
    color: #fff;
    cursor: pointer;
    transition: background 0.3s;
  }

  .call-btn { background-color: #28a745; }      /* Green */
  .sms-btn { background-color: #007bff; }       /* Blue */
  .whatsapp-btn { background-color: #25D366; }  /* WhatsApp Green */

  .action-btn span {
    margin-right: 8px;
    font-size: 18px;
  }

  .action-btn:hover {
    opacity: 0.8;
  }
</style>
</head>
<body>

<h2>üìå View Data</h2>

<button id="startBtn">‚ñ∂ Start Notifications</button>

<table id="dataTable">
  <thead></thead>
  <tbody></tbody>
</table>

<div id="actions">
  <button class="action-btn call-btn" id="callBtn"><span>üìû</span>Call</button>
  <button class="action-btn sms-btn" id="smsBtn"><span>‚úâÔ∏è</span>SMS</button>
  <button class="action-btn whatsapp-btn" id="whatsappBtn"><span>üí¨</span>WhatsApp</button>
</div>

<audio id="beepSound" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  Your browser does not support the audio element.
</audio>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbxpvhvgnjkRcZmuly7uNzPeAC5OwVUq8-qUJ2WXrOqOnSsNgCn0ZHbuz6BGslW83_rB5Q/exec";
let lastRowCount = 0;
let selectedRow = null;
let selectedPhone = null;
const beep = document.getElementById("beepSound");
let intervalID = null;

// Fetch and display sheet data
async function fetchData() {
  try {
    const response = await fetch(SHEET_URL);
    const data = await response.json();
    const rows = data.rows;
    if (!rows || rows.length === 0) return;

    const tableHead = document.querySelector("#dataTable thead");
    const tableBody = document.querySelector("#dataTable tbody");
    const prevSelectedPhone = selectedPhone;

    tableHead.innerHTML = "";
    tableBody.innerHTML = "";

    // Header row
    const headerRow = document.createElement("tr");
    Object.keys(rows[0]).forEach(header => {
      const th = document.createElement("th");
      th.textContent = header;
      headerRow.appendChild(th);
    });
    tableHead.appendChild(headerRow);

    const newDataAdded = rows.length > lastRowCount;

    // Populate table
    rows.forEach((row, index) => {
      const tr = document.createElement("tr");
      Object.values(row).forEach(value => {
        const td = document.createElement("td");
        td.textContent = value;
        tr.appendChild(td);
      });

      // Highlight new row
      if (index === rows.length - 1 && newDataAdded) {
        tr.classList.add("new-row");
      }

      // Select row
      tr.addEventListener("click", () => {
        if (selectedRow) selectedRow.classList.remove("selected");
        tr.classList.add("selected");
        selectedRow = tr;
        selectedPhone = row.phone || row.Phone || null;
      });

      // Re-select previous row
      if (row.phone === prevSelectedPhone) {
        tr.classList.add("selected");
        selectedRow = tr;
        selectedPhone = prevSelectedPhone;
      }

      tableBody.appendChild(tr);
    });

    // Play beep for new row
    if (newDataAdded) {
      beep.currentTime = 0;
      beep.play().catch(err => console.log("Beep error:", err));
    }

    lastRowCount = rows.length;

  } catch (err) {
    console.error("Error fetching data:", err);
  }
}

// Action buttons
document.getElementById("callBtn").addEventListener("click", () => {
  if (!selectedPhone) return alert("Select a row with a phone number first.");
  window.location.href = `tel:${selectedPhone}`;
});

document.getElementById("smsBtn").addEventListener("click", () => {
  if (!selectedPhone) return alert("Select a row with a phone number first.");
  window.location.href = `sms:${selectedPhone}`;
});

document.getElementById("whatsappBtn").addEventListener("click", () => {
  if (!selectedPhone) return alert("Select a row with a phone number first.");
  const phoneDigits = selectedPhone.replace(/\D/g,'');
  window.open(`https://wa.me/${phoneDigits}`, "_blank");
});

// Start notifications button (to unlock beep)
document.getElementById("startBtn").addEventListener("click", () => {
  beep.play().catch(()=>{});
  document.getElementById("startBtn").style.display = "none";
  fetchData();
  intervalID = setInterval(fetchData, 10000);
});
</script>

</body>
</html>
