<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rides Data Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --dark: #343a40;
            --light: #f8f9fa;
            --accent: #17a2b8;
            --background: #f4f6f9;
        }

        /* Base & Typography */
        body { font-family: 'Roboto', sans-serif; background: var(--background); margin: 0; padding: 20px; color: #333; }
        .dashboard-container { max-width: 1200px; margin: 0 auto; }
        h2 { 
            text-align: center; 
            color: var(--dark); 
            margin-bottom: 25px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* Start Button & Controls Area */
        .controls-panel {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            gap: 20px; 
            flex-wrap: wrap; 
        }

        #startBtn {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--success);
            color: #fff;
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(40, 167, 69, 0.3);
            transition: background-color 0.3s, transform 0.1s;
        }
        #startBtn:hover { background-color: #218838; transform: translateY(-1px); }
        #startBtn:active { transform: translateY(1px); }

        /* Search Input Styles */
        #searchInput {
            padding: 10px 15px;
            font-size: 16px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            width: 300px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #searchInput:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Table Styles (Card Interface) */
        #dataTable {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        th, td {
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef; 
            text-align: left;
            font-size: 14px;
        }
        th { 
            background-color: var(--dark); 
            color: #fff; 
            text-transform: uppercase; 
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        tr:nth-child(even) { background-color: var(--light); }
        tr:last-child td { border-bottom: none; }

        /* Row States */
        tr:hover { background-color: #e2e6ea; cursor: pointer; }
        tr.new-row { background-color: #d4edda; font-weight: 500; animation: flash-new 3s ease-in-out; }
        tr.selected { 
            background-color: #ffeeba !important; 
            box-shadow: inset 5px 0 0 0 var(--warning); 
            border-color: var(--warning);
        }
        @keyframes flash-new {
            0%, 100% { background-color: #d4edda; }
            50% { background-color: #fff; }
        }

        /* --- FIELDSET ACTION BAR DESIGN CORRECTION --- */
        #actionBar {
            margin: 25px auto; 
            padding: 15px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            display: flex;
            align-items: flex-start;
            
            /* CRITICAL: Centers the entire bar and forces non-wrapping side-by-side layout */
            gap: 20px; 
            max-width: fit-content;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            flex-wrap: nowrap;
        }

        fieldset {
            /* Width calculation for clean alignment */
            width: 280px; 
            
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 0;
            display: flex; 
            gap: 10px;
            align-items: center;
            justify-content: space-between; /* Ensures buttons are spread evenly inside */
        }
        legend {
            font-weight: 700;
            color: var(--dark);
            font-size: 16px;
            padding: 0 10px;
            text-transform: uppercase;
        }

        .action-btn {
            display: flex; 
            align-items: center; 
            justify-content: center;
            width: 45px; 
            height: 45px; 
            padding: 0;
            font-size: 18px; 
            border-radius: 50%;
            border: none; 
            color: #fff; 
            cursor: pointer; 
            transition: all 0.2s ease-in-out;
        }
        .action-btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed;
            box-shadow: none;
        }
        .action-btn i { font-size: 18px; margin: 0; }
        
        /* Specific Button Colors & Effects */
        .call-btn { background-color: var(--success); box-shadow: 0 4px 6px rgba(40, 167, 69, 0.4); }
        .sms-btn { background-color: var(--primary); box-shadow: 0 4px 6px rgba(0, 123, 255, 0.4); }
        .whatsapp-btn { background-color: #25D366; box-shadow: 0 4px 6px rgba(37, 211, 102, 0.4); }
        .utility-btn { background-color: var(--accent); box-shadow: 0 4px 6px rgba(23, 162, 184, 0.4); }
        
        .action-btn:hover:not(:disabled) { 
            transform: scale(1.05); 
            filter: brightness(1.1);
        }

        /* UI Notification (remains unchanged) */
        #notification {
            position: fixed;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 25px;
            background-color: var(--accent);
            color: white;
            font-weight: 500;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: top 0.5s ease-out, opacity 0.5s;
            opacity: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #notification.show { top: 0; opacity: 1; }

        /* Media Queries: Ensures stacking on small screens */
        @media(max-width:768px){
            body { padding: 10px; }
            th, td { font-size: 11px; padding:10px; }
            .action-btn { width: 40px; height: 40px; font-size: 16px; }
            .controls-panel { flex-direction: column; gap: 15px; }
            #startBtn { width: 100%; justify-content: center; }
            #searchInput { width: 100%; }
            #actionBar {
                flex-direction: column; /* Forces stacking */
                width: 100%; /* Allows bar to fill mobile screen */
                max-width: 100%;
                gap: 10px;
            }
            fieldset {
                width: 100%;
                box-sizing: border-box; /* Include padding/border in width */
            }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <h2><i class="fas fa-chart-line"></i> Rides Data </h2>

        <div class="controls-panel">
            <button id="startBtn">
                <i class="fas fa-play-circle"></i> 
                Start Live Feed
            </button>
            <input type="text" id="searchInput" placeholder="Search table data..." aria-label="Search table data" disabled>
        </div>

        <table id="dataTable">
            <thead></thead>
            <tbody></tbody>
        </table>
        
        <div id="actionBar">
            
            <fieldset>
                <legend><i class="fas fa-share-alt"></i> Share</legend>
                <button class="action-btn sms-btn" data-action="share_sms" id="shareSmsBtn" title="SMS ride details to 0966423229" disabled>
                    <i class="fas fa-sms"></i>
                </button>
                <button class="action-btn whatsapp-btn" data-action="share_whatsapp" id="shareWhatsappBtn" title="WhatsApp ride details to 0966423229" disabled>
                    <i class="fab fa-whatsapp"></i>
                </button>
            </fieldset>
            
            <fieldset>
                <legend><i class="fas fa-headset"></i> Contact</legend>
                <button class="action-btn call-btn" data-action="customer_call" id="customerCallBtn" title="Call customer phone" disabled>
                    <i class="fas fa-phone"></i>
                </button>
                <button class="action-btn sms-btn" data-action="customer_sms" id="customerSmsBtn" title="Send predefined SMS to customer" disabled>
                    <i class="fas fa-sms"></i>
                </button>
                <button class="action-btn whatsapp-btn" data-action="customer_whatsapp" id="customerWhatsappBtn" title="Send predefined WhatsApp to customer" disabled>
                    <i class="fab fa-whatsapp"></i>
                </button>
                <button class="action-btn utility-btn" data-action="utility" id="utilityBtn" title="View basic trip details" disabled>
                    <i class="fas fa-eye"></i>
                </button>
            </fieldset>
        </div>
        <div id="notification" role="alert" aria-live="assertive"></div>

        <audio id="beepSound" preload="auto">
            <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
        </audio>
    </div>

    <script type="module" defer>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-messaging.js";

        // IMPORTANT: Replace placeholders with your actual keys.
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY_HERE", 
            authDomain: "livenoti-1c991.firebaseapp.com",
            projectId: "livenoti-1c991",
            storageBucket: "livenoti-1c991.firebasestorage.app",
            messagingSenderId: "128526406523",
            appId: "1:128526406523:web:0d8f25909746a15e9c63de",
            measurementId: "G-K6MZ7CTLCW"
        };

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        // Request permission and get token
        Notification.requestPermission().then(permission => {
            if (permission === 'granted' && firebaseConfig.apiKey !== 'YOUR_FIREBASE_API_KEY_HERE') {
                getToken(messaging, { vapidKey: 'YOUR_PUBLIC_VAPID_KEY_HERE' })
                    .then(token => console.log('FCM Token:', token))
                    .catch(console.error);
            }
        });

        // Handle foreground messages
        onMessage(messaging, (payload) => {
            console.log('FCM Message received:', payload);
            if (window.dashboard && typeof window.dashboard.handleNewData === 'function') {
                // Pass notification data to the dashboard handler
                window.dashboard.handleNewData(payload.notification.title, payload.notification.body);
            } else {
                 console.error("Dashboard module not fully initialized when FCM received.");
            }
        });
    </script>

    <script defer>
        /**
         * Live Dashboard Module (IIFE)
         */
        const Dashboard = (() => {
            // CRITICAL: Replace this URL with your published Google Apps Script Web App URL for data fetching
            const SHEET_URL = "https://script.google.com/macros/s/AKfycbxpvhvgnjkRcZmuly7uNzPeAC5OwVUq8-qUJ2WXrOqOnSsNgCn0ZHbuz6BGslW83_rB5Q/exec";
            const DISPATCH_NUMBER = "0966423229";
            
            let lastRowCount = 0;
            let selectedRow = null;
            let selectedPhone = null; // Customer's phone number

            // DOM Elements
            const elements = {
                tableHead: document.querySelector("#dataTable thead"),
                tableBody: document.querySelector("#dataTable tbody"),
                startBtn: document.getElementById("startBtn"),
                searchInput: document.getElementById("searchInput"),
                shareSmsBtn: document.getElementById("shareSmsBtn"),
                shareWhatsappBtn: document.getElementById("shareWhatsappBtn"),
                customerCallBtn: document.getElementById("customerCallBtn"),
                customerSmsBtn: document.getElementById("customerSmsBtn"),
                customerWhatsappBtn: document.getElementById("customerWhatsappBtn"),
                utilityBtn: document.getElementById("utilityBtn"),
                beep: document.getElementById("beepSound"),
                notification: document.getElementById("notification"),
            };

            // Utility Functions
            const formatTimestamp = (value) => {
                if (!value) return "";
                const dateObj = new Date(value);
                if (isNaN(dateObj)) return value;
                // Formats to: M/D/YYYY, H:MM:SS AM/PM
                return dateObj.toLocaleString('en-US', { hour12: true });
            };

            const showNotification = (title, body, isError = false) => {
                const message = `${title || 'Notification'}: ${body || 'Table Updated.'}`;
                elements.notification.innerHTML = `<i class="fas fa-bell"></i> ${message}`;
                elements.notification.style.backgroundColor = isError ? 'var(--danger)' : 'var(--accent)';
                elements.notification.classList.add('show');
                setTimeout(() => {
                    elements.notification.classList.remove('show');
                }, 4000);
            };

            const playBeep = () => {
                elements.beep.currentTime = 0;
                elements.beep.play().catch(e => console.warn("Audio playback failed:", e));
            };

            const updateActionButtons = (phone) => {
                const isDisabled = !phone;
                
                // All buttons are disabled if no row with a phone number is selected
                elements.shareSmsBtn.disabled = isDisabled;
                elements.shareWhatsappBtn.disabled = isDisabled;
                elements.customerCallBtn.disabled = isDisabled;
                elements.customerSmsBtn.disabled = isDisabled;
                elements.customerWhatsappBtn.disabled = isDisabled;
                elements.utilityBtn.disabled = isDisabled;
            };
            
            const filterTable = () => {
                const filter = elements.searchInput.value.toUpperCase();
                const rows = elements.tableBody.querySelectorAll("tr");

                rows.forEach(row => {
                    let textContent = row.textContent || row.innerText;
                    if (textContent.toUpperCase().indexOf(filter) > -1) {
                        row.style.display = ""; 
                    } else {
                        row.style.display = "none"; 
                    }
                });
            };

            // Core Data Fetching and Rendering
            const fetchData = async () => {
                try {
                    const response = await fetch(SHEET_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    const rows = data.rows;
                    if (!rows || rows.length === 0) {
                        elements.tableHead.innerHTML = '<tr><th>No Data Available</th></tr>';
                        elements.tableBody.innerHTML = '';
                        elements.searchInput.disabled = true; 
                        return;
                    }

                    elements.searchInput.disabled = false; 
                    const newDataAdded = rows.length > lastRowCount;
                    const prevSelectedPhone = selectedPhone;
                    
                    elements.tableHead.innerHTML = "";
                    elements.tableBody.innerHTML = "";

                    // Render Headers
                    const headerRow = document.createElement("tr");
                    Object.keys(rows[0]).forEach(header => {
                        const th = document.createElement("th");
                        th.textContent = header;
                        headerRow.appendChild(th);
                    });
                    elements.tableHead.appendChild(headerRow);

                    // Render Body Rows
                    rows.forEach((row, index) => {
                        const tr = document.createElement("tr");
                        let currentRowPhone = null;

                        Object.entries(row).forEach(([key, value]) => {
                            const td = document.createElement("td");
                            const lowerKey = key.toLowerCase();

                            if (lowerKey.includes("time") || lowerKey.includes("date")) {
                                td.textContent = formatTimestamp(value);
                            } else {
                                td.textContent = value;
                            }
                            
                            if (lowerKey.includes("phone")) {
                                currentRowPhone = String(value);
                            }

                            tr.appendChild(td);
                        });

                        // Highlight New Row and Scroll
                        if (index === rows.length - 1 && newDataAdded) {
                            tr.classList.add("new-row");
                            tr.scrollIntoView({ behavior: "smooth", block: "nearest" });
                        }

                        // Re-select previously selected row
                        if (currentRowPhone && currentRowPhone === prevSelectedPhone) {
                            tr.classList.add("selected");
                            selectedRow = tr;
                            selectedPhone = prevSelectedPhone;
                        }

                        // Add click listener
                        tr.addEventListener("click", () => {
                            if (selectedRow) selectedRow.classList.remove("selected");
                            tr.classList.add("selected");
                            selectedRow = tr;
                            selectedPhone = currentRowPhone || null; 
                            updateActionButtons(selectedPhone);
                        });

                        elements.tableBody.appendChild(tr);
                    });
                    
                    if(newDataAdded) {
                        playBeep();
                        showNotification(`New Entry (${rows.length})`, 'Table updated with new data.');
                    }
                    
                    lastRowCount = rows.length;
                    updateActionButtons(selectedPhone); 
                    filterTable();
                } catch (err) {
                    console.error("Error fetching data:", err);
                    showNotification("Data Error", "Failed to load data from server.", true);
                    elements.searchInput.disabled = true; 
                }
            };
            

            // Action Handler
            const handleAction = (event) => {
                const method = event.currentTarget.dataset.action;

                if (!selectedRow) {
                    return showNotification("Action Required", "Select a ride row first.", true);
                }
                
                // Get customer phone for validation/action
                const customerDigits = selectedPhone ? selectedPhone.replace(/\D/g, '') : '';
                
                // --- MESSAGE DEFINITIONS (Based on column indices) ---
                const dispatchMessage = `*NEW RIDE ALERT*
Phone: ${customerDigits}
Mode: ${selectedRow.cells[0].textContent}
From: ${selectedRow.cells[3].textContent}
To: ${selectedRow.cells[4].textContent}
Price: ${selectedRow.cells[8].textContent}
(Shared from Dashboard)`;
                
                const customerPredefinedMessage = "Thank you for requesting a Ride with Luangwa Feira Rides /www.zamlisting.com/customerride. See you in the next few minutes";


                // --- LOGIC BASED ON ACTION TYPE ---
                let targetNumber;
                let messageBody;
                let isCall = false;

                switch (method) {
                    // 1. SHARE RIDE DETAILS TO DISPATCH NUMBER
                    case 'share_sms':
                    case 'share_whatsapp':
                        targetNumber = DISPATCH_NUMBER;
                        messageBody = dispatchMessage;
                        break;

                    // 2. CONTACT CUSTOMER
                    case 'customer_call':
                        if (!customerDigits) return showNotification("Call Failed", "Customer phone number is missing.", true);
                        targetNumber = customerDigits;
                        isCall = true;
                        break;
                    case 'customer_sms':
                    case 'customer_whatsapp':
                        if (!customerDigits) return showNotification("Message Failed", "Customer phone number is missing.", true);
                        targetNumber = customerDigits;
                        messageBody = customerPredefinedMessage;
                        break;

                    case 'utility':
                         showNotification("View Details", `Trip: ${selectedRow.cells[3].textContent} to ${selectedRow.cells[4].textContent}.`, false);
                         return; // Utility action completes here
                    default:
                        return;
                }

                // --- EXECUTION ---
                if (isCall) {
                    window.location.href = `tel:${targetNumber}`;
                } else {
                    const encodedMessage = encodeURIComponent(messageBody);
                    
                    if (method.includes('sms')) {
                        window.location.href = `sms:${targetNumber}?body=${encodedMessage}`;
                    } else if (method.includes('whatsapp')) {
                         // Format WhatsApp number (e.g., handles country code/leading 0)
                         const whatsappNumber = targetNumber.startsWith('260') ? targetNumber : `260${targetNumber.substring(1).replace(/\D/g, '')}`;
                         window.open(`https://wa.me/${whatsappNumber}?text=${encodedMessage}`, "_blank");
                    }
                }
            };

            const startFeed = () => {
                elements.startBtn.style.display = "none";
                elements.searchInput.disabled = false; 
                showNotification("Live Feed Started", "Data is now updating every 10 seconds.");
                fetchData();
                // Start the polling interval (10 seconds)
                setInterval(fetchData, 10000);
            };

            // Initialization
            const init = () => {
                elements.startBtn.addEventListener("click", startFeed);
                elements.searchInput.addEventListener("input", filterTable); 

                // Attach event listener to all action buttons
                document.querySelectorAll('.action-btn').forEach(button => {
                    button.addEventListener('click', handleAction);
                });
                
                updateActionButtons(null);
            };
            
            // Public Interface
            return {
                init: init,
                handleNewData: (title, body) => {
                    playBeep();
                    showNotification(title, body);
                    fetchData();
                }
            };
        })();

        // Start the dashboard
        Dashboard.init();
        window.dashboard = Dashboard;
    </script>
</body>
</html>
