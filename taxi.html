<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RideTrack Fare Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      display: flex;
      justify-content: center;
      padding: 40px 10px;
    }
    .container {
      width: 100%;
      max-width: 540px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      padding: 25px 20px;
      border-radius: 15px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
      max-width: 480px;
      width: 100%;
      margin: 0 auto;
    }
    label {
      font-weight: bold;
      margin: 10px 0 5px;
      display: block;
    }
    input[type="text"],
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .checkbox-group {
      margin: 10px 0;
    }
    .checkbox-group input {
      margin-right: 10px;
    }
    .result {
      font-size: 18px;
      color: #007700;
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
    }
    .autocomplete-suggestions {
      border: 1px solid #ccc;
      position: absolute;
      background-color: white;
      max-height: 150px;
      overflow-y: auto;
      width: calc(100% - 40px);
      z-index: 999;
      border-radius: 0 0 10px 10px;
    }
    .autocomplete-suggestion {
      padding: 8px;
      cursor: pointer;
    }
    .autocomplete-suggestion:hover {
      background-color: #eee;
    }
    .input-group {
      position: relative;
    }
    .driver-details {
      font-size: 14px;
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .cancel-message {
      color: #b30000;
      font-weight: bold;
      text-align: center;
      margin-top: 15px;
      display: none;
    }
    .submit-message {
      color: #007700;
      font-weight: bold;
      text-align: center;
      margin-top: 15px;
      display: none;
    }
    .error-message {
      color: #b30000;
      font-weight: bold;
      text-align: center;
      margin-top: 15px;
      display: none;
    }
    .field-reminder {
      color: #b30000;
      font-weight: bold;
      font-size: 0.98rem;
      margin-top: -7px;
      margin-bottom: 5px;
      display: none;
    }
    .button-group {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .cancel-btn {
      background: #b30000;
      color: #fff;
      border: none;
      padding: 10px 25px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    .submit-btn {
      background: #007700;
      color: #fff;
      border: none;
      padding: 10px 25px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    .loader {
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    .loader div {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #b30000;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    .instructions-toggle {
      background: #e0e0e0;
      color: #333;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 1rem;
      display: block;
      margin: 0 auto 12px auto;
      cursor: pointer;
      transition: background 0.2s;
    }
    .instructions-toggle:hover {
      background: #d4e4fa;
    }
    .instructions-box {
      background: #f6faff;
      border: 1px solid #b3c6e6;
      border-radius: 10px;
      padding: 16px 20px;
      margin-bottom: 18px;
      color: #222;
      font-size: 1rem;
    }
    .instructions-box ul {
      margin: 0;
      padding-left: 18px;
    }
    .instructions-box li {
      margin-bottom: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @media(max-width: 600px) {
      .container { max-width: 100%; }
      .card { max-width: 100%; }
    }
    @media(max-width: 480px) {
      body {
        padding: 10px;
      }
      .button-group {
        flex-direction: column;
      }
      .button-group button {
        width: 100%;
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h1 style="text-align:center; color:#2c3e50; margin-bottom:30px;">üöñ RideTrack</h1>
  
  <button type="button" class="instructions-toggle" onclick="toggleInstructions()" id="instructionsBtn">
    <span id="instructionsBtnIcon">‚ûï</span> Instructions & Tips
  </button>
  <div class="instructions-box" id="instructionsBox" style="display:none;">
    <ul>
      <li>üîç <b>You can search for your current location and destination</b> by typing in the respective search boxes or refresh page to fetch coordinates.</li>
      <li>üåç <b>You can select your destination on the map</b> by toggling the map and <b>double-clicking</b> (desktop) or <b>tapping once</b> (mobile) on the map.</li>
      <li>üß≥+üë• Tick the "Extras" checkbox if you have luggage or additional people (adds a 50% surcharge).</li>
      <li>üó∫ Click "Calculate Route" to see the fare, distance, and route on the map.</li>
      <li>üì§ Click "Submit Ride" to send your ride request.</li>
    </ul>
  </div>

  <div class="card">
    <label for="userType">You are a:</label>
    <select id="userType" onchange="updateUserType()">
      <option value="customer">Customer</option>
      <option value="driver">Driver</option>
    </select>

    <div id="customerPhoneGroup">
      <label for="customerPhone">Phone Number:</label>
      <input type="text" id="customerPhone" placeholder="Enter your phone number">
      <div class="field-reminder" id="reminder-customerPhone"></div>
    </div>

    <div id="driverGroup" style="display:none;">
      <label for="driverSelect">Select Driver:</label>
      <select id="driverSelect" onchange="displayDriverDetails()">
        <option value="">-- Select Driver --</option>
      </select>
      <div class="field-reminder" id="reminder-driverName"></div>
      <div class="driver-details" id="driverDetails" style="display:none;"></div>
    </div>

    <div class="input-group">
      <label for="from">From:</label>
      <input type="text" id="from" placeholder="Start typing origin...">
      <div class="autocomplete-suggestions" id="fromSuggestions"></div>
      <div class="field-reminder" id="reminder-from"></div>
    </div>

    <div class="input-group">
      <label for="to">To:</label>
      <input type="text" id="to" placeholder="Start typing destination...">
      <div class="autocomplete-suggestions" id="toSuggestions"></div>
      <div class="field-reminder" id="reminder-to"></div>
    </div>

    <div class="checkbox-group">
      <label>
        <input type="checkbox" id="extra"> Includes Luggage or Extra Passenger
      </label>
    </div>

    <div class="result" id="fareResult"></div>
    <div class="result" id="details"></div>

    <div class="button-group">
      <button class="cancel-btn" id="cancelBtn" type="button" onclick="cancelRide()">Cancel Ride</button>
      <button class="submit-btn" id="submitBtn" type="button" onclick="submitRide()">Submit Ride</button>
    </div>
    <div class="loader" id="loader"><div></div></div>
    <div class="cancel-message" id="cancelMessage"></div>
    <div class="submit-message" id="submitMessage"></div>
    <div class="error-message" id="errorMessage"></div>
  </div>
</div>

<script>
  // Use the new provided Google Apps Script Web App URL
  const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbyXsFAuKlId6lbjSWzfrVoV-o8vgYxFiMiivw9v_WUv9r2ejay5prrDaSuFNSYYYEbj/exec';

  function toggleInstructions() {
    const box = document.getElementById("instructionsBox");
    const btnIcon = document.getElementById("instructionsBtnIcon");
    if (box.style.display === "none") {
      box.style.display = "block";
      btnIcon.textContent = "‚ûñ";
    } else {
      box.style.display = "none";
      btnIcon.textContent = "‚ûï";
    }
  }

  const drivers = [
    {
      name: "John Banda",
      phone: "0977001122",
      vehicleType: "Toyota Corolla",
      color: "White",
      registration: "ALC 1234"
    },
    {
      name: "Mary Zulu",
      phone: "0966123456",
      vehicleType: "Nissan Note",
      color: "Blue",
      registration: "BAL 4321"
    },
    {
      name: "James Phiri",
      phone: "0955789123",
      vehicleType: "Toyota Noah",
      color: "Silver",
      registration: "ABX 9876"
    }
  ];

  const landmarks = [
    { name: "Luangwa Bus Station", distance: 0 },
    { name: "Luangwa Market", distance: 0.5 },
    { name: "Luangwa District Hospital", distance: 1 },
    { name: "Luangwa Police Station", distance: 1 },
    { name: "Luangwa Post Office", distance: 1 },
    { name: "Luangwa District Council", distance: 1 },
    { name: "Luangwa District Education Office", distance: 1.2 },
    { name: "Luangwa Basic School", distance: 1.3 },
    { name: "Luangwa Secondary School", distance: 1.5 },
    { name: "Luangwa Filling Station", distance: 1.5 },
    { name: "Luangwa Guest House", distance: 0.8 },
    { name: "Chimutengo Primary School", distance: 5 },
    { name: "Janeiro Basic School", distance: 10 },
    { name: "Chiriwe Basic School", distance: 15 },
    { name: "Kavalamanja Clinic", distance: 15 },
    { name: "Mpazangwe Village", distance: 16 },
    { name: "Mwalilia Basic School", distance: 18 },
    { name: "Mpuka Village", distance: 19 },
    { name: "Mwavi Primary School", distance: 20 },
    { name: "Mwavi Secondary School", distance: 20 },
    { name: "Kaunga Basic School", distance: 25 },
    { name: "Kapoche Village", distance: 23 },
    { name: "Redcliff Lodge", distance: 27.7 },
    { name: "Kakaro Basic School", distance: 31.5 },
    { name: "Kakaroo Heritage Site", distance: 31.5 },
    { name: "Katondwe Primary School", distance: 33.6 },
    { name: "Katondwe Girls Secondary School", distance: 33.6 },
    { name: "Katondwe Mission Hospital", distance: 33.6 },
    { name: "Nchinkwo Village", distance: 49 },
    { name: "Chula Island Camp", distance: 48.1 },
    { name: "Mburuma Village", distance: 52 },
    { name: "Mwavi Village", distance: 53 },
    { name: "Lower Zambezi National Park", distance: 53.7 },
    { name: "Kasinsa Village", distance: 58 },
    { name: "Luangwa Bridge", distance: 100 },
    { name: "Luangwa Bridge Market", distance: 100 },
    { name: "Luangwa Bridge Bus Station", distance: 100 },
    { name: "Boma Clinic", distance: 2 },
    { name: "Luangwa High School", distance: 2.2 }
  ];

  const baseFarePer3km = 20;
  const avgSpeedKmh = 30;

  const fromInput = document.getElementById("from");
  const toInput = document.getElementById("to");
  const fromSuggestions = document.getElementById("fromSuggestions");
  const toSuggestions = document.getElementById("toSuggestions");

  function setupAutocomplete(input, suggestionsBox, callback) {
    input.addEventListener("input", () => {
      const query = input.value.toLowerCase();
      suggestionsBox.innerHTML = "";
      if (!query) return;
      const matches = landmarks.filter(l => l.name.toLowerCase().includes(query));
      matches.forEach(match => {
        const div = document.createElement("div");
        div.className = "autocomplete-suggestion";
        div.textContent = `${match.name} (${match.distance} km)`;
        div.addEventListener("click", () => {
          input.value = match.name;
          suggestionsBox.innerHTML = "";
          callback();
        });
        suggestionsBox.appendChild(div);
      });
    });
  }

  setupAutocomplete(fromInput, fromSuggestions, calculateFare);
  setupAutocomplete(toInput, toSuggestions, calculateFare);
  document.getElementById("extra").addEventListener("change", calculateFare);

  function calculateFare() {
    const from = landmarks.find(l => l.name === fromInput.value);
    const to = landmarks.find(l => l.name === toInput.value);
    if (!from || !to) {
      document.getElementById("fareResult").textContent = "";
      document.getElementById("details").textContent = "";
      return;
    }
    const distance = Math.abs(to.distance - from.distance);
    let fare = Math.ceil(distance / 3) * baseFarePer3km;
    if (document.getElementById("extra").checked) {
      fare += baseFarePer3km / 2;
    }
    const time = (distance / avgSpeedKmh) * 60;
    document.getElementById("fareResult").innerText = `Estimated Fare: K${fare.toFixed(2)}`;
    document.getElementById("details").innerText = `Distance: ${distance.toFixed(1)} km | Estimated Time: ${time.toFixed(0)} mins`;
  }

  function updateUserType() {
    const userType = document.getElementById("userType").value;
    hideFieldReminder("reminder-customerPhone");
    hideFieldReminder("reminder-driverName");
    if (userType === "driver") {
      document.getElementById("driverGroup").style.display = "block";
      document.getElementById("customerPhoneGroup").style.display = "none";
    } else {
      document.getElementById("driverGroup").style.display = "none";
      document.getElementById("customerPhoneGroup").style.display = "block";
      document.getElementById("driverDetails").style.display = "none";
    }
  }

  function displayDriverDetails() {
    const selectedIndex = document.getElementById("driverSelect").selectedIndex - 1;
    const detailsBox = document.getElementById("driverDetails");
    if (selectedIndex >= 0) {
      const d = drivers[selectedIndex];
      detailsBox.innerHTML = `
        <strong>Phone:</strong> ${d.phone}<br>
        <strong>Vehicle:</strong> ${d.vehicleType}<br>
        <strong>Color:</strong> ${d.color}<br>
        <strong>Registration:</strong> ${d.registration}
      `;
      detailsBox.style.display = "block";
    } else {
      detailsBox.style.display = "none";
    }
  }

  function showFieldReminder(fieldId, message) {
    const el = document.getElementById(fieldId);
    if (el) {
      el.textContent = message;
      el.style.display = "block";
    }
  }
  function hideFieldReminder(fieldId) {
    const el = document.getElementById(fieldId);
    if (el) {
      el.textContent = "";
      el.style.display = "none";
    }
  }
  function hideAllFieldReminders() {
    hideFieldReminder("reminder-customerPhone");
    hideFieldReminder("reminder-driverName");
    hideFieldReminder("reminder-from");
    hideFieldReminder("reminder-to");
  }

  function cancelRide() {
    document.getElementById("customerPhone").value = "";
    document.getElementById("userType").value = "customer";
    document.getElementById("from").value = "";
    document.getElementById("to").value = "";
    document.getElementById("extra").checked = false;
    document.getElementById("driverSelect").selectedIndex = 0;
    document.getElementById("driverDetails").style.display = "none";
    document.getElementById("fareResult").textContent = "";
    document.getElementById("details").textContent = "";
    document.getElementById("fromSuggestions").innerHTML = "";
    document.getElementById("toSuggestions").innerHTML = "";
    updateUserType();
    document.getElementById("submitMessage").style.display = "none";
    document.getElementById("errorMessage").style.display = "none";
    hideAllFieldReminders();
    const cancelMsg = document.getElementById("cancelMessage");
    cancelMsg.textContent = "Ride cancelled. All entries have been cleared.";
    cancelMsg.style.display = "block";
    setTimeout(() => {
      cancelMsg.style.display = "none";
    }, 2500);
  }

  function submitRide() {
    document.getElementById("cancelMessage").style.display = "none";
    document.getElementById("errorMessage").style.display = "none";
    document.getElementById("submitMessage").style.display = "none";
    hideAllFieldReminders();

    let hasError = false;
    const userType = document.getElementById("userType").value;
    const customerPhone = document.getElementById("customerPhone").value.trim();
    const driverIdx = document.getElementById("driverSelect").selectedIndex - 1;
    const driverName = driverIdx >= 0 ? drivers[driverIdx].name : "";
    const from = document.getElementById("from").value.trim();
    const to = document.getElementById("to").value.trim();
    const extra = document.getElementById("extra").checked ? "Yes" : "No";
    const fare = document.getElementById("fareResult").innerText.replace("Estimated Fare: ","").replace("K","");
    const details = document.getElementById("details").innerText;

    if (!from) {
      showFieldReminder("reminder-from", "Please select your origin.");
      hasError = true;
    }
    if (!to) {
      showFieldReminder("reminder-to", "Please select your destination.");
      hasError = true;
    }
    if (userType === "customer" && !customerPhone) {
      showFieldReminder("reminder-customerPhone", "Please enter your phone number.");
      hasError = true;
    }
    if (userType === "driver" && !driverName) {
      showFieldReminder("reminder-driverName", "Please select a driver.");
      hasError = true;
    }
    const fromObj = landmarks.find(l => l.name === from);
    const toObj = landmarks.find(l => l.name === to);
    if (from && !fromObj) {
      showFieldReminder("reminder-from", "Origin not recognized. Choose from the list.");
      hasError = true;
    }
    if (to && !toObj) {
      showFieldReminder("reminder-to", "Destination not recognized. Choose from the list.");
      hasError = true;
    }
    if (hasError) {
      showError("Please complete all highlighted fields before submitting.");
      return;
    }

    const postData = {
      userType,
      customerPhone,
      driverName,
      from,
      to,
      extra,
      fare,
      details
    };

    document.getElementById("loader").style.display = "block";
    document.getElementById("submitBtn").disabled = true;
    document.getElementById("cancelBtn").disabled = true;

    fetch(GOOGLE_SHEETS_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(postData)
    })
    .then(() => {
      document.getElementById("loader").style.display = "none";
      document.getElementById("submitBtn").disabled = false;
      document.getElementById("cancelBtn").disabled = false;
      showSuccess("Ride submitted successfully!");
      cancelRide();
    })
    .catch(() => {
      document.getElementById("loader").style.display = "none";
      document.getElementById("submitBtn").disabled = false;
      document.getElementById("cancelBtn").disabled = false;
      showError("Submission failed. Please try again.");
    });
  }

  function showSuccess(msg) {
    const submitMsg = document.getElementById("submitMessage");
    submitMsg.textContent = msg;
    submitMsg.style.display = "block";
    setTimeout(() => { submitMsg.style.display = "none"; }, 4000);
  }
  function showError(msg) {
    const errorMsg = document.getElementById("errorMessage");
    errorMsg.textContent = msg;
    errorMsg.style.display = "block";
    setTimeout(() => { errorMsg.style.display = "none"; }, 4000);
  }

  const driverSelect = document.getElementById("driverSelect");
  drivers.forEach(driver => {
    const option = document.createElement("option");
    option.textContent = driver.name;
    driverSelect.appendChild(option);
  });

  updateUserType();
</script>

</body>
</html>
