<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luangwa Feira Rides | Book a Ride</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary-color: #2563eb;
      --secondary-color: #ff9900;
      --error-color: #dc2626;
      --success-color: #16a34a;
      --bg-color-body: #f5f5f5;
      --bg-color-card: #ffffff;
      --border-color-light: #e0e0e0;
      --font-color-dark: #333;
    }
    body { font-family: 'Roboto', Arial, sans-serif; background-color: var(--bg-color-body); color: var(--font-color-dark); }

    header { background: var(--font-color-dark); color: white; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .header-content { max-width: 1200px; margin: auto; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; position: relative; }
    .company-info h2 { font-size: 1.1rem; color: var(--secondary-color); }

.menu-dropdown-container { 
    position: relative; 
    display: inline-block; 
}

.menu-button { 
    background: none; 
    border: none; 
    color: white; 
    cursor: pointer; 
    padding: 5px; 
    outline: none; 
    font-size: 1.2rem; 
    display: flex;
    align-items: center;
}

.menu-dropdown {
    display: none;
    position: absolute;
    right: 0;
    top: 40px;
    background-color: white;
    width: 290px;
    max-height: 85vh; 
    overflow-y: auto;
    box-shadow: 0px 8px 24px rgba(0,0,0,0.25);
    z-index: 1000;
    border-radius: 12px;
    color: #333;
    padding: 16px;
    border: 1px solid #e0e0e0;
}

.menu-dropdown.show { 
    display: block; 
}

.dropdown-content-section { 
    margin-bottom: 20px; 
}

.dropdown-content-section h4 { 
    color: #2563eb; 
    border-bottom: 1px solid #f0f0f0; 
    padding-bottom: 6px; 
    margin-bottom: 10px; 
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
}

.dropdown-content-section p { 
    font-size: 0.85rem; 
    line-height: 1.5; 
    margin-bottom: 10px; 
    color: #4b5563; 
}

.dropdown-content-section a {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    text-decoration: none;
    color: #1f2937;
    font-size: 0.9rem;
    border-radius: 8px;
    transition: background 0.2s ease;
    margin-bottom: 2px;
}

.dropdown-content-section a:hover { 
    background-color: #f3f4f6; 
}

.dropdown-content-section a i { 
    width: 20px; 
    color: #2563eb; 
    text-align: center; 
    font-size: 1.1rem;
}

.contact-label-text {
    display: flex;
    flex-direction: column;
}

.contact-detail-hidden { 
    display: none; 
}

.menu-divider { 
    height: 1px; 
    background: #e5e7eb; 
    margin: 12px 0; 
}

    .tooltip-container { position: relative; display: inline-flex; align-items: center; cursor: pointer; margin-left: 6px; vertical-align: middle; }
    .tooltip-icon { font-size: 18px !important; color: var(--primary-color); }
    .tooltip-text { 
      visibility: hidden; 
      width: 160px; 
      background-color: #333; 
      color: #fff; 
      text-align: center; 
      border-radius: 6px; 
      padding: 8px; 
      position: absolute; 
      z-index: 9999; 
      bottom: 125%; 
      left: 50%; 
      margin-left: -80px; 
      opacity: 0; 
      transition: opacity 0.3s; 
      font-size: 0.7rem; 
      font-weight: normal; 
      line-height: 1.3;
      pointer-events: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

    .product-container { max-width: 500px; margin: 15px auto; padding: 0 10px; }
    .booking-container { background: var(--bg-color-card); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 15px; }
    fieldset { border: 1px solid var(--border-color-light); border-radius: 10px; padding: 12px; background: #fafafa; margin-bottom: 15px; width: 100%; transition: 0.3s; }
    legend { font-weight: bold; color: var(--primary-color); padding: 0 8px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
    .input-box { background: white; border: 1.5px solid var(--border-color-light); border-radius: 8px; padding: 10px; transition: 0.3s; position: relative; display: flex; align-items: center; width: 100%; }
    .input-box .material-icons { color: var(--primary-color); font-size: 20px; margin-right: 10px; }
    .input-box input { flex: 1; border: none; outline: none; font-size: 1rem; font-weight: bold; background: transparent; width: 100%; }
    input::placeholder { font-size: 0.8rem; font-style: italic; color: #999; font-weight: normal; }
    .mode-option { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .mode-option .material-icons { font-size: 24px; color: var(--primary-color); }
    .field-error { border: 2px solid var(--error-color) !important; background: #fff5f5 !important; animation: shake 0.4s ease-in-out; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }
    .autocomplete-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; z-index: 100; max-height: 150px; overflow-y: auto; border-radius: 0 0 8px 8px; }
    .suggestion { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    .suggestion:hover { background: #f0f7ff; }
    .summary-card { background: white; border: 1px solid var(--border-color-light); border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .submit-btn { background: var(--primary-color); color: white; width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.3s; position: relative; }
    .btn-loader { width: 28px; height: 28px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    .hidden-section { display: none; }
    .calc-loader { width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid var(--secondary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 15px auto; display: none; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
<header>
  <div class="header-content">
    <div class="company-info">
      <h2>Luangwa Feira Rides</h2>
    </div>

    <div class="menu-dropdown-container">
      <button id="menu-toggle-btn" class="menu-button" onclick="toggleDropdown()" title="Menu">
        <i class="fas fa-ellipsis-v"></i>
      </button>

      <div id="header-menu-dropdown" class="menu-dropdown">
        <div class="dropdown-content-section">
          <h4><i class="fas fa-info-circle"></i> About Our Service</h4>
          <p><strong>Location:</strong> Dedicated service provider within the Luangwa Feira area and surrounding locations in Zambia. ðŸ‡¿ðŸ‡²</p>
          <p><strong>Affordable:</strong> Pricing is <strong>cheap and fixed as shown</strong>, calculated fairly based on distance.</p>
          <p><strong>Reliable:</strong> We are committed to <strong>reliable and safe transport</strong>, ensuring you reach your destination efficiently.</p>
          <p><strong>Stations:</strong> Luangwa Bus Station, Chitope, Luangwa Market Bridge, and more hubs near you will be added.</p>
        </div>

        <div class="dropdown-content-section">
          <h4><i class="fas fa-headset"></i> Quick Contact</h4>
          <p style="margin-bottom: 8px;"><strong>For inquiries or collaborations, contact us:</strong></p>
          
          <a href="tel:0966423229" title="Call Now">
            <i class="fas fa-phone"></i>
            <span class="contact-label-text">
              Call Us <span class="contact-detail-hidden">0966423229</span>
            </span>
          </a>
          
          <a href="https://wa.me/260966423229" target="_blank" title="Chat on WhatsApp">
            <i class="fab fa-whatsapp"></i>
            <span class="contact-label-text">
              WhatsApp Us <span class="contact-detail-hidden">+260966423229</span>
            </span>
          </a>
          
          <a href="sms:0966423229" title="Send SMS">
            <i class="fas fa-sms"></i>
            <span class="contact-label-text">
              Send SMS <span class="contact-detail-hidden">0966423229</span>
            </span>
          </a>
          
          <a href="mailto:zamlisting@gmail.com" title="Send Email">
            <i class="fas fa-envelope"></i>
            <span class="contact-label-text">
              Email Us <span class="contact-detail-hidden">zamlisting@gmail.com</span>
            </span>
          </a>

          <div class="menu-divider"></div>

          <a href="https://www.facebook.com/profile.php?id=61581247756569" target="_blank" title="Visit Facebook">
            <i class="fab fa-facebook"></i>
            <span class="contact-label-text">Facebook Page</span>
          </a>
          
          <a href="https://www.tiktok.com/@luagwa_feira_rides" target="_blank" title="Visit TikTok">
            <i class="fab fa-tiktok"></i>
            <span class="contact-label-text">TikTok</span>
          </a>
          
          <p style="margin-top: 15px; text-align: center; font-size: 0.75rem; color: #aaa;">&copy; 2024 Luangwa Feira Rides.</p>
        </div>
      </div>
    </div>
  </div>
</header>

  <main class="product-container">
    <div class="booking-container">
      <fieldset>
        <legend><span class="material-icons">account_circle</span> Phone Number</legend>
        <div class="input-box" id="phone-box">
          <span class="material-icons">phone</span>
          <input type="tel" id="customer-phone" maxlength="10" placeholder="e.g. 0966..." inputmode="numeric">
        </div>
      </fieldset>

      <div id="trip-details" class="hidden-section">
        <fieldset id="mode-fieldset">
          <legend><span class="material-icons">commute</span> Transport Mode</legend>
          <div id="mode-group" style="display:flex; justify-content:space-around; padding:10px 0;">
            <label class="mode-option">
              <input type="radio" name="mode" value="motorbike">
              <span class="material-icons">motorcycle</span>
              <small>Motorbike</small>
            </label>
            <label class="mode-option">
              <input type="radio" name="mode" value="vehicle">
              <span class="material-icons">directions_car</span>
              <small>Vehicle</small>
            </label>
          </div>
        </fieldset>

        <fieldset id="route-fieldset">
          <legend>Route</legend>
          <div class="input-box" id="origin-container" style="margin-bottom:12px;">
            <span class="material-icons">my_location</span>
            <input type="text" id="gm-origin" placeholder="Where should we pick you up?" autocomplete="off">
            <div id="originList" class="autocomplete-list"></div>
          </div>
          <div class="input-box" id="dest-container">
            <span class="material-icons">pin_drop</span>
            <input type="text" id="gm-destination" placeholder="Where are you going?" autocomplete="off">
            <div id="destinationList" class="autocomplete-list"></div>
          </div>
        </fieldset>
      </div>

      <div id="summary-section" class="hidden-section">
        <fieldset>
          <legend>
            <span class="material-icons">receipt_long</span> Trip Summary
            <span class="tooltip-container">
              <span class="material-icons tooltip-icon">help_outline</span>
              <span class="tooltip-text" id="hub-tooltip">Calculated via nearest hub</span>
            </span>
          </legend>
          <div id="summary-cards"></div>
        </fieldset>
        <div style="display:flex; flex-direction:column; align-items:center; margin-top:20px;">
          <button class="submit-btn" id="submit-btn">
            <i class="fas fa-paper-plane" id="btn-icon"></i>
            <div class="btn-loader" id="btn-loader"></div>
          </button>
          <p id="action-label" style="margin-top:8px; font-weight:bold; color:var(--primary-color);">Request Now</p>
        </div>
      </div>

      <div class="calc-loader" id="spinner"></div>
      <p id="status" style="text-align:center; margin-top:10px; font-weight:bold; min-height:1.2em;"></p>
    </div>
  </main>

  <script>
    function toggleDropdown() {
      const menu = document.getElementById("header-menu-dropdown");
      menu.classList.toggle("show");
    }

    window.onclick = function(event) {
      const menu = document.getElementById("header-menu-dropdown");
      const btn = document.getElementById("menu-toggle-btn");
      if (menu && menu.classList.contains('show')) {
        if (!menu.contains(event.target) && !btn.contains(event.target)) {
          menu.classList.remove('show');
        }
      }
    }

    const config = {
      vehiclePricePerKm: 3.00,
      motorbikePricePerKm: 1.02,
      vehicleMinPrice: 20,
      motorbikeMinPrice: 10,
      vehicleExtra: 6.00,      
      motorbikeExtra: 2.04,    
      avgSpeed: 60
    };

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxpvhvgnjkRcZmuly7uNzPeAC5OwVUq8-qUJ2WXrOqOnSsNgCn0ZHbuz6BGslW83_rB5Q/exec";
    const places = ["Anglican Church", "Airstrip", "Big 2 Zambezi Water Front Resort & Safari", "BM Residence", "Boma Clinic", "Chidada Ground", "Car Wash Pub", "Chitope", "Chitope Rural Health Centre", "Chilombwe Community School", "Chiriwe Primary School", "Dzalo Skills Training Centre Kambolozo", "Feira Kindom Hall", "Feira Day Secondary School", "Gerasmos Safari Lodge", "Hill View", "JB Three Boarders Mall", "JB Three Boarders Club", "Justifeli Lodge", "Kakaro Primary School", "Kakaro Liberation Heritage Site", "Kantuleni Executive Lodge", "Kapoche", "Kaunga Secondary School", "Kasinsa", "Katondwe Chapel", "Katondwe Chaz Hotel", "Katondwe Dam", "Katondwe Girls Secondary School", "Katondwe Mission Hospital", "Katondwe Primary School", "Kavalamanja", "Luangwa (Feira)", "Luangwa Basic School", "Luangwa Bridge", "Luangwa Bridge Market", "Luangwa Bus Station", "Luangwa Council Lodge", "Luangwa DC Office", "Luangwa DEBS Offices", "Luangwa District Hospital", "Luangwa High School Police Post", "Boma Filling Station", "Luangwa Habour", "Indeco Building", "Luangwa Market", "Luangwa Main SDA Church", "Mburuma Local Court", "Luangwa Police Station", "Luangwa Post Office", "Luangwa Town Council", "Luangwa Secondary School", "Makichilo Lodge", "Mwavi Secondary School", "Mwalila Primary School", "Nyabota Lodge", "Passover Living Lamb Ministry Katondwe", "Pentecostal Assembly of God Joshua Assembly", "UCZ", "Soweto Junction", "Registration Office", "River Spot Club","SDA Katondwe", "Yangoma Lodge", "Yellow Shop", "ZESCO Office"];
    const segments = [{ from: 'Kakaro Primary School', to: 'Kapoche', distance: 16 }, { from: 'Kapoche', to: 'Luangwa Secondary School', distance: 21 }, { from: 'Luangwa Secondary School', to: 'Katondwe Mission Hospital', distance: 5 }, { from: 'Katondwe Mission Hospital', to: 'Mburuma Local Court', distance: 7 }, { from: 'Mburuma Local Court', to: 'Mwavi Secondary School', distance: 0.65 }, { from: 'Mburuma Local Court', to: 'Katondwe Mission Hospital', distance: 7.8 }, { from: 'Mwavi Secondary School', to: 'Chitope Rural Health Centre', distance: 2 }, { from: 'Chitope Rural Health Centre', to: 'Mwalila Primary School', distance: 6 }, { from: 'Mwalila Primary School', to: 'Kaunga Secondary School', distance: 5 }, { from: 'Kaunga Secondary School', to: 'Luangwa Bridge Market', distance: 14 }, { from: 'Luangwa Bridge Market', to: 'Luangwa Bridge', distance: 3 }, { from: "Luangwa District Hospital", to: "Soweto Junction", distance: 2.5 }, { from: "Car Wash Pub", to: "Luangwa Town Council", distance: 1.00 }, { from: "Car Wash Pub", to: "Soweto Junction", distance: 2.75 }, { from: "Car Wash Pub", to: "BM Residence", distance: 1.00 }, { from: "Soweto Junction", to: "Airstrip", distance: 1.7 }, { from: "Soweto Junction", to: "ZESCO Office", distance: 0.3 }, { from: "Kakaro Primary School", to: "Luangwa District Hospital", distance: 7.1 }, { from: "ZESCO Office", to: "Luangwa Main SDA Church", distance: 0.65 }, { from: "Luangwa Main SDA Church", to: "Indeco Building", distance: 0.7 }, { from: "Indeco Building", to: "JB Three Boarders Club", distance: 0.1 }, { from: "JB Three Boarders Club", to: "Yellow Shop", distance: 0.45 }, { from: "Yellow Shop", to: "Luangwa Bus Station", distance: 0.19 }, { from: "Luangwa Bus Station", to: "JB Three Boarders Mall", distance: 0.24 }, { from: "JB Three Boarders Mall", to: "Boma Filling Station", distance: 0.35 }, { from: "Boma Filling Station", to: "Kantuleni Executive Lodge", distance: 0.19 }, { from: "Kantuleni Executive Lodge", to: "Luangwa Habour", distance: 0.09 }, { from: "Kantuleni Executive Lodge", to: "Luangwa Council Lodge", distance: 0.09 }, { from: "Luangwa Council Lodge", to: "Luangwa DC Office", distance: 0.3 }, { from: "Luangwa DC Office", to: "Luangwa Police Station", distance: 0.3 }, { from: "Luangwa Police Station", to: "Luangwa DEBS Offices", distance: 0.1 }, { from: "Luangwa DEBS Offices", to: "Yangoma Lodge", distance: 0.4 }, { from: "Yangoma Lodge", to: "Boma Clinic", distance: 0.5 }, { from: "JB Three Boarders Mall", to: "Nyabota Lodge", distance: 0.25 }, { from: "Nyabota Lodge", to: "Luangwa Basic School", distance: 0.18 }, { from: "JB Three Boarders Mall", to: "River Spot Club", distance: 0.03 }, { from: "Luangwa Bus Station", to: "Luangwa Town Council", distance: 2.16 }, { from: "Luangwa Town Council", to: "Registration Office", distance: 0.49 }, { from: "Luangwa Town Council", to: "Dzalo Skills Training Centre Kambolozo", distance: 0.60 }, { from: "Luangwa Town Council", to: "Big 2 Zambezi Water Front Resort & Safari", distance: 3.2 }, { from: "Big 2 Zambezi Water Front Resort & Safari", to: "Chilombwe Community School", distance: 9.8 }, { from: "Registration Office", to: "Chidada Ground", distance: 0.49 }, { from: "Chidada Ground", to: "Yangoma Lodge", distance: 2.34 }, { from: "Luangwa Town Council", to: "Hill View", distance: 0.40 }, { from: "Hill View", to: "BM Residence", distance: 1.00 }, { from: "BM Residence", to: "Feira Day Secondary School", distance: 1.10 }, { from: "Feira Kindom Hall", to: "Anglican Church", distance: 0.08 }, { from: "Feira Kindom Hall", to: "Luangwa (Feira)", distance: 0.7 }, { from: "Luangwa (Feira)", to: "Luangwa Bus Station", distance: 0.1 }, { from: "Dzalo Skills Training Centre Kambolozo", to: "Justifeli Lodge", distance: 0.26 }, { from: "Luangwa Market", to: "Makichilo Lodge", distance: 0.4 }, { from: "Makichilo Lodge", to: "Gerasmos Safari Lodge", distance: 0.3 }, { from: "Makichilo Lodge", to: "UCZ", distance: 0.5 }, { from: "Luangwa Bus Station", to: "Luangwa Market", distance: 0.02 }, { from: "UCZ", to: "Pentecostal Assembly of God Joshua Assembly", distance: 0.08 }, { from: "Chitope", to: "Kasinsa", distance: 10.0 }, { from: "Chitope", to: "Mwavi Secondary School", distance: 1.1 }, { from: "Kasinsa", to: "Luangwa Secondary School", distance: 14.0 }, { from: "Luangwa High School Police Post", to: "Chiriwe Primary School", distance: 2.1 }, { from: "Luangwa Secondary School", to: "Luangwa High School Police Post", distance: 0.8 }, { from: "Kapoche", to: "Chiriwe Primary School", distance: 19.7 }, { from: "Luangwa High School Police Post", to: "SDA Katondwe", distance: 1.0 }, { from: "Katondwe Mission Hospital", to: "Katondwe Primary School", distance: 0.55 }, { from: "Katondwe Chapel", to: "Katondwe Primary School", distance: 0.05 }, { from: "Katondwe Primary School", to: "Katondwe Girls Secondary School", distance: 0.0 }, { from: "Katondwe Girls Secondary School", to: "Katondwe Chaz Hotel", distance: 0.45 }, { from: "Katondwe Chaz Hotel", to: "Passover Living Lamb Ministry Katondwe", distance: 0.4 }, { from: "Passover Living Lamb Ministry Katondwe", to: "Katondwe Dam", distance: 0.1 }, { from: "Kakaro Primary School", to: "Kakaro Liberation Heritage Site", distance: 1.2 }, { from: "Kavalamanja", to: "Luangwa District Hospital", distance: 23.0 }];

    const hubs = ["Luangwa Bus Station", "Chitope", "Luangwa Bridge Market"];
    const graph = {};
    segments.forEach(({ from, to, distance }) => {
      if (!graph[from]) graph[from] = []; if (!graph[to]) graph[to] = [];
      graph[from].push({ node: to, distance }); graph[to].push({ node: from, distance }); 
    });

    function findShortestDistance(start, end) { 
      if (start === end) return 0; if (!graph[start] || !graph[end]) return null;
      const distances = {}; const unvisited = new Set(Object.keys(graph));
      for (const node of unvisited) distances[node] = Infinity;
      distances[start] = 0;
      while (unvisited.size) {
        let current = null; for (const node of unvisited) { if (current === null || distances[node] < distances[current]) current = node; }
        if (current === null || distances[current] === Infinity) break; 
        if (current === end) return distances[end]; unvisited.delete(current);
        for (const neighbor of graph[current]) {
          const newDist = distances[current] + neighbor.distance;
          if (newDist < distances[neighbor.node]) distances[neighbor.node] = newDist;
        }
      }
      return null;
    }

    function calculateTotalDistance(pickup, destination) {
      if (pickup === destination) return { total: 0, trip: 0, hub: 'N/A' };
      let nearestHub = null, minD1 = Infinity;
      for (const hub of hubs) {
        const d = findShortestDistance(pickup, hub);
        if (d !== null && d < minD1) { minD1 = d; nearestHub = hub; }
      }
      if (!nearestHub) return { total: null, trip: null, hub: null };
      const d2 = findShortestDistance(pickup, destination);
      const d3 = findShortestDistance(destination, nearestHub);
      if (d2 === null || d3 === null) return { total: null, trip: null, hub: nearestHub };
      return { total: minD1 + d2 + d3, trip: d2, hub: nearestHub };
    }

    let rideData = null;
    const phoneInput = document.getElementById('customer-phone');
    const tripDiv = document.getElementById('trip-details');
    const summaryDiv = document.getElementById('summary-section');
    const statusText = document.getElementById('status');
    const submitBtn = document.getElementById('submit-btn');
    const btnIcon = document.getElementById('btn-icon');
    const btnLoader = document.getElementById('btn-loader');

    phoneInput.oninput = () => { 
      if (/^0[0-9]{9}$/.test(phoneInput.value)) {
        tripDiv.style.display = 'block'; 
      }
    };

    function setupAuto(inputId, containerId, listId) {
      const input = document.getElementById(inputId);
      const container = document.getElementById(containerId);
      const list = document.getElementById(listId);
      input.oninput = () => {
        const val = input.value.toLowerCase(); list.innerHTML = ''; container.classList.remove('field-error'); statusText.textContent = ""; 
        if (!val) return;
        places.filter(p => p.toLowerCase().includes(val)).forEach(p => {
          const d = document.createElement('div'); d.className = 'suggestion'; d.textContent = p;
          d.onclick = () => { input.value = p; list.innerHTML = ''; checkReady(); };
          list.appendChild(d);
        });
      };
      input.onblur = () => { setTimeout(() => { if (input.value && !places.includes(input.value)) { container.classList.add('field-error'); statusText.textContent = "âš ï¸ Select from list."; summaryDiv.style.display = 'none'; } }, 250); };
    }

    function checkReady() {
      const from = document.getElementById('gm-origin').value; const to = document.getElementById('gm-destination').value;
      const mode = document.querySelector('input[name="mode"]:checked');
      if (places.includes(from) && places.includes(to)) {
        if (!mode) { statusText.textContent = "Select Mode."; }
        else { statusText.textContent = ""; calculate(from, to, mode.value); }
      }
    }

    function calculate(from, to, mode) {
      document.getElementById('spinner').style.display = 'block'; summaryDiv.style.display = 'none';
      setTimeout(() => {
        document.getElementById('spinner').style.display = 'none';
        const res = calculateTotalDistance(from, to);
        if (res.total === null) { statusText.textContent = "Route error."; return; }
        summaryDiv.style.display = 'block';
        document.getElementById('hub-tooltip').textContent = "Price calculated via: " + res.hub;

        let rate, minPrice, extra;
        if (mode === 'vehicle') {
          rate = config.vehiclePricePerKm; minPrice = config.vehicleMinPrice; extra = config.vehicleExtra;
        } else {
          rate = config.motorbikePricePerKm; minPrice = config.motorbikeMinPrice; extra = config.motorbikeExtra;
        }

        let price = Math.max(minPrice, Math.ceil((res.total * rate) + extra));
        document.getElementById('summary-cards').innerHTML = `<div class="summary-card"><span>Price</span><span style="color:var(--secondary-color); font-weight:bold;">K${price}</span></div><div class="summary-card"><span>Trip Distance</span><span>${res.trip.toFixed(2)} km</span></div>`;
        
        rideData = { preferredMode: mode, phone: phoneInput.value, hub: res.hub, from, to, tripDistance: res.trip.toFixed(2), totalDistance: res.total.toFixed(2), price: price };
        
        // Reset button state
        submitBtn.style.background = "var(--primary-color)"; 
        btnIcon.className = "fas fa-paper-plane"; 
        btnIcon.style.display = "block"; 
        btnLoader.style.display = "none"; 
        document.getElementById('action-label').textContent = "Request Now";
        submitBtn.onclick = handleRequest;
      }, 600);
    }

    async function handleRequest() {
      submitBtn.disabled = true; btnIcon.style.display = "none"; btnLoader.style.display = "block";
      const payload = { ...rideData, timestamp: new Date().toLocaleString() };
      
      try {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: new URLSearchParams(payload) });
        statusText.textContent = "Sent! Call dispatcher."; statusText.style.color = "var(--success-color)";
        
        // TRANSITION TO CALL
        btnLoader.style.display = "none"; 
        btnIcon.style.display = "block"; 
        btnIcon.className = "fas fa-phone"; 
        submitBtn.style.background = "var(--success-color)"; 
        submitBtn.disabled = false; 
        document.getElementById('action-label').textContent = "Call Now";
        
        submitBtn.onclick = function() { window.location.href = "tel:0966423229"; };
      } catch (err) { 
        statusText.textContent = "Error. Please call directly."; 
        submitBtn.disabled = false; 
        btnLoader.style.display = "none"; 
        btnIcon.style.display = "block"; 
      }
    }

    setupAuto('gm-origin', 'origin-container', 'originList');
    setupAuto('gm-destination', 'dest-container', 'destinationList');
    document.getElementById('mode-group').onchange = checkReady;
  </script>
</body>
</html>
