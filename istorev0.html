<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luangwa Delivery Platform - Transport Cart</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #2e7d32;
      --primary-dark: #1b5e20;
      --primary-light: #81c784;
      --accent: #ff9800;
      --text: #333;
      --text-light: #666;
      --background: #f5f5f5;
      --card-bg: white;
      --border: #e0e0e0;
      --shadow: 0 0 8px rgba(0,0,0,0.5);
      --success: #e8f5e9;
      --error: #ffebee;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; color: var(--text); background-color: var(--background); line-height: 1.5; }
    header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 1.5rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    header h1 { font-weight: normal; font-size: 1.8rem; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; display: flex; flex-wrap: wrap; gap: 2rem; }
    .slider-wrapper { position: relative; flex: 2; min-width: 300px; background: var(--card-bg); border-radius: 10px; padding: 1.5rem; box-shadow: var(--shadow); }
    .section-title { font-size: 1.3rem; margin-bottom: 1rem; color: var(--primary-dark); display: flex; align-items: center; gap: 0.5rem; }
    .section-title i { color: var(--primary); }
    .thumbnail-slider { display: flex; overflow-x: auto; scroll-behavior: smooth; gap: 1.5rem; padding: 1rem 0; margin: 0 -0.5rem; }
    .thumbnail-slider::-webkit-scrollbar { height: 6px; }
    .thumbnail-slider::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .thumbnail-slider::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 10px; }
    .product { flex: 0 0 160px; border: 1px solid var(--border); border-radius: 10px; padding: 1rem; text-align: center; background: var(--card-bg); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
    .product:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .product img { width: 100px; height: 100px; object-fit: cover; margin-bottom: 0.8rem; border-radius: 4px; }
    .product h4 { font-size: 1rem; margin-bottom: 0.5rem; color: var(--text); }
    .product p { color: var(--primary-dark); font-weight: 600; margin-bottom: 0.8rem; }
    .product button { border: none; background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-family: inherit; font-weight: 500; transition: background 0.2s; }
    .product button:hover { background: var(--primary-dark); }
    .slider-button { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: background-color 0.2s; }
    .slider-button:hover { background: rgba(0,0,0,0.8); }
    .slider-button.prev { left: 0; }
    .slider-button.next { right: 0; }
    .cart { border: 1px solid var(--border); padding: 1.5rem 1.3rem 1.7rem 1.3rem; border-radius: 10px; flex: 1; min-width: 300px; background: var(--card-bg); position: sticky; top: 1rem; box-shadow: var(--shadow); margin-bottom: 2em;}
    .cart-items { list-style: none; padding: 0; margin: 0 0 1.5rem; max-height: 300px; overflow-y: auto; }
    .cart-items li { padding: 0.8rem 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .cart-items li:last-child { border-bottom: none; }
    .cart-total { margin: 1rem 0; padding-top: 1rem; border-top: 1px solid var(--border); color: var(--text-dark); }
    .cart-total p { margin: 0.5rem 0; }
    .address-input, .phone-input { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 5px; font-family: inherit; font-size: 0.9rem; transition: border-color 0.2s; }
    .address-input:focus, .phone-input:focus { outline: none; border-color: var(--primary); }
    .btn { border: none; background: var(--primary); color: white; padding: 0.8rem 1.2rem; border-radius: 4px; cursor: pointer; font-family: inherit; font-weight: 500; width: 100%; transition: background 0.2s, opacity 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .btn:hover { background: var(--primary-dark); }
    .btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.6; }
    .btn-accent { background: var(--accent); }
    .btn-accent:hover { background: #e68a00; }
    .btn-secondary { background: var(--primary-light); margin-top: 0.5rem; }
    .btn-secondary:hover { background: var(--primary); }
    .btn-success { background: var(--primary-dark); }
    .status-message {
      display: none;
      margin: 1rem 0;
      padding: 0.75rem;
      border-radius: 4px;
      text-align: center;
      font-weight: 500;
    }
    .status-message.success { background: var(--success); color: var(--primary-dark); }
    .status-message.error { background: var(--error); color: #c62828; }
    #searchBox {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1rem;
      box-sizing: border-box;
    }
    .hidden-input {
      opacity: 0;
      position: absolute;
      pointer-events: none;
      height: 0;
      width: 0;
    }
    .autocomplete-suggestions {
      border: 1px solid #ccc;
      background: #fff;
      max-height: 130px;
      overflow-y: auto;
      position: absolute;
      width: calc(100% - 2px);
      z-index: 999;
      border-radius: 0 0 7px 7px;
      left: 0;
      top: 100%;
      margin-top: -5px;
      font-size: 1em;
    }
    .autocomplete-suggestion {
      padding: 8px 14px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .autocomplete-suggestion:last-child { border-bottom: none; }
    .autocomplete-suggestion:hover, .autocomplete-selected {
      background: #e5efff;
    }
    .form-autocomplete-group { position: relative; }
    .input-group {
      position: relative;
      background: #f5f7fa;
      border-radius: 7px;
      padding: 16px 14px 8px 48px;
      box-shadow: 0 1px 3px #2563eb11;
      display: flex;
      flex-direction: column;
      justify-content: center;
      width: 100%;
      min-width: 0;
      box-sizing: border-box;
      margin-bottom: 1em;
      align-self: flex-end;
    }
    .input-group label {
      font-weight: 500;
      color: #2563eb;
      font-size: 13px;
      margin-bottom: 2px;
      letter-spacing: .1em;
    }
    .input-group .material-icons.input-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #2563eb;
      font-size: 25px;
      opacity: 0.85;
    }

    /* Cart inputs flexbox alignment */
    .cart-inputs-flex {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      margin-bottom: 1.2em;
      flex-wrap: wrap;
    }
    .cart-inputs-flex .input-group, .cart-inputs-flex .mode-container {
      min-width: 160px;
      flex: 1 1 160px;
      margin-bottom: 0 !important;
    }
    .cart-inputs-flex .mode-container {
      flex: 0 0 62px;
      min-width: 56px;
      max-width: 70px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-end;
      padding: 0;
      background: none;
      box-shadow: none;
      margin: 0;
    }
    .cart-inputs-flex .mode-container label {
      font-size: 13px;
      margin-bottom: 2px;
      margin-top: 5px;
      color: #2563eb;
      font-weight: 500;
      letter-spacing: .1em;
      margin-left: 3px;
    }
    .cart-inputs-flex .mode-group {
      display: flex;
      align-items: center;
      gap: 0;
      margin: 0;
    }
    .cart-inputs-flex .mode-radio {
      border: 1.5px solid #e5e7eb !important;
      background: #f8fafc !important;
      color: #2563eb;
      cursor: pointer;
      font-size: 16px;
      transition: border 0.2s;
      display: flex;
      align-items: center;
      gap: 2px;
      font-weight: 500;
      min-width: 0 !important;
      padding: 6px 8px 6px 6px !important;
      border-radius: 5px 0 0 5px !important;
      border-right: 0;
      box-shadow: none;
      margin: 0;
    }
    .cart-inputs-flex .mode-radio.selected {
      border: 2px solid #2563eb !important;
      background: #f0f6ff !important;
      z-index: 1;
    }
    .cart-inputs-flex .mode-radio:last-child {
      border-radius: 0 5px 5px 0 !important;
      border-right: 1.5px solid #e5e7eb !important;
      margin-left: -1px;
    }
    .cart-inputs-flex .mode-radio input[type="radio"] {
      accent-color: #2563eb;
      margin-right: 1px;
      margin-left: 0;
      width: 16px;
      height: 16px;
    }
    .cart-inputs-flex .mode-radio span.material-icons {
      font-size: 20px !important;
      margin: 0 2px 0 0;
      vertical-align: middle;
    }

    @media (max-width: 900px) {
      .cart-inputs-flex {
        flex-wrap: wrap;
        gap: 6px;
      }
      .cart-inputs-flex .input-group,
      .cart-inputs-flex .mode-container {
        min-width: 130px;
        flex: 1 1 130px;
      }
    }

    @media (max-width: 650px) {
      .cart-inputs-flex {
        flex-direction: column;
        gap: 0.2em;
        align-items: stretch;
      }
      .cart-inputs-flex .input-group,
      .cart-inputs-flex .mode-container {
        max-width: unset;
        min-width: 0;
        flex: unset;
      }
    }

    .map-btn-row {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 0.5em;
      margin-top: -8px;
    }
    #google-map-frame {
      width: 100%;
      height: 250px;
      border: none;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(66,133,244,0.10);
      background: #f1f5f9;
      margin: 10px 0 18px 0;
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-truck"></i> Luangwa Delivery Platform (Transport Cart)</h1>
  </header>
  <div class="container">
    <div class="slider-wrapper">
      <h2 class="section-title"><i class="fas fa-store"></i> Available Products</h2>
      <input type="text" id="searchBox" placeholder="Search products...">
      <button class="slider-button prev" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
      <div id="product-list" class="thumbnail-slider"></div>
      <button class="slider-button next" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
    </div>
    <div class="cart">
      <h2 class="section-title"><i class="fas fa-shopping-cart"></i> Your Order</h2>
      <ul id="cart-items" class="cart-items"></ul>
      <div id="empty-cart" class="empty-cart">
        <i class="fas fa-cart-arrow-down"></i>
        <p>Your cart is empty.</p>
        <p>Add items to get started.</p>
      </div>
      <div id="cart-total" class="cart-total" style="display:none;">
        <p>Products Total: ZK <span id="products-total">0.00</span></p>
        <p id="transportation-line" style="display:none;">Transportation: <span id="transport-icon">ðŸš—</span> <span id="transportation-cost">0.00</span></p>
        <p><strong>Total: ZK <span id="grand-total">0.00</span></strong></p>
      </div>
      <input id="pickup" type="text" class="hidden-input" value="Luangwa Bus station" readonly>

      <!-- Neatly aligned input row -->
      <div class="cart-inputs-flex">
        <div class="mode-container">
          <label for="mode-of-transport">Mode</label>
          <div class="mode-group" id="mode-group">
            <label class="mode-radio" id="radio-vehicle">
              <input type="radio" name="mode" value="vehicle" id="mode-vehicle" onchange="handleModeChange();handleCustomerPhoneInput();">
              <span class="material-icons">directions_car</span>
            </label>
            <label class="mode-radio" id="radio-motorbike">
              <input type="radio" name="mode" value="motorbike" id="mode-motorbike" onchange="handleModeChange();handleCustomerPhoneInput();">
              <span class="material-icons">two_wheeler</span>
            </label>
          </div>
        </div>
        <div class="input-group">
          <span class="material-icons input-icon">place</span>
          <label for="gm-origin">From</label>
          <input type="text" id="gm-origin" class="address-input" value="Luangwa Bus station" autocomplete="off" placeholder="Enter starting point">
          <div id="gm-origin-list" class="autocomplete-suggestions"></div>
        </div>
        <div class="input-group">
          <span class="material-icons input-icon">flag</span>
          <label for="gm-destination">To</label>
          <input type="text" id="gm-destination" class="address-input" autocomplete="off" placeholder="Enter destination">
          <div id="gm-destination-list" class="autocomplete-suggestions"></div>
        </div>
        <div class="input-group" id="customer-phone-wrapper-flex" style="display:none;">
          <span class="material-icons input-icon">phone</span>
          <label for="customer-phone">Phone</label>
          <input
            type="tel"
            id="customer-phone"
            maxlength="10"
            pattern="^09[7-9][0-9]{7}$"
            placeholder="e.g. 0978167546"
            autocomplete="off"
            inputmode="numeric"
          >
        </div>
        <div class="input-group">
          <span class="material-icons input-icon">straighten</span>
          <label for="distance-input">Distance (km)</label>
          <input
            type="number"
            id="distance-input"
            class="address-input"
            min="0"
            step="0.01"
            placeholder="Auto/Manual"
            autocomplete="off"
          >
        </div>
      </div>

      <!-- Map toggle is below the input row -->
      <div class="map-btn-row">
        <button type="button" id="toggle-map-btn" class="btn btn-secondary" style="width: auto; min-width: 100px;">
          <span class="material-icons">map</span> <span id="map-btn-text">Show Map</span>
        </button>
      </div>
      <iframe id="google-map-frame" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>

      <!-- Old phone input-group hidden, since it's in the row above -->
      <div class="input-group" id="customer-phone-wrapper" style="display:none;">
        <span class="material-icons input-icon">phone</span>
        <label for="customer-phone">Phone Number</label>
        <input
          type="tel"
          id="customer-phone-dummy"
          style="display:none"
        >
      </div>
      <button id="checkout-btn" class="btn btn-accent" style="margin-top: 1rem; display:none;">
        <i class="fas fa-credit-card"></i> Proceed to Checkout
      </button>
      <div id="checkout-status" class="status-message"></div>
      <div id="loader" style="display:none;"><i class="fas fa-spinner fa-spin"></i> Processing...</div>
      <div id="statusMessage" class="status-message"></div>
    </div>
  </div>
  <script>
    // --- FULL PLACES LIST ---
    const luangwaLandmarks = {
      "Luangwa Bus Station": 0,
      "Luangwa Indeco":0.9,"Luangwa Market":0.5,"Luangwa District Hospital":4.6,"Luangwa Police Station":0.55,"Luangwa Post Office":1.1,
      "Luangwa District Comission office":1.1,"Luangwa District Education Office":0.6,"Makichilo lodge":1.1,"UCZ lodge":1.2,"Luangwa Habour":0.5,
      "Yangoma Hotel":0.8,"Anglican Church":1.2,"BM residence":2.7,"Simon Njobvu Place,Soweto":3.1,"Big 2 water Resorts":4.7,
      "Gerasnos Lodge lodge":1.3,"Luangwa Basic School":0.45,"Luangwa Feira Day Secondary School":3.7,"Luangwa High School":48,
      "Luangwa High School Police post":48.8,"Luangwa Filling Station":1.5,"Luangwa Council lodge":0.65,"CSchool":5,"JSchool":10,
      "Chiriwe Basic School":46.7,"K Clinic":15,"Me":16,"MBSchool":18,"Mp":19,"Mwavi Primary School":55,"Mwavi Secondary School":60,
      "Kaunga Basic School":25,"Kapoche Village":27.4,"Redcliff Lodge":27.7,"Kakaro Basic School":12.1,"Kakaroo Heritage Site":11.1,
      "Katondwe Primary School":50.4,"Katondwe Girls Secondary School":51.3,"Katondwe Mission Hospital":53.2,"Katondwe SDA churches":49.8,
      "Katondwe  Chappel":53.5,"Nc":49,"C":48.1,"Mb":52,"Mwavi Village":60,"Luangwa Air ":3.8,"K":58,"Luangwa Bridge":100,
      "Luangwa Bridge Market":87.3,"Luangwa Bridge Station":90,"Boma Clinic":2,"Dzalo Skills Training Centre kambolozo":1.8,"Luangwa Town Council":2.1
    };
    const luangwaPlaces = Object.keys(luangwaLandmarks);

    function setupAutocomplete(inputId, suggestionsId, sourceList) {
      const input = document.getElementById(inputId);
      const suggestionsBox = document.getElementById(suggestionsId);
      input.addEventListener("input", function() {
        const query = input.value.trim().toLowerCase();
        suggestionsBox.innerHTML = "";
        if (!query) {
          suggestionsBox.style.display = "none";
          return;
        }
        const matches = sourceList.filter(
          name => name.toLowerCase().includes(query)
        ).slice(0, 10);
        if (matches.length === 0) {
          suggestionsBox.style.display = "none";
          return;
        }
        matches.forEach(name => {
          const div = document.createElement("div");
          div.className = "autocomplete-suggestion";
          div.innerText = name;
          div.onclick = function() {
            input.value = name;
            suggestionsBox.innerHTML = "";
            suggestionsBox.style.display = "none";
            updateCart();
          };
          suggestionsBox.appendChild(div);
        });
        suggestionsBox.style.display = "block";
      });
      input.addEventListener("blur", function() {
        setTimeout(() => { suggestionsBox.style.display = "none"; }, 150);
      });
      input.addEventListener("focus", function() {
        if (input.value.trim()) input.dispatchEvent(new Event("input"));
      });
    }
    setupAutocomplete("gm-origin", "gm-origin-list", luangwaPlaces);
    setupAutocomplete("gm-destination", "gm-destination-list", luangwaPlaces);

    // --- PRODUCTS ---
    const PRODUCTS = [
      { id: 1, name: "Mosi Beer", price: 25, image: "M.jpeg", category: "beverages" },
      { id: 2, name: "Castle Lager", price: 24, image: "CC.jpeg", category: "beverages" },
      { id: 100, name: "Black Label Big", price: 30, image: "BL.webp", category: "beverages" }
      // ... (rest of your product list here) ...
    ];

    const productListEl = document.getElementById('product-list');
    const cartItemsEl = document.getElementById('cart-items');
    const emptyCartEl = document.getElementById('empty-cart');
    const cartTotalEl = document.getElementById('cart-total');
    const productsTotalEl = document.getElementById('products-total');
    const transportationCostEl = document.getElementById('transportation-cost');
    const transportLineEl = document.getElementById('transportation-line');
    const transportIconEl = document.getElementById('transport-icon');
    const grandTotalEl = document.getElementById('grand-total');
    const checkoutBtn = document.getElementById('checkout-btn');
    const searchBox = document.getElementById('searchBox');
    const pickupEl = document.getElementById('pickup');
    const gmOriginEl = document.getElementById('gm-origin');
    const gmDestinationEl = document.getElementById('gm-destination');
    const mapBtn = document.getElementById('toggle-map-btn');
    const mapBtnText = document.getElementById('map-btn-text');
    const googleMapFrame = document.getElementById('google-map-frame');
    // Mode logic elements
    const modeVehicle = document.getElementById('mode-vehicle');
    const modeMotorbike = document.getElementById('mode-motorbike');
    const radioVehicle = document.getElementById('radio-vehicle');
    const radioMotorbike = document.getElementById('radio-motorbike');
    // For phone input in the row
    const customerPhoneWrapperFlex = document.getElementById('customer-phone-wrapper-flex');
    const customerPhoneInput = document.getElementById('customer-phone');
    // Old phone wrapper (hidden, but kept for compatibility)
    const customerPhoneWrapper = document.getElementById('customer-phone-wrapper');
    // For distance input
    const distanceInput = document.getElementById('distance-input');

    let cart = [];
    let transportationCost = 0;
    let transportMode = 'vehicle'; // default
    const TRANSPORT_COST_PER3KM = { vehicle: 20, motorbike: 10 };
    const TRANSPORT_ICON = { vehicle: "ðŸš—", motorbike: "ðŸï¸" };
    const DEFAULT_PICKUP = 'Luangwa Bus station';
    let filteredProducts = PRODUCTS.slice();

    // --- Mode selection logic ---
    function handleModeChange() {
      const v = modeVehicle.checked;
      const m = modeMotorbike.checked;
      radioVehicle.classList.toggle('selected', v);
      radioMotorbike.classList.toggle('selected', m);
      transportMode = v ? 'vehicle' : (m ? 'motorbike' : 'vehicle');
      updateCart();
      handleCustomerPhoneInput();
    }
    function handleCustomerPhoneInput() {
      const v = modeVehicle.checked;
      const m = modeMotorbike.checked;
      // Show phone input in row if mode selected, else hide
      if (v || m) {
        customerPhoneWrapperFlex.style.display = "";
      } else {
        customerPhoneWrapperFlex.style.display = "none";
        customerPhoneInput.value = "";
      }
      // Hide old phone input always (in case old logic tries to show it)
      customerPhoneWrapper.style.display = "none";
    }
    modeVehicle.addEventListener('change', handleModeChange);
    modeMotorbike.addEventListener('change', handleModeChange);

    document.addEventListener('DOMContentLoaded', () => {
      modeVehicle.checked = true;
      handleModeChange();
      renderProducts();
      updateCart();
    });

    searchBox.addEventListener('input', function() {
      const query = this.value.trim().toLowerCase();
      filteredProducts = PRODUCTS.filter(p => 
        p.name.toLowerCase().includes(query) ||
        (p.category && p.category.toLowerCase().includes(query))
      );
      renderProducts();
    });

    function showMessage(message, type = "error") {
      const s = document.getElementById("statusMessage");
      s.textContent = message;
      s.className   = `status-message ${type}`;
      s.style.display = "block";
      setTimeout(() => s.style.display = "none", 5000);
    }

    // Always use the distance input for cost calculation if present.
    // Otherwise, auto-calculate from From/To.
    // Motorbike: K10 per 3km, Vehicle: K20 per 3km (rounded up)
    function calcTransportationCost() {
      const from = gmOriginEl.value.trim();
      const to   = gmDestinationEl.value.trim();
      let distance = parseFloat(distanceInput.value);

      if (!isNaN(distance) && distance > 0) {
        const rate = TRANSPORT_COST_PER3KM[transportMode];
        return Math.ceil(distance / 3) * rate;
      }

      // fallback: auto-calc from landmarks
      if (from && to && luangwaLandmarks.hasOwnProperty(from) && luangwaLandmarks.hasOwnProperty(to)) {
        distance = Math.abs(luangwaLandmarks[from] - luangwaLandmarks[to]);
        if (!isNaN(distance) && distance > 0) {
          const rate = TRANSPORT_COST_PER3KM[transportMode];
          return Math.ceil(distance / 3) * rate;
        }
      }
      return 0;
    }

    function renderProducts() {
      productListEl.innerHTML = '';
      filteredProducts.forEach(p => {
        const div = document.createElement('div');
        div.className = 'product';
        div.innerHTML = `
          <img src="${p.image}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/100?text=Error';">
          <h4>${p.name}</h4>
          <p>ZK ${p.price.toFixed(2)}</p>
          <button data-id="${p.id}">
            <i class="fas fa-plus"></i> Add
          </button>
        `;
        productListEl.appendChild(div);
      });
    }
    document.getElementById('prevBtn').onclick = () => productListEl.scrollBy({ left: -200, behavior: 'smooth' });
    document.getElementById('nextBtn').onclick = () => productListEl.scrollBy({ left: 200, behavior: 'smooth' });
    productListEl.addEventListener('click', e => {
      const button = e.target.closest('button');
      if (button && button.dataset.id) {
        const id = parseInt(button.dataset.id, 10);
        addToCart(id);
      }
    });
    function addToCart(id) {
      const product = PRODUCTS.find(x => x.id === id);
      if (product) {
        const cartItem = cart.find(item => item.product.id === id);
        if (cartItem) { cartItem.quantity += 1; }
        else { cart.push({ product, quantity: 1 }); }
        updateCart();
        const btn = document.querySelector(`button[data-id="${id}"]`);
        if (btn) {
          btn.innerHTML = '<i class="fas fa-check"></i> Added';
          btn.style.backgroundColor = 'var(--primary-dark)';
          setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-plus"></i> Add';
            btn.style.backgroundColor = '';
          }, 1000);
        }
      } else { showMessage('Product not found.'); }
    }
    function updateCart() {
      transportationCost = calcTransportationCost();
      if (cart.length === 0) {
        cartItemsEl.innerHTML = '';
        emptyCartEl.style.display = 'block';
        cartTotalEl.style.display = 'none';
        checkoutBtn.style.display = 'none';
      } else {
        emptyCartEl.style.display = 'none';
        cartTotalEl.style.display = 'block';
        checkoutBtn.style.display = 'block';
        cartItemsEl.innerHTML = '';
        cart.forEach((item, index) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <span>${item.product.name} (x${item.quantity})</span>
            <div>
              <span>ZK ${(item.product.price * item.quantity).toFixed(2)}</span>
              <div class="quantity-controls">
                <button class="quantity-btn decrease" data-index="${index}">-</button>
                <button class="quantity-btn increase" data-index="${index}">+</button>
                <button class="remove-btn" data-index="${index}">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          `;
          cartItemsEl.appendChild(li);
        });
        const productsTotal = cart.reduce((sum, item) => sum + item.product.price * item.quantity, 0);
        productsTotalEl.textContent = productsTotal.toFixed(2);
        const grandTotal = productsTotal + transportationCost;
        grandTotalEl.textContent = grandTotal.toFixed(2);
        if (transportationCost > 0) {
          transportationCostEl.textContent = transportationCost.toFixed(2);
          transportLineEl.style.display = 'block';
        } else { transportLineEl.style.display = 'none'; }
        transportIconEl.textContent = TRANSPORT_ICON[transportMode];
      }
    }
    cartItemsEl.addEventListener('click', e => {
      const button = e.target.closest('button');
      if (!button) return;
      const index = parseInt(button.dataset.index, 10);
      if (button.classList.contains('remove-btn')) { cart.splice(index, 1); }
      else if (button.classList.contains('increase')) { cart[index].quantity += 1; }
      else if (button.classList.contains('decrease')) {
        cart[index].quantity -= 1;
        if (cart[index].quantity === 0) cart.splice(index, 1);
      }
      updateCart();
    });
    gmOriginEl.addEventListener('input', updateCart);
    gmDestinationEl.addEventListener('input', updateCart);
    distanceInput.addEventListener('input', updateCart);

    // Toggle Map logic
    mapBtn.addEventListener('click', function() {
      const from = gmOriginEl.value.trim();
      const to = gmDestinationEl.value.trim();
      if (!from || !to) {
        alert("Please enter both origin (From) and destination (To).");
        return;
      }
      if (googleMapFrame.style.display === "block") {
        googleMapFrame.style.display = "none";
        mapBtnText.textContent = "Show Map";
      } else {
        const embedUrl = "https://www.google.com/maps?q=" +
          encodeURIComponent(from + " to " + to) +
          "&output=embed";
        googleMapFrame.src = embedUrl;
        googleMapFrame.style.display = "block";
        googleMapFrame.scrollIntoView({behavior:"smooth"});
        mapBtnText.textContent = "Hide Map";
      }
    });

    // --- SUBMISSION LOGIC ---
    function submitOrder() {
      if (cart.length === 0) {
        showMessage('Your cart is empty. Please add items before checkout.');
        return;
      }
      const from = gmOriginEl.value.trim();
      const to = gmDestinationEl.value.trim();
      if (!from || !to) {
        showMessage('Please enter both origin (From) and destination (To) before checkout.');
        return;
      }
      const v = modeVehicle.checked;
      const m = modeMotorbike.checked;
      if (!v && !m) {
        showMessage('Please select a mode of transport.');
        return;
      }
      const phone = customerPhoneInput.value.trim();
      if (!phone.match(/^09[7-9][0-9]{7}$/)) {
        showMessage('Please enter a valid phone number (e.g., 0978167546).');
        return;
      }
      let distance = parseFloat(distanceInput.value);
      if (isNaN(distance) || distance <= 0) {
        // fallback to computed
        if (luangwaLandmarks.hasOwnProperty(from) && luangwaLandmarks.hasOwnProperty(to)) {
          distance = Math.abs(luangwaLandmarks[from] - luangwaLandmarks[to]);
        } else {
          distance = '';
        }
      }
      const loader = document.getElementById("loader");
      loader.style.display = "block";
      const productsTotal = parseFloat(productsTotalEl.textContent);
      const grandTotal = parseFloat(grandTotalEl.textContent);
      const data = {
        from               : from,
        to                 : to,
        phoneNumber        : phone,
        distance           : distance,
        productsTotal      : productsTotal,
        transportationCost : transportationCost,
        transportMode      : v ? "Vehicle" : "Motorbike",
        grandTotal         : grandTotal,
        items              : cart.map(item => item.product.name + " x" + item.quantity).join(", "),
        Date               : ""
      };
      const formBody = Object.keys(data)
        .map(k => encodeURIComponent(k) + "=" + encodeURIComponent(data[k]))
        .join("&");
      fetch('https://script.google.com/macros/s/AKfycbx7R-M0nKEafAfvKnCbDq5r-m7TtQ466eNTA5SwjvTFqQKCbmT4rY8sTFZEzCtwQ9a3/exec', {
        method : 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body   : formBody
      })
      .then(r => r.json())
      .then(j => {
        loader.style.display = "none";
        if (j.status === 'success' || j.result === 'success' || (j.result && j.result.indexOf('success') !== -1)) {
          showMessage('Order confirmed! Delivery details sent.', "success");
          alert('Order confirmed! Delivery details will be sent to you.');
          cart = [];
          updateCart();
          customerPhoneInput.value = '';
          gmOriginEl.value = '';
          gmDestinationEl.value = '';
          distanceInput.value = '';
          googleMapFrame.style.display = "none";
          mapBtnText.textContent = "Show Map";
        } else {
          showMessage(j.message || "Submission failed", "error");
        }
      })
      .catch(e => {
        loader.style.display = "none";
        showMessage("Submission failed", "error");
        console.error(e);
      });
    }
    checkoutBtn.onclick = submitOrder;
  </script>
</body>
</html>
