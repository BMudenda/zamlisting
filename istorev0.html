<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luangwa Delivery Platform - Transport Cart</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #2e7d32;
      --primary-dark: #1b5e20;
      --primary-light: #81c784;
      --accent: #ff9800;
      --text: #222;
      --text-light: #666;
      --background: #f5f5f5;
      --card-bg: white;
      --border: #e0e0e0;
      --shadow: 0 0 8px rgba(0,0,0,0.05);
      --success: #e8f5e9;
      --error: #ffebee;
      --toast-bg: #333;
      --toast-success: #43a047;
      --toast-error: #c62828;
      --danger: #c62828;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; color: var(--text); background-color: var(--background); line-height: 1.5; }
    header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 2.2rem 1rem 1.6rem 1rem; text-align: center; box-shadow: 0 2px 7px rgba(0,0,0,0.09); }
    header h1 { font-weight: bold; font-size: 2.1rem; letter-spacing: 0.02em; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; display: flex; flex-wrap: wrap; gap: 2rem; }
    .slider-wrapper { position: relative; flex: 2; min-width: 300px; background: var(--card-bg); border-radius: 10px; padding: 1.7rem 1.5rem; box-shadow: var(--shadow); }
    .section-title { font-size: 1.35rem; margin-bottom: 1.1rem; color: var(--primary-dark); display: flex; align-items: center; gap: 0.5rem; font-weight: 600;}
    .section-title i { color: var(--primary); }
    .thumbnail-slider { display: flex; overflow-x: auto; scroll-behavior: smooth; gap: 1.5rem; padding: 1rem 0; margin: 0 -0.5rem; }
    .thumbnail-slider::-webkit-scrollbar { height: 6px; }
    .thumbnail-slider::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .thumbnail-slider::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 10px; }
    .product { flex: 0 0 160px; border: 1px solid var(--border); border-radius: 10px; padding: 1.1rem 0.7rem; text-align: center; background: var(--card-bg); transition: transform 0.2s, box-shadow 0.2s; margin-bottom: 0.5rem;}
    .product:active, .product:hover { transform: translateY(-7px) scale(1.04); box-shadow: 0 7px 22px rgba(0,0,0,0.13); }
    .product img { width: 100px; height: 100px; object-fit: cover; margin-bottom: 0.8rem; border-radius: 4px; border: 1px solid #eee;}
    .product h4 { font-size: 1rem; margin-bottom: 0.53rem; color: var(--text); }
    .product p { color: var(--primary-dark); font-weight: 600; margin-bottom: 0.8rem; }
    .product button { border: none; background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-family: inherit; font-weight: 500; transition: background 0.2s;}
    .product button:disabled,
    .product .out-stock { background: #ccc !important; cursor: not-allowed; }
    .product .out-stock { display: block; color: #b71c1c; font-size: 0.97em; font-weight: 600; margin-bottom: 0.7em; }
    .slider-button { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 2;}
    .slider-button:hover { background: rgba(0,0,0,0.8); }
    .slider-button.prev { left: 0; }
    .slider-button.next { right: 0; }
    .cart { border: 1px solid var(--border); padding: 1.7rem 1.3rem 2.1rem 1.3rem; border-radius: 10px; flex: 1; min-width: 300px; background: var(--card-bg); position: sticky; top: 1rem; box-shadow: var(--shadow);}
    .cart-items { list-style: none; padding: 0; margin: 0 0 1.5rem; max-height: 320px; overflow-y: auto; }
    .cart-items li { padding: 0.8rem 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 0.2em; animation: fadein 0.33s; min-height: 54px;}
    .cart-items li:last-child { border-bottom: none; }
    .cart-thumb { width: 36px; height: 36px; object-fit: cover; border-radius: 4px; margin-right: 8px; vertical-align: middle; border: 1.5px solid #e5e7eb;}
    .cart-item-info { display: flex; align-items: center; flex: 1; min-width: 0;}
    .cart-item-title { font-weight: 500; font-size: 1.04em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .cart-item-qty { width: 44px; font-size: 1em; margin: 0 6px; padding: 2px 6px; border-radius: 4px; border: 1px solid #ddd; text-align: center;}
    .cart-price-block { display: flex; align-items: center; gap: 4px;}
    .quantity-controls { display: flex; align-items: center; gap: 2px;}
    .quantity-btn, .remove-btn { border: none; background: none; color: var(--primary-dark); font-size: 1.1em; margin: 0 2px; cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: background 0.2s;}
    .quantity-btn:active, .remove-btn:active { background: #f1f1f1;}
    .remove-btn { color: var(--danger);}
    .undo-toast { background: var(--accent); color: #222; padding: 8px 20px; border-radius: 7px; position: fixed; left: 50%; bottom: 25px; transform: translateX(-50%); z-index: 999; font-size: 1.05em;}
    .undo-btn { background: var(--primary); color: #fff; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-weight: 500;}
    .cart-total { margin: 1rem 0; padding-top: 1rem; border-top: 1px solid var(--border);}
    .cart-total p { margin: 0.5rem 0; }
    .address-input, .phone-input { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 5px; font-family: inherit; font-size: 0.93rem; transition: border 0.2s;}
    .address-input:focus, .phone-input:focus { outline: none; border-color: var(--primary); }
    .btn { border: none; background: var(--primary); color: white; padding: 0.8rem 1.2rem; border-radius: 4px; cursor: pointer; font-family: inherit; font-weight: 500; width: 100%; transition: background 0.2s;}
    .btn:hover { background: var(--primary-dark);}
    .btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.6; }
    .btn-accent { background: var(--accent);}
    .btn-accent:hover { background: #e68a00; }
    .btn-secondary { background: var(--primary-light); margin-top: 0.5rem; color: var(--primary-dark);}
    .btn-secondary:hover { background: var(--primary); color: #fff;}
    .btn-success { background: var(--primary-dark);}
    .status-message {
      display: none;
      margin: 1.1rem 0 1.3rem 0;
      padding: 0.75rem;
      border-radius: 4px;
      text-align: center;
      font-weight: 500;
      font-size: 1.08em;
    }
    .status-message.success { background: var(--success); color: var(--primary-dark); }
    .status-message.error { background: var(--error); color: #c62828; }
    #searchBox {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 1.1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1.06rem;
      box-sizing: border-box;
    }
    .hidden-input { opacity: 0; position: absolute; pointer-events: none; height: 0; width: 0; }
    .autocomplete-suggestions {
      border: 1px solid #ccc;
      background: #fff;
      max-height: 130px;
      overflow-y: auto;
      position: absolute;
      width: calc(100% - 2px);
      z-index: 999;
      border-radius: 0 0 7px 7px;
      left: 0;
      top: 100%;
      margin-top: -5px;
      font-size: 1em;
    }
    .autocomplete-suggestion {
      padding: 8px 14px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .autocomplete-suggestion:last-child { border-bottom: none; }
    .autocomplete-suggestion:hover, .autocomplete-selected {
      background: #e5efff;
    }
    .form-autocomplete-group { position: relative; }
    .input-group {
      position: relative;
      background: #f5f7fa;
      border-radius: 7px;
      padding: 16px 14px 8px 48px;
      box-shadow: 0 1px 3px #2563eb11;
      display: flex;
      flex-direction: column;
      justify-content: center;
      width: 100%;
      min-width: 0;
      box-sizing: border-box;
      margin-bottom: 1em;
      align-self: flex-end;
    }
    .input-group label {
      font-weight: 500;
      color: #2563eb;
      font-size: 13px;
      margin-bottom: 2px;
      letter-spacing: .1em;
    }
    .input-group .material-icons.input-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #2563eb;
      font-size: 25px;
      opacity: 0.85;
    }
    .cart-inputs-flex {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      margin-bottom: 1.2em;
      flex-wrap: wrap;
    }
    .cart-inputs-flex .input-group, .cart-inputs-flex .mode-container {
      min-width: 160px;
      flex: 1 1 160px;
      margin-bottom: 0 !important;
    }
    .cart-inputs-flex .mode-container {
      flex: 0 0 62px;
      min-width: 56px;
      max-width: 70px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-end;
      padding: 0;
      background: none;
      box-shadow: none;
      margin: 0;
    }
    .cart-inputs-flex .mode-container label {
      font-size: 13px;
      margin-bottom: 2px;
      margin-top: 5px;
      color: #2563eb;
      font-weight: 500;
      letter-spacing: .1em;
      margin-left: 3px;
    }
    .cart-inputs-flex .mode-group {
      display: flex;
      align-items: center;
      gap: 0;
      margin: 0;
    }
    .cart-inputs-flex .mode-radio {
      border: 1.5px solid #e5e7eb !important;
      background: #f8fafc !important;
      color: #2563eb;
      cursor: pointer;
      font-size: 16px;
      transition: border 0.2s;
      display: flex;
      align-items: center;
      gap: 2px;
      font-weight: 500;
      min-width: 0 !important;
      padding: 6px 8px 6px 6px !important;
      border-radius: 5px 0 0 5px !important;
      border-right: 0;
      box-shadow: none;
      margin: 0;
    }
    .cart-inputs-flex .mode-radio.selected {
      border: 2px solid #2563eb !important;
      background: #f0f6ff !important;
      z-index: 1;
    }
    .cart-inputs-flex .mode-radio:last-child {
      border-radius: 0 5px 5px 0 !important;
      border-right: 1.5px solid #e5e7eb !important;
      margin-left: -1px;
    }
    .cart-inputs-flex .mode-radio input[type="radio"] {
      accent-color: #2563eb;
      margin-right: 1px;
      margin-left: 0;
      width: 16px;
      height: 16px;
    }
    .cart-inputs-flex .mode-radio span.material-icons {
      font-size: 20px !important;
      margin: 0 2px 0 0;
      vertical-align: middle;
    }
    @media (max-width: 900px) {
      .cart-inputs-flex { flex-wrap: wrap; gap: 6px;}
      .cart-inputs-flex .input-group, .cart-inputs-flex .mode-container { min-width: 130px; flex: 1 1 130px; }
    }
    @media (max-width: 650px) {
      .cart-inputs-flex { flex-direction: column; gap: 0.2em; align-items: stretch; }
      .cart-inputs-flex .input-group, .cart-inputs-flex .mode-container { max-width: unset; min-width: 0; flex: unset; }
      .cart { position: static; }
      .sticky-checkout { position: fixed !important; left: 0; right: 0; bottom: 0; width: 100vw; border-radius: 0; margin: 0; z-index: 999;}
    }
    .map-btn-row { display: flex; justify-content: flex-end; margin-bottom: 0.5em; margin-top: -8px;}
    #google-map-frame { width: 100%; height: 250px; border: none; border-radius: 10px; box-shadow: 0 2px 12px rgba(66,133,244,0.10); background: #f1f5f9; margin: 10px 0 18px 0; display: none;}
    .toast {
      position: fixed;
      left: 50%;
      top: 24px;
      transform: translateX(-50%);
      min-width: 190px;
      z-index: 9999;
      background: var(--toast-bg);
      color: #fff;
      padding: 13px 24px;
      border-radius: 7px;
      box-shadow: 0 2px 16px #0003;
      font-weight: 500;
      font-size: 1.07em;
      animation: fadein 0.2s;
    }
    .toast.success { background: var(--toast-success);}
    .toast.error { background: var(--toast-error);}
    @keyframes fadein {
      from { opacity: 0; transform: scale(0.95);}
      to   { opacity: 1; transform: scale(1);}
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: pointer;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 170px;
      background: #222c;
      color: #fff;
      text-align: left;
      border-radius: 4px;
      padding: 8px 11px;
      position: absolute;
      z-index: 1001;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 0.97em;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <header>
    <h1 aria-label="Luangwa Delivery Platform"><i class="fas fa-truck"></i> Luangwa Delivery Platform (Transport Cart)</h1>
  </header>
  <div class="container">
    <div class="slider-wrapper" aria-label="Available Products">
      <h2 class="section-title"><i class="fas fa-store"></i> Available Products</h2>
      <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
        <label for="categoryFilter" style="font-weight: 500;">Filter by Category:</label>
        <select id="categoryFilter" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;">
          <option value="all">All</option>
        </select>
      </div>
      <input type="text" id="searchBox" placeholder="Search products..." aria-label="Search products">
      <button class="slider-button prev" id="prevBtn" aria-label="Scroll left"><i class="fas fa-chevron-left"></i></button>
      <div id="product-list" class="thumbnail-slider"></div>
      <button class="slider-button next" id="nextBtn" aria-label="Scroll right"><i class="fas fa-chevron-right"></i></button>
    </div>
    <div class="cart" aria-label="Your Cart">
      <h2 class="section-title"><i class="fas fa-shopping-cart"></i> Your Order</h2>
      <ul id="cart-items" class="cart-items"></ul>
      <div id="empty-cart" class="empty-cart" aria-live="polite">
        <i class="fas fa-cart-arrow-down"></i>
        <p>Your cart is empty.</p>
        <p>Add items to get started.</p>
      </div>
      <div id="cart-total" class="cart-total" style="display:none;">
        <p>Products Total: ZK <span id="products-total">0.00</span></p>
        <p id="transportation-line" style="display:none;">Transportation: <span id="transport-icon">🚗</span> <span id="transportation-cost">0.00</span></p>
        <p><strong>Total: ZK <span id="grand-total">0.00</span></strong></p>
      </div>
      <input id="pickup" type="text" class="hidden-input" value="Luangwa Bus station" readonly>
      <div class="cart-inputs-flex">
        <div class="mode-container">
          <label for="mode-of-transport">Mode</label>
          <div class="mode-group" id="mode-group">
            <label class="mode-radio" id="radio-vehicle">
              <input type="radio" name="mode" value="vehicle" id="mode-vehicle" onchange="handleModeChange();handleCustomerPhoneInput();">
              <span class="material-icons">directions_car</span>
            </label>
            <label class="mode-radio" id="radio-motorbike">
              <input type="radio" name="mode" value="motorbike" id="mode-motorbike" onchange="handleModeChange();handleCustomerPhoneInput();">
              <span class="material-icons">two_wheeler</span>
            </label>
          </div>
        </div>
        <div class="input-group">
          <span class="material-icons input-icon">place</span>
          <label for="gm-origin">From</label>
          <input type="text" id="gm-origin" class="address-input" value="Luangwa Bus station" autocomplete="off" placeholder="Enter starting point">
          <div id="gm-origin-list" class="autocomplete-suggestions"></div>
        </div>
        <div class="input-group">
          <span class="material-icons input-icon">flag</span>
          <label for="gm-destination">To</label>
          <input type="text" id="gm-destination" class="address-input" autocomplete="off" placeholder="Enter destination">
          <div id="gm-destination-list" class="autocomplete-suggestions"></div>
        </div>
        <div class="input-group" id="customer-phone-wrapper-flex" style="display:none;">
          <span class="material-icons input-icon">phone</span>
          <label for="customer-phone">Phone</label>
          <input
            type="tel"
            id="customer-phone"
            maxlength="10"
            pattern="^0[0-9]{9}$"
            placeholder="e.g. 0978167546"
            autocomplete="off"
            inputmode="numeric"
            aria-label="Your phone number"
          >
        </div>
      </div>
      <div class="map-btn-row">
        <button type="button" id="toggle-map-btn" class="btn btn-secondary" style="width: auto; min-width: 100px;">
          <span class="material-icons">map</span> <span id="map-btn-text">Show Map</span>
        </button>
      </div>
      <iframe id="google-map-frame" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      <div class="input-group">
        <span class="material-icons input-icon">straighten</span>
        <label for="distance-input">Distance (km)
          <span class="tooltip" tabindex="0">
            <i class="fas fa-question-circle" style="color:#888;font-size:1em;"></i>
            <span class="tooltiptext">Enter delivery distance in kilometers if in metres please convert. (get from map accepted)</span>
          </span>
        </label>
        <input
          type="number"
          id="distance-input"
          class="address-input"
          min="0"
          step="0.01"
          placeholder="Get from map"
          autocomplete="off"
        >
      </div>
      <div class="input-group" id="customer-phone-wrapper" style="display:none;">
        <span class="material-icons input-icon">phone</span>
        <label for="customer-phone">Phone Number</label>
        <input type="tel" id="customer-phone-dummy" style="display:none">
      </div>
      <button id="checkout-btn" class="btn btn-accent sticky-checkout" style="margin-top: 1rem; display:none;">
        <i class="fas fa-credit-card"></i> Proceed to Checkout
      </button>
      <div id="checkout-status" class="status-message"></div>
      <div id="loader" style="display:none;"><i class="fas fa-spinner fa-spin"></i> Processing...</div>
      <div id="statusMessage" class="status-message"></div>
    </div>
  </div>
  <div id="toast-container"></div>
  <script>
    // --- PLACES DATA ---
    const luangwaPlaces = [
      "Lusaka", "Ndola", "Kitwe", "Luanshya", "Livingstone",
      "Chingola", "Kabwe", "Mufulira", "Chipata", "Solwezi",
      "Kasama", "Mazabuka", "Mansa", "Mongu", "Kalulushi",
      "Siavonga", "Choma", "Petauke", "Mpika", "Samfya",
      "Luangwa (Feira)", "Kavalamanja", "Katemo", "Chitope", "Kasinsa",
      "Chikwasha", "Mphuka", "Mphuka Central", "Chankungu", "Chilenga",
      "Chinzete", "Kapoche", "Chalwe", "Kalulu", "Kapiri (Luangwa)",
      "Kanyenye", "Mandombe", "Kawewa", "Chilimba", "Mwalimu (Luangwa)",
      "Kasisi (Luangwa)", "Kapuka", "Kasenga",
      "Chief Mphuka", "Chief Chitungulu", "Chief Mpuka",
      "Chief Zulu", "Chief Mburuma", "Chief Mwanya",
      "Luangwa Bridge", "Geramos Lodge Luangwa", "BM Residence Luangwa",
      "Luangwa Border Post", "Feira Confluence", "Feira Day Secondary",
      "Yangoma Lodge", "Luangwa District Hospital", "Luangwa Police Station",
      "Luangwa Post Office", "Luangwa District Council", "Luangwa District Education Office",
      "Luangwa Basic School", "Luangwa Secondary School", "Luangwa Filling Station",
      "Luangwa Guest House", "Boma Clinic", "Luangwa High School",
      "Luangwa Market", "Luangwa Bus Station", "Luangwa Bridge Market", "Luangwa Bridge Bus Station",
      "Kavalamanja Market", "Kasinsa Market", "Mpuka Market", "Chimutengo Market", "Mwavi Market",
      "Kavalamanja Bus Station", "Feira Bus Station", "Kasinsa Bus Stop", "Mwavi Bus Stop",
      "Luangwa Clinic", "Kapoche Clinic", "Feira Lodge", "INDECO BUILDING", "Justifeli Lodge,Luangwa",
      "Simon Njobvu's palace", "Dzalo Training Centre", "Luangwa SDA main",
      "Makichilo Lodge Luangwa", "yellow shop Luangwa", "JB THREE BOARDERS MALL", "River spot Luangwa",
      "Gerasmos Safari Lodge", "Nyabota Lodge", "UCZ Luangwa", "Pentocostal Assembly Joshua Assembly Luangwa",
      "Feira Kingdom Hall Luangwa", "Aglican Church",
      "Roan General Hospital", "Thomson Hospital", "Luanshya Hospital",
      "Roan Antelope Copper Mine", "Baluba Mine", "Roan Antelope Mine Hospital",
      "Kasims Medical Center", "Masaiti Health Center", "Garden Luangwa Compound",
      "Luanshya Police Station", "Luanshya Post Office", "ZESCO Office Luanshya",
      "Luanshya District Education Office", "Luanshya District Commissioner's Office",
      "Kamirenda Market", "Roan Township Market", "Masangano Market",
      "Luanshya Central Market", "Mpatamatu Market", "Mine Market", "Chamboli Market",
      "Luanshya Boys High School", "Luanshya Girls High School", "Luanshya High School",
      "Copperstone University", "Luanshya Technical & Vocational Teachers College",
      "Luanshya Technical & Business College", "Da Gama School", "Rivercross Primary School",
      "Central Primary School", "Mikwanda Primary School", "Mpatamatu Secondary School",
      "Roan Antelope Rugby Club", "Town Recreation Ground (Luanshya)", "Garden Luangwa Compound",
      "Roan Compound", "Mpatamatu Compound", "Kamirenda Compound",
      "Luanshya Airport", "Luanshya Shops", "Luanshya Bars",
      "Luanshya Town Bus Station", "Mpatamatu Bus Station", "Kamirenda Bus Station",
      "Roan Bus Station", "Luanshya Intercity Bus Station",
      "Absa Bank Luanshya", "Zanaco Luanshya", "Standard Chartered Bank Luanshya",
      "National Savings & Credit Bank Luanshya", "Finance Bank Luanshya",
      "First National Bank Luanshya"
    ];

    // --- PRODUCTS DATA (SAMPLE) ---
    const PRODUCTS = [
      { id: 1, name: "Mosi Beer", price: 25, image: "M.jpeg", category: "beverages" },
      { id: 2, name: "Castle Lager", price: 24, image: "CC.jpeg", category: "beverages" },
      { id: 3, name: "Castle Light Dumpy", price: 25, image: "CLD.jpeg", category: "beverages" },
      { id: 4, name: "Black Label", price: 20, image: "BL.webp", category: "beverages" },
      { id: 5, name: "Coca-Cola bottled", price: 12, image: "MC.jpg", category: "beverages" },
      { id: 6, name: "Fanta", price: 12, image: "F.jpeg", category: "beverages" },
      { id: 7, name: "Disposable Fanta", price: 15, image: "DD.jpg", category: "beverages" },
      { id: 8, name: "Disposable Coke", price: 15, image: "DD.jpg", category: "beverages" },
      { id: 9, name: "Disposable Sprite", price: 15, image: "DD.jpg", category: "beverages" },
      { id: 10, name: "Fresh_Up", price: 15.9, image: "Freshup.png", category: "beverages" }
      // ... add more products and categories as needed ...
    ];

    // --- AUTOCOMPLETE ---
    function setupAutocomplete(inputId, suggestionsId, sourceList) {
      const input = document.getElementById(inputId);
      const suggestionsBox = document.getElementById(suggestionsId);
      input.addEventListener("input", function() {
        const query = input.value.trim().toLowerCase();
        suggestionsBox.innerHTML = "";
        if (!query) { suggestionsBox.style.display = "none"; return; }
        const matches = sourceList.filter(
          name => name.toLowerCase().includes(query)
        ).slice(0, 10);
        if (matches.length === 0) { suggestionsBox.style.display = "none"; return; }
        matches.forEach(name => {
          const div = document.createElement("div");
          div.className = "autocomplete-suggestion";
          div.innerText = name;
          div.onclick = function() {
            input.value = name;
            suggestionsBox.innerHTML = "";
            suggestionsBox.style.display = "none";
            updateCart();
          };
          suggestionsBox.appendChild(div);
        });
        suggestionsBox.style.display = "block";
      });
      input.addEventListener("blur", function() {
        setTimeout(() => { suggestionsBox.style.display = "none"; }, 150);
      });
      input.addEventListener("focus", function() {
        if (input.value.trim()) input.dispatchEvent(new Event("input"));
      });
    }
    setupAutocomplete("gm-origin", "gm-origin-list", luangwaPlaces);
    setupAutocomplete("gm-destination", "gm-destination-list", luangwaPlaces);

    // --- DOM ELEMENTS ---
    const productListEl = document.getElementById('product-list');
    const cartItemsEl = document.getElementById('cart-items');
    const emptyCartEl = document.getElementById('empty-cart');
    const cartTotalEl = document.getElementById('cart-total');
    const productsTotalEl = document.getElementById('products-total');
    const transportationCostEl = document.getElementById('transportation-cost');
    const transportLineEl = document.getElementById('transportation-line');
    const transportIconEl = document.getElementById('transport-icon');
    const grandTotalEl = document.getElementById('grand-total');
    const checkoutBtn = document.getElementById('checkout-btn');
    const searchBox = document.getElementById('searchBox');
    const gmOriginEl = document.getElementById('gm-origin');
    const gmDestinationEl = document.getElementById('gm-destination');
    const mapBtn = document.getElementById('toggle-map-btn');
    const mapBtnText = document.getElementById('map-btn-text');
    const googleMapFrame = document.getElementById('google-map-frame');
    const modeVehicle = document.getElementById('mode-vehicle');
    const modeMotorbike = document.getElementById('mode-motorbike');
    const radioVehicle = document.getElementById('radio-vehicle');
    const radioMotorbike = document.getElementById('radio-motorbike');
    const customerPhoneWrapperFlex = document.getElementById('customer-phone-wrapper-flex');
    const customerPhoneInput = document.getElementById('customer-phone');
    const distanceInput = document.getElementById('distance-input');
    const toastContainer = document.getElementById('toast-container');
    const categoryFilter = document.getElementById('categoryFilter');

    // --- STATE ---
    let cart = [];
    let transportationCost = 0;
    let transportMode = 'vehicle'; // default
    const TRANSPORT_COST_PER3KM = { vehicle: 20, motorbike: 10 };
    const TRANSPORT_ICON = { vehicle: "🚗", motorbike: "🏍️" };
    let filteredProducts = PRODUCTS.slice();
    let undoTimeout = null, lastRemoved = null;

    // --- CATEGORY FILTER ---
    // Populate the dropdown with unique categories
    const categories = Array.from(new Set(PRODUCTS.map(p => p.category).filter(Boolean)));
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
      categoryFilter.appendChild(option);
    });

    // --- MODE TOGGLE ---
    function handleModeChange() {
      const v = modeVehicle.checked;
      const m = modeMotorbike.checked;
      radioVehicle.classList.toggle('selected', v);
      radioMotorbike.classList.toggle('selected', m);
      transportMode = v ? 'vehicle' : (m ? 'motorbike' : 'vehicle');
      updateCart();
      handleCustomerPhoneInput();
    }
    function handleCustomerPhoneInput() {
      const v = modeVehicle.checked;
      const m = modeMotorbike.checked;
      if (v || m) { customerPhoneWrapperFlex.style.display = ""; }
      else { customerPhoneWrapperFlex.style.display = "none"; customerPhoneInput.value = ""; }
    }
    modeVehicle.addEventListener('change', handleModeChange);
    modeMotorbike.addEventListener('change', handleModeChange);

    document.addEventListener('DOMContentLoaded', () => {
      modeVehicle.checked = true;
      handleModeChange();
      renderProducts();
      updateCart();
      function updateStickyCheckout() {
        if(window.innerWidth<680) checkoutBtn.classList.add('sticky-checkout');
        else checkoutBtn.classList.remove('sticky-checkout');
      }
      updateStickyCheckout();
      window.addEventListener('resize', updateStickyCheckout);
    });

    // --- FILTER PRODUCTS ---
    categoryFilter.addEventListener('change', filterProducts);
    searchBox.addEventListener('input', filterProducts);

    function filterProducts() {
      const selectedCategory = categoryFilter.value;
      const query = searchBox.value.trim().toLowerCase();
      filteredProducts = PRODUCTS.filter(p => {
        const matchCategory = selectedCategory === 'all' || p.category === selectedCategory;
        const matchQuery = p.name.toLowerCase().includes(query) ||
          (p.category && p.category.toLowerCase().includes(query));
        return matchCategory && matchQuery;
      });
      renderProducts();
    }

    // --- TOAST ---
    function showToast(message, type = "success") {
      const div = document.createElement('div');
      div.className = `toast ${type}`;
      div.textContent = message;
      toastContainer.appendChild(div);
      setTimeout(() => { div.style.opacity=0; setTimeout(()=>div.remove(),300); }, 3000);
    }
    function showMessage(message, type = "error") {
      const s = document.getElementById("statusMessage");
      s.textContent = message;
      s.className = `status-message ${type}`;
      s.style.display = "block";
      setTimeout(() => s.style.display = "none", 5000);
    }

    // --- TRANSPORT COST ---
    function calcTransportationCost() {
      let distance = parseFloat(distanceInput.value);
      if (!isNaN(distance) && distance > 0) {
        const rate = TRANSPORT_COST_PER3KM[transportMode];
        return Math.ceil(distance / 3) * rate;
      }
      return 0;
    }

    // --- RENDER PRODUCTS ---
    function renderProducts() {
      productListEl.innerHTML = '';
      filteredProducts.forEach(p => {
        const div = document.createElement('div');
        div.className = 'product';
        div.tabIndex = 0;
        div.setAttribute('aria-label', p.name + ", ZK " + p.price.toFixed(2));
        let outStock = (p.price <= 0);
        div.innerHTML = `
          <img src="${p.image}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/100?text=Error';">
          <h4>${p.name}</h4>
          <p>ZK ${p.price.toFixed(2)}</p>
          ${outStock?'<span class="out-stock">Out of Stock</span>':''}
          <button data-id="${p.id}" ${outStock?'disabled':''}>
            <i class="fas fa-plus"></i> Add
          </button>
        `;
        div.onclick = (e) => {
          if(outStock) return;
          if(e.target.tagName==="BUTTON" || e.target.closest("button")) return;
          addToCart(p.id);
        };
        productListEl.appendChild(div);
      });
    }

    // --- SLIDER BUTTONS ---
    document.getElementById('prevBtn').onclick = () => productListEl.scrollBy({ left: -200, behavior: 'smooth' });
    document.getElementById('nextBtn').onclick = () => productListEl.scrollBy({ left: 200, behavior: 'smooth' });

    // --- ADD TO CART ---
    productListEl.addEventListener('click', e => {
      const button = e.target.closest('button');
      if (button && button.dataset.id) {
        const id = parseInt(button.dataset.id, 10);
        addToCart(id);
      }
    });
    function addToCart(id) {
      const product = PRODUCTS.find(x => x.id === id);
      if (product) {
        const cartItem = cart.find(item => item.product.id === id);
        if (cartItem) { cartItem.quantity += 1; }
        else { cart.push({ product, quantity: 1 }); }
        updateCart();
        showToast(product.name + ' added to cart.', "success");
      } else { showMessage('Product not found.'); }
    }

    // --- UPDATE CART ---
    function updateCart() {
      transportationCost = calcTransportationCost();
      if (cart.length === 0) {
        cartItemsEl.innerHTML = '';
        emptyCartEl.style.display = 'block';
        cartTotalEl.style.display = 'none';
        checkoutBtn.style.display = 'none';
      } else {
        emptyCartEl.style.display = 'none';
        cartTotalEl.style.display = 'block';
        checkoutBtn.style.display = 'block';
        cartItemsEl.innerHTML = '';
        cart.forEach((item, index) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="cart-item-info">
              <img src="${item.product.image}" alt="${item.product.name}" class="cart-thumb" onerror="this.src='https://via.placeholder.com/36?text=Err';">
              <span class="cart-item-title">${item.product.name}</span>
            </div>
            <div class="cart-price-block">
              <span style="min-width:60px;">ZK ${(item.product.price * item.quantity).toFixed(2)}</span>
              <div class="quantity-controls">
                <button class="quantity-btn decrease" data-index="${index}" aria-label="Decrease quantity">-</button>
                <input type="number" min="1" class="cart-item-qty" data-index="${index}" value="${item.quantity}" aria-label="Quantity for ${item.product.name}">
                <button class="quantity-btn increase" data-index="${index}" aria-label="Increase quantity">+</button>
                <button class="remove-btn" data-index="${index}" aria-label="Remove item"><i class="fas fa-times"></i></button>
              </div>
            </div>
          `;
          cartItemsEl.appendChild(li);
        });
        const productsTotal = cart.reduce((sum, item) => sum + item.product.price * item.quantity, 0);
        productsTotalEl.textContent = productsTotal.toFixed(2);
        const grandTotal = productsTotal + transportationCost;
        grandTotalEl.textContent = grandTotal.toFixed(2);
        if (transportationCost > 0) {
          transportationCostEl.textContent = transportationCost.toFixed(2);
          transportLineEl.style.display = 'block';
        } else { transportLineEl.style.display = 'none'; }
        transportIconEl.textContent = TRANSPORT_ICON[transportMode];
      }
    }
    // Undo logic
    function showUndoToast(item, idx) {
      if (undoTimeout) clearTimeout(undoTimeout);
      lastRemoved = {item, idx};
      let toast = document.createElement('div');
      toast.className = "undo-toast";
      toast.innerHTML = `<span>Removed <b>${item.product.name}</b></span>
        <button class="undo-btn" id="undo-btn">Undo</button>`;
      toastContainer.appendChild(toast);
      document.getElementById('undo-btn').onclick = function() {
        cart.splice(idx, 0, item);
        updateCart();
        toast.remove();
        lastRemoved = null;
      };
      undoTimeout = setTimeout(() => { toast.remove(); lastRemoved = null; }, 4500);
    }
    cartItemsEl.addEventListener('click', e => {
      const button = e.target.closest('button');
      if (!button) return;
      const index = parseInt(button.dataset.index, 10);
      if (button.classList.contains('remove-btn')) {
        let removed = cart.splice(index, 1)[0];
        updateCart();
        showUndoToast(removed, index);
      }
      else if (button.classList.contains('increase')) { cart[index].quantity += 1; updateCart(); }
      else if (button.classList.contains('decrease')) {
        cart[index].quantity -= 1;
        if (cart[index].quantity === 0) {
          let removed = cart.splice(index, 1)[0];
          updateCart();
          showUndoToast(removed, index);
        } else updateCart();
      }
    });
    cartItemsEl.addEventListener('change', e => {
      const input = e.target;
      if(input.classList.contains('cart-item-qty')){
        let idx = parseInt(input.dataset.index, 10);
        let qty = parseInt(input.value, 10);
        if(!isNaN(qty) && qty >= 1) {
          cart[idx].quantity = qty;
          updateCart();
        } else {
          input.value = cart[idx].quantity;
        }
      }
    });

    gmOriginEl.addEventListener('input', updateCart);
    gmDestinationEl.addEventListener('input', updateCart);
    distanceInput.addEventListener('input', updateCart);

    // --- MAP TOGGLE ---
    mapBtn.addEventListener('click', function() {
      const from = gmOriginEl.value.trim();
      const to = gmDestinationEl.value.trim();
      if (!from || !to) {
        showToast("Please enter both origin (From) and destination (To).", "error");
        return;
      }
      if (googleMapFrame.style.display === "block") {
        googleMapFrame.style.display = "none";
        mapBtnText.textContent = "Show Map";
      } else {
        const embedUrl = "https://www.google.com/maps?q=" +
          encodeURIComponent(from + " to " + to) +
          "&output=embed";
        googleMapFrame.src = embedUrl;
        googleMapFrame.style.display = "block";
        googleMapFrame.scrollIntoView({behavior:"smooth"});
        mapBtnText.textContent = "Hide Map";
      }
    });

    // --- SUBMISSION LOGIC ---
    function validatePhone(phone) {
      return /^0[0-9]{9}$/.test(phone);
    }
    customerPhoneInput.addEventListener('input', function(){
      if(!validatePhone(this.value) && this.value.length>=10)
        this.style.borderColor = "var(--danger)";
      else this.style.borderColor = "";
    });
    function submitOrder() {
      if (cart.length === 0) {
        showToast('Your cart is empty. Please add items before checkout.', "error");
        return;
      }
      const from = gmOriginEl.value.trim();
      const to = gmDestinationEl.value.trim();
      if (!from || !to) {
        showToast('Please enter both origin (From) and destination (To) before checkout.', "error");
        return;
      }
      const v = modeVehicle.checked;
      const m = modeMotorbike.checked;
      if (!v && !m) {
        showToast('Please select a mode of transport.', "error");
        return;
      }
      const phone = customerPhoneInput.value.trim();
      if (!validatePhone(phone)) {
        showToast('Please enter a valid phone number (e.g., 0978167546).', "error");
        customerPhoneInput.focus();
        return;
      }
      let distance = parseFloat(distanceInput.value);
      if (isNaN(distance) || distance <= 0) { distance = ''; }
      const loader = document.getElementById("loader");
      loader.style.display = "block";
      const productsTotal = parseFloat(productsTotalEl.textContent);
      const grandTotal = parseFloat(grandTotalEl.textContent);
      const data = {
        from               : from,
        to                 : to,
        phoneNumber        : phone,
        distance           : distance,
        productsTotal      : productsTotal,
        transportationCost : transportationCost,
        transportMode      : v ? "Vehicle" : "Motorbike",
        grandTotal         : grandTotal,
        items              : cart.map(item => item.product.name + " x" + item.quantity).join(", "),
        Date               : ""
      };
      const formBody = Object.keys(data)
        .map(k => encodeURIComponent(k) + "=" + encodeURIComponent(data[k]))
        .join("&");
      fetch('https://script.google.com/macros/s/AKfycbx7R-M0nKEafAfvKnCbDq5r-m7TtQ466eNTA5SwjvTFqQKCbmT4rY8sTFZEzCtwQ9a3/exec', {
        method : 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body   : formBody
      })
      .then(r => r.json())
      .then(j => {
        loader.style.display = "none";
        if (j.status === 'success' || j.result === 'success' || (j.result && j.result.indexOf('success') !== -1)) {
          showToast('Order confirmed! Delivery details sent.', "success");
          cart = [];
          updateCart();
          customerPhoneInput.value = '';
          gmOriginEl.value = '';
          gmDestinationEl.value = '';
          distanceInput.value = '';
          googleMapFrame.style.display = "none";
          mapBtnText.textContent = "Show Map";
        } else {
          showToast(j.message || "Submission failed", "error");
        }
      })
      .catch(e => {
        loader.style.display = "none";
        showToast("Submission failed", "error");
        console.error(e);
      });
    }
    checkoutBtn.onclick = submitOrder;
  </script>
</body>
</html>
