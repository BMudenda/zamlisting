<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luangwa Delivery Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2e7d32;
      --primary-dark: #1b5e20;
      --primary-light: #81c784;
      --accent: #ff9800;
      --text: #333;
      --text-light: #666;
      --background: #f5f5f5;
      --card-bg: white;
      --border: #e0e0e0;
      --shadow: 0 0 8px rgba(0,0,0,0.5);
      --success: #e8f5e9;
      --error: #ffebee;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; color: var(--text); background-color: var(--background); line-height: 1.5; }
    header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 1.5rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    header h1 { font-weight: normal; font-size: 1.8rem; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; display: flex; flex-wrap: wrap; gap: 2rem; }
    .slider-wrapper { position: relative; flex: 2; min-width: 300px; background: var(--card-bg); border-radius: 10px; padding: 1.5rem; box-shadow: var(--shadow); }
    .section-title { font-size: 1.3rem; margin-bottom: 1rem; color: var(--primary-dark); display: flex; align-items: center; gap: 0.5rem; }
    .section-title i { color: var(--primary); }
    .thumbnail-slider { display: flex; overflow-x: auto; scroll-behavior: smooth; gap: 1.5rem; padding: 1rem 0; margin: 0 -0.5rem; }
    .thumbnail-slider::-webkit-scrollbar { height: 6px; }
    .thumbnail-slider::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .thumbnail-slider::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 10px; }
    .product { flex: 0 0 160px; border: 1px solid var(--border); border-radius: 10px; padding: 1rem; text-align: center; background: var(--card-bg); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
    .product:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .product img { width: 100px; height: 100px; object-fit: cover; margin-bottom: 0.8rem; border-radius: 4px; }
    .product h4 { font-size: 1rem; margin-bottom: 0.5rem; color: var(--text); }
    .product p { color: var(--primary-dark); font-weight: 600; margin-bottom: 0.8rem; }
    .product button { border: none; background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-family: inherit; font-weight: 500; transition: background 0.2s; }
    .product button:hover { background: var(--primary-dark); }
    .slider-button { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: background-color 0.2s; }
    .slider-button:hover { background: rgba(0,0,0,0.8); }
    .slider-button.prev { left: 0; }
    .slider-button.next { right: 0; }
    .cart { border: 1px solid var(--border); padding: 1.5rem; border-radius: 10px; flex: 1; min-width: 300px; background: var(--card-bg); position: sticky; top: 1rem; box-shadow: var(--shadow); }
    .cart-items { list-style: none; padding: 0; margin: 0 0 1.5rem; max-height: 300px; overflow-y: auto; }
    .cart-items li { padding: 0.8rem 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .cart-items li:last-child { border-bottom: none; }
    .cart-total { margin: 1rem 0; padding-top: 1rem; border-top: 1px solid var(--border); color: var(--text-dark); }
    .cart-total p { margin: 0.5rem 0; }
    .address-input, .phone-input { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 5px; font-family: inherit; font-size: 0.9rem; transition: border-color 0.2s; }
    .address-input:focus, .phone-input:focus { outline: none; border-color: var(--primary); }
    .btn { border: none; background: var(--primary); color: white; padding: 0.8rem 1.2rem; border-radius: 4px; cursor: pointer; font-family: inherit; font-weight: 500; width: 100%; transition: background 0.2s, opacity 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .btn:hover { background: var(--primary-dark); }
    .btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.6; }
    .btn-accent { background: var(--accent); }
    .btn-accent:hover { background: #e68a00; }
    .btn-secondary { background: var(--primary-light); margin-top: 0.5rem; }
    .btn-secondary:hover { background: var(--primary); }
    .btn-success { background: var(--primary-dark); }
    .map-toggle-btn { background: var(--primary-light); margin: 1rem auto; display: block; }
    .map-toggle-btn:hover { background: var(--primary); }
    #eta { margin-top: 1rem; padding: 0.75rem; background: var(--success); border-radius: 4px; color: var(--primary-dark); font-weight: 500; }
    #map { width: 100%; height: 400px; margin: 2rem 0; border-radius: 10px; box-shadow: var(--shadow); display: none; }
    .empty-cart { text-align: center; color: var(--text-muted); padding: 2rem 0; }
    .empty-cart i { font-size: 2rem; margin-bottom: 1rem; color: var(--primary-light); }
    .remove-btn { background-color: transparent; border: none; color: #ff5252; cursor: pointer; padding: 0.25rem; transition: color 0.2s; }
    .quantity-controls { display: flex; align-items: center; gap: 0.5rem; }
    .quantity-btn { background: var(--primary-light); border: none; color: white; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
    .quantity-btn:hover { background: var(--primary); }
    #checkout-status { margin-top: 1rem; padding: 0.75rem; border-radius: 4px; font-weight: 500; text-align: center; display: none; }
    #checkout-status.success { background: var(--success); color: var(--primary-dark); }
    #checkout-status.error { background: var(--error); color: #c62828; }
    #loader {
      display: none;
      margin: 1rem auto;
      text-align: center;
    }
    .status-message {
      display: none;
      margin: 1rem 0;
      padding: 0.75rem;
      border-radius: 4px;
      text-align: center;
      font-weight: 500;
    }
    .status-message.success { background: var(--success); color: var(--primary-dark); }
    .status-message.error { background: var(--error); color: #c62828; }
    #searchBox {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1rem;
      box-sizing: border-box;
    }
    /* Instructions toggle and box styles */
    .instructions-toggle-btn {
      background: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 600;
      border: 1px solid var(--primary);
      border-radius: 6px;
      padding: 0.6rem 1.2rem;
      margin: 1.2rem auto 0.5rem auto;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 7px;
      transition: background 0.15s;
      font-size: 1.01em;
      box-shadow: 0 2px 8px rgba(44,125,50,0.03);
    }
    .instructions-toggle-btn:hover {
      background: var(--primary);
      color: white;
    }
    .instructions-box {
      background: #f9fff7;
      border: 1px solid var(--primary-light);
      border-radius: 8px;
      padding: 1.2em 1.4em 1.2em 2.2em;
      max-width: 700px;
      margin: 0 auto 1.5em auto;
      font-size: 1em;
      box-shadow: 0 1px 6px rgba(44,125,50,0.07);
      color: var(--primary-dark);
      display: none;
      line-height: 1.66em;
    }
    .instructions-box ul { margin-left: 1.1em; }
    .instructions-box li { margin-bottom: 0.6em; }
    @media (max-width: 767px) {
      .container { flex-direction: column; }
      .slider-wrapper, .cart { width: 100%; }
      .slider-button { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-truck"></i> Luangwa Delivery Platform(under constructionüöß)</h1>
  </header>

  <!-- Instructions toggle button and box -->
  <button id="instructions-toggle-btn" class="instructions-toggle-btn">
    <span id="instructions-toggle-icon">‚ûï</span> Instructions & Tips
  </button>
  <div id="instructions-box" class="instructions-box">
    <ul>
      <li>üîç <b>You can search for products</b> using the search box above the products list.</li>
      <li>üõí <b>Add products</b> to your order using the <b>Add</b> buttons.</li>
      <li>üì¶ <b>Set your delivery destination</b> by searching, or <b>double-clicking</b> (desktop) or <b>tapping once</b> (mobile) on the toggled map.</li>
      <li>üó∫ <b>Use the "Toggle Map" button</b> to show/hide the delivery map interface.</li>
      <li>üìç <b>Pickup location</b> is set as the default Luangwa pickup point.</li>
      <li>üì± <b>Enter your phone number</b> before checking out.</li>
      <li>üöö <b>Estimate delivery</b> to get ETA and cost before proceeding to checkout.</li>
      <li>üí≥ <b>Proceed to checkout</b> to confirm your order and submit details.</li>
    </ul>
  </div>

  <div class="container">
    <div class="slider-wrapper">
      <h2 class="section-title"><i class="fas fa-store"></i> Available Products</h2>
      <input type="text" id="searchBox" placeholder="Search products...">
      <button class="slider-button prev" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
      <div id="product-list" class="thumbnail-slider"></div>
      <button class="slider-button next" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
    </div>
    <div class="cart">
      <h2 class="section-title"><i class="fas fa-shopping-cart"></i> Your Order</h2>
      <ul id="cart-items" class="cart-items"></ul>
      <div id="empty-cart" class="empty-cart">
        <i class="fas fa-cart-arrow-down"></i>
        <p>Your cart is empty.</p>
        <p>Add items to get started.</p>
      </div>
      <div id="cart-total" class="cart-total" style="display:none;">
        <p>Products Total: ZK <span id="products-total">0.00</span></p>
        <p id="transportation-line" style="display:none;">Transportation: ZK <span id="transportation-cost">0.00</span></p>
        <p><strong>Total: ZK <span id="grand-total">0.00</span></strong></p>
      </div>
      <label for="end">Search for your Destination below or let the current fetched location</label>
      <input id="end" class="address-input" type="text" placeholder="Enter delivery address" />
      <div id="location-message" style="color: red; margin-top: 0.5rem;"></div>
      <label for="phone">Enter phone number:</label>
      <input id="phone" type="tel" class="phone-input" placeholder="0978167546" pattern="0[0-9]{9}" maxlength="10" />
      <button id="calc-time" class="btn btn-primary" disabled>
        <i class="fas fa-clock"></i> Estimate Delivery
      </button>
      <div id="eta"></div>
      <button id="checkout-btn" class="btn btn-accent" style="margin-top: 1rem; display:none;">
        <i class="fas fa-credit-card"></i> Proceed to Checkout
      </button>
      <div id="checkout-status" class="status-message"></div>
      <div id="loader"><i class="fas fa-spinner fa-spin"></i> Processing...</div>
      <div id="statusMessage" class="status-message"></div>
    </div>
  </div>
  <button id="toggle-map-btn" class="btn map-toggle-btn">Toggle Map</button>
  <div id="map"></div>
  <script>
    // --- INSTRUCTIONS TOGGLE LOGIC ---
    const instructionsBtn = document.getElementById("instructions-toggle-btn");
    const instructionsBox = document.getElementById("instructions-box");
    const instructionsIcon = document.getElementById("instructions-toggle-icon");
    instructionsBtn.addEventListener("click", function () {
      if (instructionsBox.style.display === "block") {
        instructionsBox.style.display = "none";
        instructionsIcon.textContent = "‚ûï";
      } else {
        instructionsBox.style.display = "block";
        instructionsIcon.textContent = "‚ûñ";
      }
    });

    // --- REST OF YOUR SCRIPT AS BEFORE ---
    // 100 default commodities
    const PRODUCTS = [
      { id: 1, name: "Mosi Beer", price: 25, image: "M.jpeg", category: "beverages" },
      { id: 2, name: "Castle Lager", price: 24, image: "CC.jpeg", category: "beverages" },
      { id: 3, name: "Castle Light Dumpy", price: 25, image: "CLD.jpeg", category: "beverages" },
      { id: 4, name: "Black Label", price: 20, image: "BL.webp", category: "beverages" },
      { id: 5, name: "Coca-Cola bottled", price: 12, image: "MC.jpg", category: "beverages" },
      { id: 6, name: "Fanta", price: 12, image: "F.jpeg", category: "beverages" },
      { id: 7, name: "Disposable Fanta", price: 15, image: "DD.jpg", category: "beverages" },
      { id: 8, name: "Disposable Coke", price: 15, image: "DD.jpg", category: "beverages" },
      { id: 9, name: "Disposable Sprite", price: 15, image: "DD.jpg", category: "beverages" },
      { id: 10, name: "Fresh_Up", price: 15.9, image: "Freshup.png", category: "beverages" },
      { id: 11, name: "Black Label Cained", price: 30, image: "BL.webp", category: "beverages" },
      { id: 12, name: "Fruitcana", price: 15, image: "Fruitc.webp", category: "beverages" },
      { id: 13, name: "Kunfu", price: 15, image: "Konfu.png", category: "beverages" },
      { id: 14, name: "Mojo", price: 15, image: "Mojo.png", category: "beverages" },
      { id: 15, name: "Red Rock", price: 15, image: "RR.png", category: "beverages" },
      { id: 16, name: "Rasta", price: 15, image: "Rasta.png", category: "beverages" },
      { id: 17, name: "Life Shots", price: 15, image: "Shots.webp", category: "beverages" },
      { id: 18, name: "Fruitcana Red Smoothie", price: 15, image: "Smoothy.png", category: "beverages" },
      { id: 19, name: "Sun Dance", price: 15, image: "Sund.png", category: "beverages" },
      { id: 21, name: "Tonic Water Brothers", price: 15, image: "Tonic.png", category: "beverages" },
      { id: 22, name: "Vatra", price: 15, image: "Vatra.png", category: "beverages" },
      { id: 23, name: "Wild Cat", price: 15, image: "Wildcat.png", category: "beverages" },
      { id: 24, name: "Fruit-up", price: 15, image: "Fruitup.png", category: "beverages" },
      { id: 25, name: "DP", price: 00, image: "D1.jpeg", category: "beverages" },
      { id: 26, name: "DP", price: 00, image: "D2.png", category: "beverages" },
      { id: 27, name: "DP", price: 00, image: "D3.jpeg", category: "beverages" },
      { id: 28, name: "DP", price: 00, image: "D4.jpeg", category: "beverages" },
      { id: 29, name: "DP", price: 00, image: "D5.jpeg", category: "beverages" },
      { id: 30, name: "DP", price: 00, image: "D6.jpeg", category: "beverages" },
      { id: 31, name: "DP", price: 00, image: "D7.jpeg", category: "beverages" },
      { id: 32, name: "DP", price: 00, image: "D8.jpeg", category: "beverages" },
      { id: 33, name: "o1", price: 00, image: "O1.jpeg", category: "beverages" },
      { id: 34, name: "o2", price: 00, image: "O2.jpeg", category: "beverages" },
      { id: 35, name: "o3", price: 00, image: "O3.jpeg", category: "beverages" },
      { id: 36, name: "o4", price: 00, image: "O4.jpg", category: "beverages" },
      { id: 37, name: "o5", price: 00, image: "O5.jpeg", category: "beverages" },
      { id: 38, name: "o6", price: 00, image: "O6.jpeg", category: "beverages" },
      { id: 39, name: "o7", price: 00, image: "O7.jpeg", category: "beverages" },
      { id: 40, name: "o8", price: 00, image: "O8.jpg", category: "beverages" },
      { id: 41, name: "o9", price: 00, image: "O9.jpeg", category: "beverages" },
      { id: 42, name: "10", price: 00, image: "010.jpeg", category: "beverages" },
      { id: 43, name: "11", price: 00, image: "O11.png", category: "beverages" },
      { id: 44, name: "12", price: 00, image: "012.jpeg", category: "beverages" },
      { id: 45, name: "13", price: 00, image: "O13.jpeg", category: "beverages" },
      { id: 46, name: "N1", price: 00, image: "N1.jpg", category: "beverages" },
      { id: 47, name: "N2", price: 00, image: "N2.jpeg", category: "beverages" },
      { id: 48, name: "N3", price: 00, image: "N3.jpeg", category: "beverages" },
      { id: 49, name: "N4", price: 00, image: "N4.jpeg", category: "beverages" },
      { id: 50, name: "N5", price: 00, image: "N5.jpeg", category: "beverages" },
      { id: 51, name: "N6", price: 00, image: "N6.jpeg", category: "beverages" },
      { id: 52, name: "N7", price: 00, image: "N7.jpeg", category: "beverages" },
      { id: 53, name: "N8", price: 00, image: "N8.jpeg", category: "beverages" },
      { id: 54, name: "N9", price: 00, image: "N9.jpeg", category: "beverages" },
      { id: 55, name: "N10", price: 00, image: "N10.jpeg", category: "beverages" },
      { id: 56, name: "N11", price: 00, image: "N11.jpeg", category: "beverages" },
      { id: 57, name: "N12", price: 00, image: "N12.jpeg", category: "beverages" },
      { id: 58, name: "N13", price: 00, image: "N13.jpeg", category: "beverages" },
      { id: 59, name: "N14", price: 00, image: "N14.jpeg", category: "beverages" },
      { id: 60, name: "N15", price: 00, image: "N15.jpeg", category: "beverages" },
      { id: 61, name: "N16", price: 00, image: "N16.jpeg", category: "beverages" },
      { id: 62, name: "N17", price: 00, image: "N17.jpeg", category: "beverages" },
      { id: 63, name: "N18", price: 00, image: "N18.jpeg", category: "beverages" },
      { id: 64, name: "N19", price: 00, image: "N19.jpeg", category: "beverages" },
      { id: 65, name: "N20", price: 00, image: "N20.jpeg", category: "beverages" },
      { id: 66, name: "N21", price: 00, image: "N21.jpeg", category: "beverages" },
      { id: 67, name: "N22", price: 00, image: "N22.jpeg", category: "beverages" },
      { id: 68, name: "N23", price: 00, image: "N23.jpeg", category: "beverages" },
      { id: 69, name: "N24", price: 00, image: "N24.jpeg", category: "beverages" },
      { id: 70, name: "N25", price: 00, image: "N25.jpeg", category: "beverages" },
      { id: 71, name: "N26", price: 00, image: "N26.jpeg", category: "beverages" },
      { id: 72, name: "N27", price: 00, image: "N27.webp", category: "beverages" },
      { id: 73, name: "N28", price: 00, image: "N28.webp", category: "beverages" },
      { id: 74, name: "N29", price: 00, image: "N29.jpeg", category: "beverages" },
    // Add 91 more default products
      { id: 100, name: "Black Label Big", price: 30, image: "BL.webp", category: "beverages" }
      
    ];

    // 
    for (let i = 75; i <= 99; i++) {
      PRODUCTS.push({
        id: i,
        name: "Commodity " + i,
        price: 10 + Math.floor(Math.random() * 90), // ZK10-ZK99
        image: "https://via.placeholder.com/100?text=Product+" + i,
        category: (i % 2 === 0 ? "food" : "beverages")
      });
    }

    const productListEl = document.getElementById('product-list');
    const cartItemsEl = document.getElementById('cart-items');
    const emptyCartEl = document.getElementById('empty-cart');
    const cartTotalEl = document.getElementById('cart-total');
    const productsTotalEl = document.getElementById('products-total');
    const transportationCostEl = document.getElementById('transportation-cost');
    const grandTotalEl = document.getElementById('grand-total');
    const transportationLineEl = document.getElementById('transportation-line');
    const endEl = document.getElementById('end');
    const phoneEl = document.getElementById('phone');
    const btnCalc = document.getElementById('calc-time');
    const checkoutBtn = document.getElementById('checkout-btn');
    const checkoutStatusEl = document.getElementById('checkout-status');
    const etaEl = document.getElementById('eta');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const toggleMapBtn = document.getElementById('toggle-map-btn');
    const mapEl = document.getElementById('map');
    const locationMessageEl = document.getElementById('location-message');
    const searchBox = document.getElementById('searchBox');
    let map, geocoder, distanceService, directionsService, directionsRenderer;
    let cart = [];
    let transportationCost = 0;
    let startLatLng = null, endLatLng = null;
    let markers = [];
    let isMapVisible = false;
    const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwUvA_InN9GzHNjuDTkV7A8VGSbLYEtkEkr-FwygSg0c6ZxxFnyIugasy8S_IM87Q/exec';
    const DEFAULT_PICKUP = '9CH5+J8J, Luangwa';

    // For filtering
    let filteredProducts = PRODUCTS.slice();

    searchBox.addEventListener('input', function() {
      const query = this.value.trim().toLowerCase();
      filteredProducts = PRODUCTS.filter(p => 
        p.name.toLowerCase().includes(query) ||
        (p.category && p.category.toLowerCase().includes(query))
      );
      renderProducts();
    });

    document.addEventListener('DOMContentLoaded', () => {
      try { renderProducts(); updateCart(); loadGoogleMaps(); }
      catch (error) { console.error('Initialization error:', error); showMessage('Failed to initialize the platform. Please try again.', "error"); }
    });

    function showMessage(message, type = "error") {
      const s = document.getElementById("statusMessage");
      s.textContent = message;
      s.className   = `status-message ${type}`;
      s.style.display = "block";
      setTimeout(() => s.style.display = "none", 5000);
    }

    function renderProducts() {
      try {
        productListEl.innerHTML = '';
        filteredProducts.forEach(p => {
          const div = document.createElement('div');
          div.className = 'product';
          div.innerHTML = `
            <img src="${p.image}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/100?text=Error';">
            <h4>${p.name}</h4>
            <p>ZK ${p.price.toFixed(2)}</p>
            <button data-id="${p.id}">
              <i class="fas fa-plus"></i> Add
            </button>
          `;
          productListEl.appendChild(div);
        });
      } catch (error) { console.error('Render products error:', error); showMessage('Error loading products.'); }
    }
    prevBtn.onclick = () => productListEl.scrollBy({ left: -200, behavior: 'smooth' });
    nextBtn.onclick = () => productListEl.scrollBy({ left: 200, behavior: 'smooth' });
    productListEl.addEventListener('click', e => {
      try {
        const button = e.target.closest('button');
        if (button && button.dataset.id) {
          const id = parseInt(button.dataset.id, 10);
          addToCart(id);
        }
      } catch (error) { console.error('Add to cart click error:', error); showMessage('Error adding to cart.'); }
    });
    function addToCart(id) {
      try {
        const product = PRODUCTS.find(x => x.id === id);
        if (product) {
          const cartItem = cart.find(item => item.product.id === id);
          if (cartItem) { cartItem.quantity += 1; }
          else { cart.push({ product, quantity: 1 }); }
          updateCart();
          const btn = document.querySelector(`button[data-id="${id}"]`);
          if (btn) {
            btn.innerHTML = '<i class="fas fa-check"></i> Added';
            btn.style.backgroundColor = 'var(--primary-dark)';
            setTimeout(() => {
              btn.innerHTML = '<i class="fas fa-plus"></i> Add';
              btn.style.backgroundColor = '';
            }, 1000);
          }
        } else { showMessage('Product not found.'); }
      } catch (error) { console.error('Add to cart error:', error); showMessage('Error adding to cart.'); }
    }
    function updateCart() {
      try {
        if (cart.length === 0) {
          cartItemsEl.innerHTML = '';
          emptyCartEl.style.display = 'block';
          cartTotalEl.style.display = 'none';
          checkoutBtn.style.display = 'none';
          checkoutStatusEl.style.display = 'none';
        } else {
          emptyCartEl.style.display = 'none';
          cartTotalEl.style.display = 'block';
          checkoutBtn.style.display = 'block';
          cartItemsEl.innerHTML = '';
          cart.forEach((item, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
              <span>${item.product.name} (x${item.quantity})</span>
              <div>
                <span>ZK ${(item.product.price * item.quantity).toFixed(2)}</span>
                <div class="quantity-controls">
                  <button class="quantity-btn decrease" data-index="${index}">-</button>
                  <button class="quantity-btn increase" data-index="${index}">+</button>
                  <button class="remove-btn" data-index="${index}">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            `;
            cartItemsEl.appendChild(li);
          });
          const productsTotal = cart.reduce((sum, item) => sum + item.product.price * item.quantity, 0);
          productsTotalEl.textContent = productsTotal.toFixed(2);
          const grandTotal = productsTotal + transportationCost;
          grandTotalEl.textContent = grandTotal.toFixed(2);
          if (transportationCost > 0) {
            transportationCostEl.textContent = transportationCost.toFixed(2);
            transportationLineEl.style.display = 'block';
          } else { transportationLineEl.style.display = 'none'; }
        }
        btnCalc.disabled = cart.length === 0 || (!endEl.value && !endLatLng) || !startLatLng;
      } catch (error) { console.error('Update cart error:', error); showMessage('Error updating cart.'); }
    }
    cartItemsEl.addEventListener('click', e => {
      try {
        const button = e.target.closest('button');
        if (!button) return;
        const index = parseInt(button.dataset.index, 10);
        if (button.classList.contains('remove-btn')) { cart.splice(index, 1); }
        else if (button.classList.contains('increase')) { cart[index].quantity += 1; }
        else if (button.classList.contains('decrease')) {
          cart[index].quantity -= 1;
          if (cart[index].quantity === 0) cart.splice(index, 1);
        }
        updateCart();
      } catch (error) { console.error('Cart interaction error:', error); showMessage('Error updating cart items.'); }
    });
    toggleMapBtn.addEventListener('click', () => {
      try {
        isMapVisible = !isMapVisible;
        mapEl.style.display = isMapVisible ? 'block' : 'none';
        toggleMapBtn.innerHTML = isMapVisible ? 
          '<i class="fas fa-map"></i> Hide Map' : 
          '<i class="fas fa-map"></i> Show Map';
        if (isMapVisible && map) {
          google.maps.event.trigger(map, 'resize');
          if (startLatLng || endLatLng) {
            map.setCenter(startLatLng || endLatLng);
          }
        }
      } catch (error) { console.error('Map toggle error:', error); showMessage('Error toggling map.'); }
    });
    function geocodeAddress(address, isStart) {
      try {
        if (!address) return;
        geocoder.geocode({ 
          address: address + ', Zambia',
          componentRestrictions: { country: 'zm' }
        }, (results, status) => {
          if (status === 'OK' && results[0]) {
            clearMarkers();
            if (isStart) startLatLng = results[0].geometry.location;
            else endLatLng = results[0].geometry.location;
            updateCart();
            const marker = new google.maps.Marker({
              position: results[0].geometry.location,
              map: map,
              title: results[0].formatted_address,
              icon: {
                url: isStart ? 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' : 
                              'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
              }
            });
            markers.push(marker);
            map.setCenter(results[0].geometry.location);
            if (isMapVisible) {
              google.maps.event.trigger(map, 'resize');
              map.setCenter(results[0].geometry.location);
            }
          } else {
            showMessage('Could not find the location: ' + status);
            if (!isStart) endEl.value = '';
          }
        });
      } catch (error) { console.error('Geocode address error:', error); showMessage('Error geocoding address.'); }
    }
    function reverseGeocode(latLng, inputEl) {
      try {
        geocoder.geocode({ location: latLng }, (results, status) => {
          if (status === 'OK' && results[0]) {
            const zambiaResult = results.find(r => 
              r.address_components.some(c => c.types.includes('country') && c.short_name === 'ZM')
            ) || results[0];
            inputEl.value = zambiaResult.formatted_address;
            endLatLng = latLng;
            clearMarkers();
            markers.forEach(marker => marker.setMap(map));
            const marker = new google.maps.Marker({
              position: latLng,
              map: map,
              title: zambiaResult.formatted_address,
              icon: { url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png' }
            });
            markers.push(marker);
            map.setCenter(latLng);
            if (isMapVisible) {
              google.maps.event.trigger(map, 'resize');
              map.setCenter(latLng);
            }
            updateCart();
            showMessage('');
          } else {
            inputEl.value = `${latLng.lat().toFixed(5)}, ${latLng.lng().toFixed(5)}`;
            endLatLng = latLng;
            updateCart();
            showMessage('Could not find address for this location.');
          }
        });
      } catch (error) { console.error('Reverse geocode error:', error); showMessage('Error reverse geocoding location.'); }
    }
    function clearMarkers() {
      try {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        if (startLatLng) {
          const marker = new google.maps.Marker({
            position: startLatLng,
            map: map,
            title: 'Pickup Location',
            icon: { url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' }
          });
          markers.push(marker);
        }
      } catch (error) { console.error('Clear markers error:', error); showMessage('Error clearing map markers.'); }
    }
    function fetchDefaultLocation() {
      if (!navigator.geolocation) {
        showMessage('Geolocation is not supported by your browser. Please enter your delivery address manually.');
        return;
      }
      showMessage('Fetching your location...');
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const latLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
          reverseGeocode(latLng, endEl);
        },
        (error) => {
          let message = 'Unable to fetch your location. Please enter your delivery address manually.';
          if (error.code === error.PERMISSION_DENIED) {
            message = 'Location access denied. Please allow location access or enter your delivery address manually.';
          } else if (error.code === error.POSITION_UNAVAILABLE) {
            message = 'Location information is unavailable. Please enter your delivery address manually.';
          } else if (error.code === error.TIMEOUT) {
            message = 'Location request timed out. Please enter your delivery address manually.';
          }
          showMessage(message);
        },
        { timeout: 10000 }
      );
    }
    function initMap() {
      try {
        map = new google.maps.Map(mapEl, {
          center: { lat: -13.1367, lng: 28.4164 },
          zoom: 13,
          styles: [{ featureType: "poi", stylers: [{ visibility: "off" }] }]
        });
        geocoder = new google.maps.Geocoder();
        distanceService = new google.maps.DistanceMatrixService();
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          suppressMarkers: false,
          preserveViewport: false
        });
        directionsRenderer.setMap(map);
        geocoder.geocode({ 
          address: DEFAULT_PICKUP,
          componentRestrictions: { country: 'zm' }
        }, (results, status) => {
          if (status === 'OK' && results[0]) {
            startLatLng = results[0].geometry.location;
            clearMarkers();
            const marker = new google.maps.Marker({
              position: startLatLng,
              map: map,
              title: 'Pickup Location',
              icon: { url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' }
            });
            markers.push(marker);
            if (isMapVisible) {
              google.maps.event.trigger(map, 'resize');
              map.setCenter(startLatLng);
            }
            updateCart();
            fetchDefaultLocation();
          } else {
            showMessage('Failed to locate pickup point. Please try again later.');
          }
        });
        const endAutocomplete = new google.maps.places.Autocomplete(endEl, {
          types: ['geocode', 'establishment'],
          componentRestrictions: { country: 'zm' },
          fields: ['address_components', 'geometry', 'name', 'place_id']
        });
        endAutocomplete.addListener('place_changed', () => {
          try {
            const place = endAutocomplete.getPlace();
            if (place.geometry) {
              endLatLng = place.geometry.location;
              clearMarkers();
              markers.forEach(marker => marker.setMap(map));
              const marker = new google.maps.Marker({
                position: endLatLng,
                map: map,
                title: place.name,
                icon: { url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png' }
              });
              markers.push(marker);
              map.setCenter(endLatLng);
              if (isMapVisible) {
                google.maps.event.trigger(map, 'resize');
                map.setCenter(endLatLng);
              }
              updateCart();
              showMessage('');
            } else {
              geocodeAddress(place.name, false);
            }
          } catch (error) { console.error('Autocomplete error:', error); showMessage('Error with address autocomplete.'); }
        });
        // --- DOUBLE CLICK SETS DESTINATION ON MAP ---
        map.addListener('dblclick', (e) => {
          try {
            if (!isMapVisible) return; // Only allow when map is visible
            const latLng = e.latLng;
            reverseGeocode(latLng, endEl);
            updateCart();
          } catch (error) { console.error('Map dblclick error:', error); showMessage('Error selecting location from map.'); }
        });
      } catch (error) { console.error('Init map error:', error); showMessage('Error initializing map.'); }
    }
    btnCalc.onclick = () => {
      try {
        const origin = startLatLng;
        const dest = endLatLng || endEl.value.trim();
        if (!origin || !dest) {
          showMessage('Please enter a delivery location.');
          return;
        }
        btnCalc.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
        btnCalc.disabled = true;
        distanceService.getDistanceMatrix({
          origins: [origin],
          destinations: [dest],
          travelMode: 'DRIVING',
          drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' }
        }, (resp, status) => {
          btnCalc.innerHTML = '<i class="fas fa-clock"></i> Estimate Delivery';
          btnCalc.disabled = false;
          const el = resp?.rows?.[0]?.elements?.[0];
          if (status === 'OK' && el?.status === 'OK') {
            const distanceInKm = el.distance.value / 1000;
            // K15 per 3km, rounded up
            const segments = Math.ceil(distanceInKm / 3);
            transportationCost = segments * 15;
            updateCart();
            etaEl.innerHTML = `
              <p><i class="fas fa-road"></i> <strong>Distance:</strong> ${el.distance.text} (${distanceInKm.toFixed(1)} km)</p>
              <p><i class="fas fa-clock"></i> <strong>ETA:</strong> ${el.duration.text}</p>
              ${el.duration_in_traffic ? `<p><i class="fas fa-car"></i> <strong>With traffic:</strong> ${el.duration_in_traffic.text}</p>` : ''}
            `;
            showMessage('');
          } else {
            etaEl.textContent = 'Could not compute distance/time. Please check your delivery location.';
            showMessage('Could not compute distance/time.');
          }
        });
        directionsService.route({
          origin: startLatLng,
          destination: endLatLng || endEl.value.trim(),
          travelMode: google.maps.TravelMode.DRIVING,
          provideRouteAlternatives: true
        }, (resp, status) => {
          if (status === 'OK') {
            directionsRenderer.setDirections(resp);
            if (isMapVisible) {
              google.maps.event.trigger(map, 'resize');
              map.setCenter(startLatLng || endLatLng);
            }
          } else { showMessage('Route error: ' + status); }
        });
      } catch (error) {
        btnCalc.innerHTML = '<i class="fas fa-clock"></i> Estimate Delivery';
        btnCalc.disabled = false;
        showMessage('Error calculating delivery.');
      }
    };

    // --- SUBMIT ORDER VIA x-www-form-urlencoded POST ---
    checkoutBtn.onclick = function () {
      if (checkoutBtn.disabled) return;
      // Validate
      if (!endEl.value) {
        showMessage('Please enter a delivery location before checkout.');
        return;
      }
      if (cart.length === 0) {
        showMessage('Your cart is empty. Please add items before checkout.');
        return;
      }
      if (transportationCost === 0) {
        showMessage('Please estimate delivery before proceeding to checkout.');
        return;
      }
      const phoneRegex = /^0[0-9]{9}$/;
      if (!phoneEl.value || !phoneRegex.test(phoneEl.value.trim())) {
        showMessage('Please enter a valid Zambian phone number (e.g., 0978167546).');
        return;
      }

      // Show loader
      document.getElementById("loader").style.display = "block";

      // Collect order data
      const data = {
        pickup      : DEFAULT_PICKUP,
        delivery    : endEl.value.trim(),
        phoneNumber : phoneEl.value.trim(),
        productsTotal : parseFloat(productsTotalEl.textContent),
        transportationCost: transportationCost,
        grandTotal  : parseFloat(grandTotalEl.textContent),
        items       : cart.map(item => item.product.name + " x" + item.quantity).join(", "),
        Date        : "" // Let Apps Script handle date
      };

      // Encode as x-www-form-urlencoded
      const formBody = Object.keys(data)
        .map(k => encodeURIComponent(k) + "=" + encodeURIComponent(data[k]))
        .join("&");

      // Submit
      fetch(GOOGLE_SHEETS_URL, {
        method : 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body   : formBody
      })
      .then(r => r.json())
      .then(j => {
        document.getElementById("loader").style.display = "none";
        if (j.status === 'success' || j.result === 'success' || (j.result && j.result.indexOf('success') !== -1)) {
          showMessage('Order confirmed! Delivery details sent.', "success");
          alert('Order confirmed! Delivery details will be sent to you.');
          cart = [];
          transportationCost = 0;
          updateCart();
          endEl.value = '';
          phoneEl.value = '';
          etaEl.textContent = '';
          if (directionsRenderer && directionsRenderer.setDirections) directionsRenderer.setDirections({routes: []});
          clearMarkers();
        } else {
          showMessage(j.message || "Submission failed", "error");
        }
      })
      .catch(e => {
        document.getElementById("loader").style.display = "none";
        showMessage("Submission failed", "error");
        console.error(e);
      });
    };

    function loadGoogleMaps() {
      try {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyDRdnvGw7epuDJjgBnpv0-FEuSQ6J-fyNY&libraries=places&callback=initMap`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      } catch (error) { showMessage('Error loading Google Maps.'); }
    }
  </script>
</body>
  </html>
